{
  "schemaVersion": "2.2",
  "description": "AWS License manager Product Discovery",
  "parameters": {
    "ProductsFilter": {
      "type": "String",
      "description": "(Optional) Default is all.",
      "allowedPattern": "^[a-zA-Z0-9, ]+$",
      "default": "All"
    },
    "LoggingEnabled": {
      "type": "String",
      "description": "(Optional) Enable logging to temp folder",
      "default": "No",
      "allowedValues": [
        "Yes",
        "No"
      ]
    }
  },
  "mainSteps": [
    {
      "name": "runProductDiscoveryForWindows",
      "action": "aws:runPowerShellScript",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Windows"
        ]
      },
      "inputs": {
        "runCommand": [
          "# Initialize logging",
          "$script:LoggingEnabled = '{{ LoggingEnabled }}'",
          "$script:LogFile = Join-Path $env:TEMP \"ProductDiscovery_$(Get-Date -Format 'yyyyMMdd_HHmmss').log\"",
          "",
          "function Write-Log {",
          "    param(",
          "        [Parameter(Mandatory = $true)]",
          "        [string]$Message,",
          "        ",
          "        [Parameter(Mandatory = $false)]",
          "        [ValidateSet('INFO', 'WARNING', 'ERROR', 'VERBOSE')]",
          "        [string]$Level = 'INFO'",
          "    )",
          "    ",
          "    if ($script:LoggingEnabled -eq 'Yes') {",
          "        $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'",
          "        $logEntry = \"[$timestamp] [$Level] $Message\"",
          "        Add-Content -Path $script:LogFile -Value $logEntry -ErrorAction SilentlyContinue",
          "    }",
          "}",
          "",
          "function New-ProductDiscoveryResult {",
          "    param(",
          "        [string]$ProductCategory,",
          "        [string]$ProductFullName,",
          "        [string]$Edition,",
          "        [string]$Version,",
          "        [datetime]$InstallDate,",
          "        [string]$InstallPath,",
          "        [string]$ProductKey",
          "    )",
          "    ",
          "    return [PSCustomObject]@{",
          "        ProductCategory = $ProductCategory",
          "        ProductFullName = $ProductName",
          "        Edition = $Edition",
          "        Version = $Version",
          "        InstallDate = $InstallDate",
          "        InstallPath = $InstallPath",
          "        ProductKey = $ProductKey",
          "    }",
          "}",
          "",
          "function Invoke-SecureServiceAccess {",
          "    ",
          "    [CmdletBinding()]",
          "    param(",
          "        [Parameter(Mandatory = $false)]",
          "        [string]$Name = \"*\"",
          "    )",
          "    ",
          "    try {",
          "        # Ensure read-only service access",
          "        $services = Get-Service -Name $Name -ErrorAction Stop",
          "        return $services",
          "    }",
          "    catch {",
          "        $msg = \"Failed to access services: $($_.Exception.Message)\"",
          "        Write-Verbose $msg",
          "        Write-Log -Message $msg -Level 'VERBOSE'",
          "        return $null",
          "    }",
          "}",
          "",
          "function Invoke-SecureRegistryAccess {",
          "",
          "    ",
          "    [CmdletBinding()]",
          "    param(",
          "        [Parameter(Mandatory = $true)]",
          "        [string]$Path,",
          "        ",
          "        [Parameter(Mandatory = $false)]",
          "        [string]$PropertyName",
          "    )",
          "    ",
          "    try {",
          "        # Ensure we're only doing read operations",
          "        if ($PropertyName) {",
          "            $result = Get-ItemProperty -Path $Path -Name $PropertyName -ErrorAction Stop",
          "            return $result.$PropertyName",
          "        }",
          "        else {",
          "            $result = Get-ItemProperty -Path $Path -ErrorAction Stop",
          "            return $result",
          "        }",
          "    }",
          "    catch {",
          "        $msg = \"Failed to access registry path: $Path - $($_.Exception.Message)\"",
          "        Write-Verbose $msg",
          "        Write-Log -Message $msg -Level 'VERBOSE'",
          "        return $null",
          "    }",
          "}",
          "",
          "",
          "function Invoke-SecureWMIQuery {",
          "    ",
          "    [CmdletBinding()]",
          "    param(",
          "        [Parameter(Mandatory = $true)]",
          "        [string]$ClassName,",
          "        ",
          "        [Parameter(Mandatory = $false)]",
          "        [string]$Filter,",
          "        ",
          "        [Parameter(Mandatory = $false)]",
          "        [string[]]$Property",
          "    )",
          "    ",
          "    try {",
          "        $wmiParams = @{",
          "            Class = $ClassName",
          "            ErrorAction = \"Stop\"",
          "        }",
          "        ",
          "        if ($Filter) {",
          "            $wmiParams.Filter = $Filter",
          "        }",
          "        ",
          "        if ($Property) {",
          "            $wmiParams.Property = $Property",
          "        }",
          "        ",
          "        # Execute WMI query with timeout protection",
          "        $result = Get-WmiObject @wmiParams",
          "        return $result",
          "    }",
          "    catch {",
          "        $msg = \"Failed to execute WMI query for class: $ClassName - $($_.Exception.Message)\"",
          "        Write-Verbose $msg",
          "        Write-Log -Message $msg -Level 'VERBOSE'",
          "        return $null",
          "    }",
          "}",
          "",
          "function Format-DiscoveryResults {",
          "    [CmdletBinding()]",
          "    param(",
          "        [Parameter(Mandatory = $true)]",
          "        [array]$Results",
          "    )",
          "    ",
          "    try {",
          "        $jsonResults = [ordered]@{}",
          "        ",
          "        foreach ($result in $Results) {",
          "            $key = $result.ProductKey",
          "            $suffix = 1",
          "            while ($jsonResults.Contains($key)) {",
          "                $key = \"$baseKey ($suffix)\"",
          "                $suffix++",
          "            }",
          "            ",
          "            # Create comprehensive result object",
          "            $productResult = [ordered]@{",
          "                ProductCategory = $result.ProductCategory",
          "                ProductFullName = $result.ProductFullName",
          "                Edition = $result.Edition",
          "                Version = $result.Version",
          "                InstallDate = if ($result.InstallDate -and $result.InstallDate -ne [datetime]::MinValue) { ",
          "                    $result.InstallDate.ToString(\"yyyy-MM-ddTHH:mm:ss.fffZ\") ",
          "                } else { ",
          "                    $null ",
          "                }",
          "                InstallPath = $result.InstallPath",
          "                # Add metadata",
          "                DiscoveryTimestamp = (Get-Date).ToString(\"yyyy-MM-ddTHH:mm:ss.fffZ\")",
          "            }",
          "            ",
          "            $jsonResults[$key] = $productResult",
          "        }",
          "        ",
          "        # Convert to JSON with nice formatting",
          "        $jsonOutput = $jsonResults | ConvertTo-Json -Depth 4",
          "        ",
          "        return $jsonOutput",
          "    }",
          "    catch {",
          "        $msg = \"Error in Format-DiscoveryResults-Alternative: $($_.Exception.Message)\"",
          "        Write-Error $msg",
          "        Write-Log -Message $msg -Level 'ERROR'",
          "        return \"{}\"",
          "    }",
          "}",
          "",
          "function Discover-MicrosoftProducts{",
          "    [CmdletBinding()]",
          "    param(",
          "        [Parameter(Mandatory = $true)]",
          "        [string]$productsFilter",
          "    )",
          "    $discoveryResults = @()",
          "    $discoveryErrors = @()",
          "    $discoverAll = $false",
          "     try {",
          "            if ($productsFilter -eq \"All,\") {",
          "               $productsFilter = \"All,\"",
          "               $discoverAll = $true",
          "            }",
          "            else {",
          "                # Split by comma and trim whitespace",
          "                $productsToDiscover = $productsFilter.Split(',') | ForEach-Object { $_.Trim() }",
          "            }",
          "        $productNameForWindow = \"WindowsServer\"",
          "        $productNameForSQLServer = \"MicrosoftSQLServer\"",
          "",
          "        if ( $discoverAll -or ($productsToDiscover -match $productNameForWindow)) {",
          "            $windowsServerResults = Get-WindowsServerInfo",
          "            if ($windowsServerResults -and ($windowsServerResults | Measure-Object).Count -gt 0) {",
          "                if(-not $discoverAll) {",
          "                    $productNameEdition = $productsToDiscover -match $productNameForWindow",
          "                    $filteredResults = $windowsServerResults | Where-Object { $productNameEdition -Match $_.Edition }",
          "                   $discoveryResults += $filteredResults",
          "                }else {",
          "                    $discoveryResults += $windowsServerResults",
          "                }",
          "            }",
          "        }",
          "        if($discoverAll -or ($productsToDiscover -match $productNameForSQLServer))",
          "        {",
          "            $sqlServerResults = Get-SQLServerInfo",
          "            if ($sqlServerResults -and ($sqlServerResults | Measure-Object).Count -gt 0) {",
          "                if(-not $discoverAll) {",
          "                   $productNameEditionSQL = $productsToDiscover -match $productNameForSQLServer",
          "                   $filteredResults = $sqlServerResults | Where-Object { $productNameEditionSQL -Match $_.Edition }",
          "                   $discoveryResults += $filteredResults",
          "                }else {",
          "                    $discoveryResults += $sqlServerResults",
          "                }",
          "            }",
          "        }",
          "        $formattedOutPut = Format-DiscoveryResults -Results $discoveryResults",
          "        Write-Host $formattedOutPut",
          "    }",
          "     catch {",
          "",
          "     }",
          "}",
          "",
          "",
          "function Get-SQLServerInfo {",
          "    [CmdletBinding()]",
          "    param()",
          "    ",
          "    $msg = \"Starting SQL Server discovery...\"",
          "    Write-Verbose $msg",
          "    Write-Log -Message $msg -Level 'VERBOSE'",
          "    $sqlResults = @()",
          "    ",
          "    try {",
          "        if ($sqlResults.Count -eq 0) {",
          "            $msg = \"Attempting registry-only SQL Server discovery...\"",
          "            Write-Verbose $msg",
          "            Write-Log -Message $msg -Level 'VERBOSE'",
          "            ",
          "            $installedInstances = Invoke-SecureRegistryAccess -Path \"HKLM:\\SOFTWARE\\Microsoft\\Microsoft SQL Server\" -PropertyName \"InstalledInstances\"",
          "            ",
          "            if ($installedInstances) {",
          "                $msg = \"Found installed instances in registry: $($installedInstances -join ', ')\"",
          "                Write-Verbose $msg",
          "                Write-Log -Message $msg -Level 'VERBOSE'",
          "                ",
          "                foreach ($instance in $installedInstances) {",
          "                    $msg = \"Processing registry-discovered instance: $instance\"",
          "                    Write-Verbose $msg",
          "                    Write-Log -Message $msg -Level 'VERBOSE'",
          "                    ",
          "                    # Try to find version-specific registry information",
          "                    $versionPatterns = @(\"16\", \"15\", \"14\", \"13\", \"12\", \"11\", \"10\")",
          "                    $foundInstance = $false",
          "                    ",
          "                    foreach ($versionPattern in $versionPatterns) {",
          "                        $instancePath = \"HKLM:\\SOFTWARE\\Microsoft\\Microsoft SQL Server\\MSSQL$versionPattern.$instance\"",
          "                        $setupInfo = Invoke-SecureRegistryAccess -Path \"$instancePath\\Setup\"",
          "                        ",
          "                        if ($setupInfo) {",
          "                            $foundInstance = $true",
          "                            ",
          "                            $version = if ($setupInfo.Version) { $setupInfo.Version } else { \"Unknown\" }",
          "                            $edition = if ($setupInfo.Edition) { $setupInfo.Edition } else { \"Unknown\" }",
          "                            $installPath = if ($setupInfo.SQLPath) { $setupInfo.SQLPath } else { \"Unknown\" }",
          "                            ",
          "                            $installDate = [datetime]::MinValue",
          "                            if ($setupInfo.InstallDate) {",
          "                                try {",
          "                                    $installDate = [datetime]::Parse($setupInfo.InstallDate)",
          "                                }",
          "                                catch {",
          "                                    $installDate = [DateTime]::MinValue",
          "                                    $msg = \"Could not parse install date: $($setupInfo.InstallDate)\"",
          "                                    Write-Verbose $msg",
          "                                    Write-Log -Message $msg -Level 'VERBOSE'",
          "                                }",
          "                            }",
          "",
          "                            if($edition -match \"Enterprise\"){",
          "                                $edition = \"Enterprise\"",
          "                            }ElseIf($edition -match \"Standard\"){",
          "                                $edition = \"Standard\"",
          "                            }",
          "",
          "                          ",
          "                            $productName = \"Microsoft SQL Server\"",
          "                            if ($version -match \"^16\\.\") { $productName = \"Microsoft SQL Server 2022\" }",
          "                            elseif ($version -match \"^15\\.\") { $productName = \"Microsoft SQL Server 2019\" }",
          "                            elseif ($version -match \"^14\\.\") { $productName = \"Microsoft SQL Server 2017\" }",
          "                            elseif ($version -match \"^13\\.\") { $productName = \"Microsoft SQL Server 2016\" }",
          "                            elseif ($version -match \"^12\\.\") { $productName = \"Microsoft SQL Server 2014\" }",
          "                            elseif ($version -match \"^11\\.\") { $productName = \"Microsoft SQL Server 2012\" }",
          "                            ",
          "                            $sqlResult = New-ProductDiscoveryResult -ProductCategory \"Microsoft SQL Server\" -ProductFullName $productName -Edition $edition -Version $version -InstallDate $installDate -InstallPath $installPath -ProductKey \"MicrosoftSQLServer$($edition)\"",
          "                            $sqlResults += $sqlResult",
          "                            $msg = \"Successfully discovered SQL Server via registry: $instance ($productName $edition)\"",
          "                            Write-Verbose $msg",
          "                            Write-Log -Message $msg -Level 'VERBOSE'",
          "                            break",
          "                        }",
          "                    }",
          "                }",
          "            }",
          "        }",
          "        ",
          "        $msg = \"SQL Server discovery completed. Found $($sqlResults.Count) installation(s)\"",
          "        Write-Verbose $msg",
          "        Write-Log -Message $msg -Level 'VERBOSE'",
          "        return $sqlResults",
          "    }",
          "    catch {",
          "        $errorMsg = \"SQL Server discovery failed: $($_.Exception.Message)\"",
          "        Write-Verbose $errorMsg",
          "        Write-Log -Message $errorMsg -Level 'ERROR'",
          "        return @()",
          "    }",
          "        ",
          " }",
          "",
          "function Get-WindowsServerInfo {",
          "    [CmdletBinding()]",
          "    param()",
          "    ",
          "    $results = @()",
          "    ",
          "    try {",
          "        $computerInfo = $null",
          "        # Check if this is a Windows Server system",
          "        $isWindowsServer = $false",
          "        $productName = \"\"",
          "        $edition = \"\"",
          "        $version = \"\"",
          "        $installDate = $null",
          "",
          "        ",
          "        # Method 2: Registry-based detection (fallback or validation)",
          "        if (-not $isWindowsServer) {",
          "            try {",
          "                $registryPath = \"HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\"",
          "                $regInfo = Invoke-SecureRegistryAccess -Path $registryPath",
          "                ",
          "                if ($regInfo) {",
          "                    $msg = \"Retrieved registry information from $registryPath\"",
          "                    Write-Verbose $msg",
          "                    Write-Log -Message $msg -Level 'VERBOSE'",
          "                }",
          "                else {",
          "                    $msg = \"Failed to access registry path: $registryPath\"",
          "                    Write-Verbose $msg",
          "                    Write-Log -Message $msg -Level 'VERBOSE'",
          "                    throw \"Registry access denied or path not found\"",
          "                }",
          "                ",
          "                # Check product name in registry",
          "                $regProductName = $regInfo.ProductName",
          "                if ($regProductName -match \"Windows Server\") {",
          "                    $isWindowsServer = $true",
          "                    $productName = $regProductName",
          "                    ",
          "                    # Get version information",
          "                    if ($regInfo.CurrentVersion) {",
          "                        $version = $regInfo.CurrentVersion",
          "                    }",
          "",
          "                    # Determine edition from registry",
          "                    if ($regInfo.EditionID) {",
          "                        $editionId = $regInfo.EditionID",
          "                        if ($editionId -match \"Datacenter\") {",
          "                            $edition = \"Datacenter\"",
          "                        }",
          "                        elseif ($editionId -match \"Standard\") {",
          "                            $edition = \"Standard\"",
          "                        }",
          "                        else {",
          "                            $edition = $editionId",
          "                        }",
          "                    }",
          "                    elseif ($regProductName -match \"Datacenter\") {",
          "                        $edition = \"Datacenter\"",
          "                    }",
          "                    elseif ($regProductName -match \"Standard\") {",
          "                        $edition = \"Standard\"",
          "                    }",
          "                    ",
          "                    # Get installation date from registry",
          "                    if ($regInfo.InstallDate) {",
          "                        try {",
          "                            # InstallDate is stored as Unix timestamp",
          "                            $installDate = [DateTime]::new(1970, 1, 1).AddSeconds($regInfo.InstallDate)",
          "                        }",
          "                        catch {",
          "                            $installDate = [DateTime]::MinValue",
          "                            $msg = \"Failed to parse InstallDate from registry: $($_.Exception.Message)\"",
          "                            Write-Verbose $msg",
          "                            Write-Log -Message $msg -Level 'VERBOSE'",
          "                        }",
          "                    }",
          "                }",
          "            }",
          "            catch {",
          "                $msg = \"Failed to access Windows version registry: $($_.Exception.Message)\"",
          "                Write-Warning $msg",
          "                Write-Log -Message $msg -Level 'WARNING'",
          "            }",
          "        }",
          "        ",
          "        # Method 3: Additional registry checks for edition information",
          "        if ($isWindowsServer -and ($edition -eq \"Unknown\" -or [string]::IsNullOrEmpty($edition))) {",
          "            try {",
          "                # Check for Server edition in different registry locations",
          "                $serverRegPaths = @(",
          "                    \"HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Server\",",
          "                    \"HKLM:\\SYSTEM\\CurrentControlSet\\Control\\ProductOptions\"",
          "                )",
          "                ",
          "                foreach ($path in $serverRegPaths) {",
          "                    if (Test-Path $path) {",
          "                        $serverInfo = Invoke-SecureRegistryAccess -Path $path",
          "                        if ($serverInfo -and $serverInfo.ProductSuite -match \"Datacenter\") {",
          "                            $edition = \"Datacenter\"",
          "                            break",
          "                        }",
          "                        elseif ($serverInfo -and $serverInfo.ProductSuite -match \"Standard\") {",
          "                            $edition = \"Standard\"",
          "                            break",
          "                        }",
          "                    }",
          "                }",
          "            }",
          "            catch {",
          "                $msg = \"Additional registry checks failed: $($_.Exception.Message)\"",
          "                Write-Verbose $msg",
          "                Write-Log -Message $msg -Level 'VERBOSE'",
          "            }",
          "        }",
          "        ",
          "        # Create result object if Windows Server was detected",
          "        if ($isWindowsServer) {",
          "            $msg = \"Windows Server detected: $productName ($edition)\"",
          "            Write-Verbose $msg",
          "            Write-Log -Message $msg -Level 'VERBOSE'",
          "            ",
          "            $result = New-ProductDiscoveryResult -ProductCategory \"Windows Server\" -ProductFullName $productName -Edition $edition -Version $version -InstallDate $installDate -InstallPath \"C:\\Windows\" -ProductKey \"WindowsServer$($edition)\"",
          "            $results += $result",
          "            ",
          "        }",
          "        else {",
          "            $msg = \"No Windows Server installation detected on this system\"",
          "            Write-Verbose $msg",
          "            Write-Log -Message $msg -Level 'VERBOSE'",
          "        }",
          "    }",
          "    catch {",
          "        $msg = \"An error occurred during Windows Server discovery , error message: $($_.Exception.Message)\"",
          "        Write-Verbose $msg",
          "        Write-Log -Message $msg -Level 'ERROR'",
          "    }",
          "    ",
          "    return $results",
          "}",
          "",
          "$filter = '{{ ProductsFilter }}'",
          "Write-Log -Message \"Starting product discovery with filter: $filter, LoggingEnabled: $script:LoggingEnabled\" -Level 'INFO'",
          "Discover-MicrosoftProducts \"$($filter),\"",
          "Write-Log -Message \"Product discovery completed\" -Level 'INFO' "
        ]
      }
    },
    {
      "name": "runProductDiscoveryForLinux",
      "action": "aws:runShellScript",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Linux"
        ]
      },
      "inputs": {
        "runCommand": [
          "#!/bin/bash",
          "",
          "# Linux Product Discovery Script - Compressed Version",
          "set -euo pipefail",
          "",
          "PRODUCT_FILTER=\"All\"",
          "declare -a DISCOVERY_RESULTS=()",
          "DISTRIBUTION_NAME=\"\"",
          "DISTRIBUTION_VERSION=\"\"",
          "DISTRIBUTION_FAMILY=\"\"",
          "SYSTEM_ARCHITECTURE=\"\"",
          "KERNEL_VERSION=\"\"",
          "",
          "# Initialize logging",
          "LOGGING_ENABLED='{{ LoggingEnabled }}'",
          "LOG_FILE=\"/tmp/ProductDiscovery_$(date +%Y%m%d_%H%M%S).log\"",
          "",
          "# Logging functions",
          "log_message() {",
          "    local level=\"$1\"",
          "    local message=\"$2\"",
          "    if [[ \"$LOGGING_ENABLED\" == \"Yes\" ]]; then",
          "        local timestamp=$(date '+%Y-%m-%d %H:%M:%S')",
          "        echo \"[$timestamp] [$level] $message\" >> \"$LOG_FILE\" 2>/dev/null || true",
          "    fi",
          "}",
          "",
          "log_debug() { ",
          "    log_message \"DEBUG\" \"$1\"",
          "}",
          "",
          "log_info() { ",
          "    log_message \"INFO\" \"$1\"",
          "}",
          "",
          "log_error() { ",
          "    echo \"ERROR: $1\" >&2",
          "    log_message \"ERROR\" \"$1\"",
          "}",
          "",
          "log_verbose() {",
          "    log_message \"VERBOSE\" \"$1\"",
          "}",
          "",
          "is_distribution_family() {",
          "    [[ \"${DISTRIBUTION_FAMILY,,}\" == \"${1,,}\" ]]",
          "}",
          "",
          "format_json_output() {",
          "    local json_output=\"\"",
          "    for i in \"${!DISCOVERY_RESULTS[@]}\"; do",
          "        [[ $i -gt 0 ]] && json_output+=\",\"",
          "        json_output+=\"${DISCOVERY_RESULTS[$i]}\"",
          "    done",
          "    echo \"{$json_output}\"",
          "}",
          "",
          "initialize() {",
          "    log_info \"Initializing product discovery\"",
          "    detect_distribution",
          "    DISCOVERY_RESULTS=()",
          "    log_verbose \"Initialization complete\"",
          "}",
          "",
          "detect_distribution() {",
          "    log_verbose \"Detecting distribution information\"",
          "    SYSTEM_ARCHITECTURE=\"$(uname -m 2>/dev/null || echo \"unknown\")\"",
          "    KERNEL_VERSION=\"$(uname -r 2>/dev/null || echo \"unknown\")\"",
          "    ",
          "    if [[ -f \"/etc/os-release\" ]]; then",
          "        source /etc/os-release 2>/dev/null || true",
          "        DISTRIBUTION_NAME=\"${NAME:-unknown}\"",
          "        DISTRIBUTION_VERSION=\"${VERSION_ID:-${VERSION:-unknown}}\"",
          "        ",
          "        case \"${ID:-}\" in",
          "            rhel|centos|rocky|almalinux|fedora) DISTRIBUTION_FAMILY=\"RedHat\" ;;",
          "            ubuntu|debian) DISTRIBUTION_FAMILY=\"Debian\" ;;",
          "            sles|opensuse*|suse) DISTRIBUTION_FAMILY=\"SUSE\" ;;",
          "            *) DISTRIBUTION_FAMILY=\"Other\" ;;",
          "        esac",
          "    else",
          "        DISTRIBUTION_NAME=\"$(uname -s 2>/dev/null || echo \"Linux\")\"",
          "        DISTRIBUTION_VERSION=\"$(uname -r 2>/dev/null || echo \"unknown\")\"",
          "        DISTRIBUTION_FAMILY=\"Other\"",
          "    fi",
          "    ",
          "    DISTRIBUTION_NAME=\"${DISTRIBUTION_NAME:-unknown}\"",
          "    DISTRIBUTION_VERSION=\"${DISTRIBUTION_VERSION:-unknown}\"",
          "    DISTRIBUTION_FAMILY=\"${DISTRIBUTION_FAMILY:-Other}\"",
          "    ",
          "    log_verbose \"Detected: $DISTRIBUTION_NAME $DISTRIBUTION_VERSION (Family: $DISTRIBUTION_FAMILY, Arch: $SYSTEM_ARCHITECTURE)\"",
          "}",
          "",
          "discover_sqlserver() {",
          "    log_verbose \"Starting SQL Server discovery\"",
          "    local log_dir=\"/var/opt/mssql/log\"",
          "    if [[ ! -d \"$log_dir\" ]]; then",
          "        log_verbose \"SQL Server log directory not found: $log_dir\"",
          "        return 0",
          "    fi",
          "    ",
          "    local latest_errorlog=$(find \"$log_dir\" -name \"errorlog*\" -type f -exec ls -t {} + 2>/dev/null | head -1)",
          "    if [[ -z \"$latest_errorlog\" ]]; then",
          "        log_verbose \"No SQL Server error log found\"",
          "        return 0",
          "    fi",
          "    ",
          "    local version=$(grep -oE \"Microsoft SQL Server [0-9]{4}\" \"$latest_errorlog\" | head -1 | grep -oE '[0-9]{4}')",
          "    if [[ -z \"$version\" ]]; then",
          "        log_verbose \"Could not determine SQL Server version from log\"",
          "        return 0",
          "    fi",
          "    ",
          "    local edition=\"Unknown Edition\"",
          "    if grep -qi \"Enterprise Edition\" \"$latest_errorlog\"; then",
          "        edition=\"Enterprise\"",
          "    elif grep -qi \"Standard Edition\" \"$latest_errorlog\"; then",
          "        edition=\"Standard\"",
          "    elif grep -qi \"Developer Edition\" \"$latest_errorlog\"; then",
          "        edition=\"Developer\"",
          "    elif grep -qi \"Express Edition\" \"$latest_errorlog\"; then",
          "        edition=\"Express\"",
          "    fi",
          "    ",
          "    log_verbose \"Discovered SQL Server $version $edition\"",
          "    should_discover_product \"sqlserver edition\" && \\",
          "        add_discovery_result \"Microsoft SQL Server\" \"Microsoft SQL Server $version\" \"$version\" \"$edition\" \"\" \"UnKnown\" \"{}\" \"MicrosoftSQLServer$edition\"",
          "}",
          "",
          "discover_rhel() {",
          "    if ! is_distribution_family \"RedHat\"; then",
          "        log_verbose \"Not a RedHat family distribution, skipping RHEL discovery\"",
          "        return 0",
          "    fi",
          "    ",
          "    log_verbose \"Starting RHEL discovery\"",
          "    local product_name=\"Red Hat Enterprise Linux\"",
          "    local rhel_version=\"$DISTRIBUTION_VERSION\"",
          "    ",
          "    # Check for specific RHEL variants",
          "    if [[ -f \"/etc/redhat-release\" ]]; then",
          "        local content=\"$(cat /etc/redhat-release 2>/dev/null)\"",
          "        if [[ \"$content\" =~ Red\\ Hat\\ Enterprise\\ Linux.*release\\ ([0-9]+)\\.([0-9]+) ]]; then",
          "            rhel_version=\"${BASH_REMATCH[1]}.${BASH_REMATCH[2]}\"",
          "        fi",
          "    fi",
          "    ",
          "    # Adjust product name for RHEL-compatible systems",
          "    case \"$DISTRIBUTION_NAME\" in",
          "        *CentOS*) product_name=\"CentOS (RHEL-compatible)\" ;;",
          "        *Rocky*) product_name=\"Rocky Linux (RHEL-compatible)\" ;;",
          "        *AlmaLinux*) product_name=\"AlmaLinux (RHEL-compatible)\" ;;",
          "        *Oracle*) product_name=\"Oracle Linux (RHEL-compatible)\" ;;",
          "    esac",
          "    ",
          "    log_verbose \"Discovered RHEL: $product_name $rhel_version\"",
          "    add_discovery_result \"RHEL\" \"$product_name\" \"$rhel_version\" \"\" \"/etc/redhat-release\" \"\" \"{}\" \"RedHatEnterpriseLinux\"",
          "}",
          "",
          "discover_suse() {",
          "    if ! is_distribution_family \"SUSE\"; then",
          "        log_verbose \"Not a SUSE family distribution, skipping SUSE discovery\"",
          "        return 0",
          "    fi",
          "    ",
          "    log_verbose \"Starting SUSE discovery\"",
          "    local suse_version=\"$DISTRIBUTION_VERSION\"",
          "    local suse_edition=\"Enterprise\"",
          "    local subscription_status=\"Unknown\"",
          "    local product_name=\"SUSE Linux Enterprise\"",
          "    ",
          "    # Determine SUSE edition from distribution name",
          "    case \"$DISTRIBUTION_NAME\" in",
          "        *\"Enterprise Server\"*) suse_edition=\"Server\"; product_name=\"SUSE Linux Enterprise Server\" ;;",
          "        *\"Enterprise Desktop\"*) suse_edition=\"Desktop\"; product_name=\"SUSE Linux Enterprise Desktop\" ;;",
          "        *\"openSUSE Leap\"*) suse_edition=\"openSUSE Leap\"; product_name=\"openSUSE Leap\" ;;",
          "        *\"openSUSE Tumbleweed\"*) suse_edition=\"openSUSE Tumbleweed\"; product_name=\"openSUSE Tumbleweed\" ;;",
          "        *\"openSUSE\"*) suse_edition=\"openSUSE\"; product_name=\"openSUSE\" ;;",
          "    esac",
          "    ",
          "    # Check subscription status if SUSEConnect is available",
          "    if command -v SUSEConnect >/dev/null 2>&1; then",
          "        log_verbose \"Checking SUSE subscription status\"",
          "        local output=\"$(SUSEConnect --status 2>/dev/null || echo \"[]\")\"",
          "        if [[ \"$output\" != \"[]\" ]] && [[ -n \"$output\" ]]; then",
          "            subscription_status=\"Active\"",
          "        else",
          "            subscription_status=\"Not Registered\"",
          "        fi",
          "    else",
          "        log_verbose \"SUSEConnect command not available\"",
          "    fi",
          "    ",
          "    log_verbose \"Discovered SUSE: $product_name $suse_version ($suse_edition), Subscription: $subscription_status\"",
          "    local additional_info=\"{\\\"subscription_status\\\":\\\"$subscription_status\\\",\\\"architecture\\\":\\\"$SYSTEM_ARCHITECTURE\\\",\\\"kernel_version\\\":\\\"$KERNEL_VERSION\\\"}\"",
          "    ",
          "    add_discovery_result \"SUSE\" \"$product_name\" \"$suse_version\" \"$suse_edition\" \"/etc/os-release\" \"$subscription_status\" \"$additional_info\" \"SUSE\"",
          "}",
          "",
          "discover_ubuntu_pro() {",
          "    if ! is_distribution_family \"Debian\"; then",
          "        log_verbose \"Not a Debian family distribution, skipping Ubuntu Pro discovery\"",
          "        return 0",
          "    fi",
          "    if [[ ! \"$DISTRIBUTION_NAME\" =~ Ubuntu ]]; then",
          "        log_verbose \"Not Ubuntu, skipping Ubuntu Pro discovery\"",
          "        return 0",
          "    fi",
          "    ",
          "    log_verbose \"Starting Ubuntu Pro discovery\"",
          "    local ubuntu_version=\"$DISTRIBUTION_VERSION\"",
          "    local product_name=\"Ubuntu\"",
          "    local service_status=\"Standard\"",
          "    local pro_status=\"Not Available\"",
          "    local subscription_expiry=\"Unknown\"",
          "    ",
          "    # Check Ubuntu Pro status if 'pro' command is available",
          "    if command -v pro >/dev/null 2>&1; then",
          "        log_verbose \"Checking Ubuntu Pro status\"",
          "        local pro_output=\"$(pro status 2>/dev/null || echo \"\")\"",
          "        if [[ \"$pro_output\" =~ attached\\ to\\ an\\ Ubuntu\\ Pro ]]; then",
          "            pro_status=\"Active\"",
          "            service_status=\"Ubuntu Pro Active\"",
          "            product_name=\"Ubuntu Pro\"",
          "        elif [[ \"$pro_output\" =~ not\\ attached\\ to\\ an\\ Ubuntu\\ Pro ]]; then",
          "            pro_status=\"Not Attached\"",
          "            service_status=\"Ubuntu Pro Available\"",
          "        fi",
          "        ",
          "        # Try to get expiry info from JSON output",
          "        local json_output=\"$(pro status --format json 2>/dev/null || echo \"{}\")\"",
          "        if command -v jq >/dev/null 2>&1; then",
          "            subscription_expiry=\"$(echo \"$json_output\" | jq -r '.expires // \"Unknown\"' 2>/dev/null || echo \"Unknown\")\"",
          "        fi",
          "    else",
          "        log_verbose \"Ubuntu Pro command not available\"",
          "    fi",
          "    ",
          "    log_verbose \"Discovered Ubuntu: $product_name $ubuntu_version, Pro Status: $pro_status\"",
          "    local additional_info=\"{\\\"pro_subscription\\\":\\\"$pro_status\\\",\\\"subscription_expiry\\\":\\\"$subscription_expiry\\\",\\\"architecture\\\":\\\"$SYSTEM_ARCHITECTURE\\\",\\\"kernel_version\\\":\\\"$KERNEL_VERSION\\\"}\"",
          "    ",
          "    add_discovery_result \"UbuntuPro\" \"$product_name\" \"$ubuntu_version\" \"$service_status\" \"/etc/os-release\" \"$pro_status\" \"$additional_info\" \"UbuntuPro\"",
          "}",
          "",
          "add_discovery_result() {",
          "    local product_category=\"$1\"",
          "    local product_name=\"$2\"",
          "    local version=\"$3\"",
          "    local edition=\"${4:-}\"",
          "    local install_path=\"${5:-}\"",
          "    local service_status=\"${6:-}\"",
          "    local additional_info=\"${7:-{}\"",
          "    local product_key=\"$8\"",
          "    ",
          "    local hostname",
          "    hostname=\"$(hostname)\"",
          "    local scan_date",
          "    scan_date=\"$(date -Iseconds)\"",
          "    ",
          "    # Use detected distribution information",
          "    local distribution=\"$DISTRIBUTION_NAME $DISTRIBUTION_VERSION\"",
          "    ",
          "    # Create JSON object for the result",
          "    local result",
          "    result=$(cat << EOF",
          "\"$product_key\":{",
          "  \"ProductCategory\": \"$product_category\",",
          "  \"ProductFullName\": \"$product_name\",",
          "  \"Version\": \"$version\",",
          "  \"Edition\": \"$edition\",",
          "  \"InstallPath\": \"$install_path\",",
          "  \"ServiceStatus\": \"$service_status\",",
          "  \"AdditionalInfo\": $additional_info",
          "}",
          "EOF",
          "    )",
          "    ",
          "    DISCOVERY_RESULTS+=(\"$result\")",
          "    log_verbose \"Added discovery result for $product_category: $product_name\"",
          "}",
          "",
          "should_discover_product() {",
          "    [[ \"$PRODUCT_FILTER\" == \"All\" ]] && return 0",
          "    ",
          "    case \"$1\" in",
          "        \"SQLServer\"|\"sqlserver edition\") [[ \"$PRODUCT_FILTER\" == *\"SQL Server\"* || \"$PRODUCT_FILTER\" == *\"Standard\"* || \"$PRODUCT_FILTER\" == *\"Enterprise\"* ]] ;;",
          "        \"RHEL\") [[ \"$PRODUCT_FILTER\" == *\"Red Hat\"* ]] ;;",
          "        \"ubuntupro\") [[ \"$PRODUCT_FILTER\" == *\"ubuntu\"* ]] ;;",
          "        \"SUSE\") [[ \"$PRODUCT_FILTER\" == *\"SUSE\"* || \"$PRODUCT_FILTER\" == *\"openSUSE\"* ]] ;;",
          "        *) return 1 ;;",
          "    esac",
          "}",
          "",
          "main() {",
          "    PRODUCT_FILTER=\"$1\"",
          "    log_info \"Starting product discovery with filter: $PRODUCT_FILTER, LoggingEnabled: $LOGGING_ENABLED\"",
          "    initialize",
          "    ",
          "    should_discover_product \"SQLServer\" && discover_sqlserver",
          "    should_discover_product \"RHEL\" && discover_rhel",
          "    should_discover_product \"UbuntuPro\" && discover_ubuntu_pro",
          "    should_discover_product \"SUSE\" && discover_suse",
          "    ",
          "    log_info \"Product discovery completed. Found ${#DISCOVERY_RESULTS[@]} product(s)\"",
          "    format_json_output",
          "}",
          "",
          "# Execute main function if script is run directly",
          "[[ \"${BASH_SOURCE[0]}\" == \"${0}\" ]] && main '{{ ProductsFilter }}'"
        ]
      }
    }
  ]
}
