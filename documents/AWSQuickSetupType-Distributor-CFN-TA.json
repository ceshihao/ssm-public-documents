{
  "schemaVersion": "1.0",
  "templateBody": {
    "Parameters": {
      "QSType": {
        "Type": "String",
        "AllowedValues": [
          "TA",
          "MA",
          "LA"
        ],
        "Description": "(Required) Specifies whether the Quick Setup applies to the local account or an AWS organization."
      },
      "QSConfigurationId": {
        "Type": "String",
        "Description": "(Required) Unique identifier of the deployed configuration."
      },
      "QSAttachConfigurationPolicy": {
        "Type": "String",
        "Default": "false",
        "AllowedValues": [
          "true",
          "false"
        ],
        "Description": "(Optional) Whether to attach Configuration permissions policy which sets boundaries of what configuration can do."
      },
      "PackagesToInstall": {
        "Type": "CommaDelimitedList",
        "Description": "(Required) List of packages to be installed",
        "AllowedValues": [
          "AWSEFSTools",
          "AWSCWAgent",
          "AWSEC2LaunchAgent",
          "novalue"
        ]
      },
      "RemediationSchedule": {
        "Type": "String",
        "Default": "rate(30 days)",
        "AllowedValues": [
          "rate(30 days)",
          "rate(14 days)",
          "rate(2 days)",
          "none"
        ],
        "Description": "(Optional) The interval at which the configuration's drift remediation runs."
      },
      "TargetType": {
        "Type": "String",
        "Default": "*",
        "AllowedValues": [
          "Tags",
          "InstanceIds",
          "*",
          "ResourceGroups"
        ],
        "Description": "(Optional) Specifies the way instances are targeted. This parameter is only used for the local Quick Setup type."
      },
      "TargetInstances": {
        "Type": "String",
        "Default": "*",
        "Description": "(Optional) Specifies the target instances. This parameter is only used for the local Quick Setup type when InstanceIds are the TargetType."
      },
      "TargetTagKey": {
        "Type": "String",
        "Default": "",
        "Description": "(Optional) Specifies the tag key used to target instances. This parameter is only used for the local Quick Setup type when Tags are the TargetType."
      },
      "TargetTagValue": {
        "Type": "String",
        "Default": "",
        "Description": "(Optional) Specifies the tag value used to target instances. This parameter is only used for the local Quick Setup type when Tags are the TargetType."
      },
      "ResourceGroupName": {
        "Type": "String",
        "Default": "",
        "Description": "(Optional) Specifies the tag value for the resource group used to target instances. This parameter is only used for the local Quick Setup type when ResourceGroups are the TargetType."
      },
      "IsPolicyAttachAllowed": {
        "Type": "String",
        "Default": "false",
        "AllowedValues": [
          "true",
          "false"
        ],
        "Description": "(Optional) Whether you want to allow Quick Setup to attach IAM policies to existing instance profiles."
      }
    },
    "Conditions": {
      "ShouldAttachConfigurationPolicy": {
        "Fn::Equals": [
          {
            "Ref": "QSAttachConfigurationPolicy"
          },
          "true"
        ]
      },
      "ShouldInstallEFSUtilsCondition": {
        "Fn::Or": [
          {
            "Fn::Equals": [
              "AWSEFSTools",
              {
                "Fn::Select": [
                  0,
                  {
                    "Ref": "PackagesToInstall"
                  }
                ]
              }
            ]
          },
          {
            "Fn::Equals": [
              "AWSEFSTools",
              {
                "Fn::Select": [
                  1,
                  {
                    "Ref": "PackagesToInstall"
                  }
                ]
              }
            ]
          },
          {
            "Fn::Equals": [
              "AWSEFSTools",
              {
                "Fn::Select": [
                  2,
                  {
                    "Ref": "PackagesToInstall"
                  }
                ]
              }
            ]
          }
        ]
      },
      "ShouldInstallCWAgentCondition": {
        "Fn::Or": [
          {
            "Fn::Equals": [
              "AWSCWAgent",
              {
                "Fn::Select": [
                  0,
                  {
                    "Ref": "PackagesToInstall"
                  }
                ]
              }
            ]
          },
          {
            "Fn::Equals": [
              "AWSCWAgent",
              {
                "Fn::Select": [
                  1,
                  {
                    "Ref": "PackagesToInstall"
                  }
                ]
              }
            ]
          },
          {
            "Fn::Equals": [
              "AWSCWAgent",
              {
                "Fn::Select": [
                  2,
                  {
                    "Ref": "PackagesToInstall"
                  }
                ]
              }
            ]
          }
        ]
      },
      "ShouldInstallEC2LaunchAgentCondition": {
        "Fn::Or": [
          {
            "Fn::Equals": [
              "AWSEC2LaunchAgent",
              {
                "Fn::Select": [
                  0,
                  {
                    "Ref": "PackagesToInstall"
                  }
                ]
              }
            ]
          },
          {
            "Fn::Equals": [
              "AWSEC2LaunchAgent",
              {
                "Fn::Select": [
                  1,
                  {
                    "Ref": "PackagesToInstall"
                  }
                ]
              }
            ]
          },
          {
            "Fn::Equals": [
              "AWSEC2LaunchAgent",
              {
                "Fn::Select": [
                  2,
                  {
                    "Ref": "PackagesToInstall"
                  }
                ]
              }
            ]
          }
        ]
      },
      "ShouldUpdatePackagesCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "RemediationSchedule"
              },
              "none"
            ]
          }
        ]
      },
      "ShouldUpdateCWAgentCondition": {
        "Fn::And": [
          {
            "Condition": "ShouldInstallCWAgentCondition"
          },
          {
            "Condition": "ShouldUpdatePackagesCondition"
          }
        ]
      },
      "IsTagOnlyTargetedCondition": {
        "Fn::And": [
          {
            "Fn::Equals": [
              {
                "Ref": "QSType"
              },
              "LA"
            ]
          },
          {
            "Fn::Equals": [
              {
                "Ref": "TargetType"
              },
              "Tags"
            ]
          },
          {
            "Fn::Equals": [
              {
                "Ref": "TargetTagValue"
              },
              ""
            ]
          }
        ]
      },
      "IsTagKeyAndValueTargetedCondition": {
        "Fn::And": [
          {
            "Fn::Equals": [
              {
                "Ref": "QSType"
              },
              "LA"
            ]
          },
          {
            "Fn::Equals": [
              {
                "Ref": "TargetType"
              },
              "Tags"
            ]
          },
          {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "TargetTagValue"
                  },
                  ""
                ]
              }
            ]
          }
        ]
      },
      "IsResourceGroupTargetedCondition": {
        "Fn::And": [
          {
            "Fn::Equals": [
              {
                "Ref": "QSType"
              },
              "LA"
            ]
          },
          {
            "Fn::Equals": [
              {
                "Ref": "TargetType"
              },
              "ResourceGroups"
            ]
          }
        ]
      },
      "IsOrgQuickSetup": {
        "Fn::Equals": [
          {
            "Ref": "QSType"
          },
          "TA"
        ]
      },
      "TargetAll": {
        "Fn::Equals": [
          {
            "Ref": "TargetInstances"
          },
          "*"
        ]
      }
    },
    "Resources": {
      "RoleForDistributor": {
        "Type": "AWS::IAM::Role",
        "Properties": {
          "AssumeRolePolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": [
                    "ssm.amazonaws.com"
                  ]
                },
                "Action": [
                  "sts:AssumeRole"
                ]
              }
            ]
          },
          "Policies": [
            {
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "iam:ListRoles",
                      "config:DescribeConfigurationRecorders",
                      "compute-optimizer:GetEnrollmentStatus",
                      "support:DescribeTrustedAdvisorChecks"
                    ],
                    "Resource": "*"
                  },
                  {
                    "Effect": "Allow",
                    "Action": [
                      "ssm:UpdateServiceSetting",
                      "ssm:GetServiceSetting"
                    ],
                    "Resource": [
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":ssm:*:*:servicesetting/ssm/opsitem/ssm-patchmanager"
                          ]
                        ]
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":ssm:*:*:servicesetting/ssm/opsitem/EC2"
                          ]
                        ]
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":ssm:*:*:servicesetting/ssm/opsdata/ExplorerOnboarded"
                          ]
                        ]
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":ssm:*:*:servicesetting/ssm/opsdata/Association"
                          ]
                        ]
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":ssm:*:*:servicesetting/ssm/opsdata/ComputeOptimizer"
                          ]
                        ]
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":ssm:*:*:servicesetting/ssm/opsdata/ConfigCompliance"
                          ]
                        ]
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":ssm:*:*:servicesetting/ssm/opsdata/OpsData-TrustedAdvisor"
                          ]
                        ]
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":ssm:*:*:servicesetting/ssm/opsdata/SupportCenterCase"
                          ]
                        ]
                      }
                    ]
                  },
                  {
                    "Effect": "Allow",
                    "Action": [
                      "iam:CreateServiceLinkedRole"
                    ],
                    "Resource": {
                      "Fn::Join": [
                        "",
                        [
                          "arn:",
                          {
                            "Ref": "AWS::Partition"
                          },
                          ":iam::*:role/aws-service-role/ssm.",
                          {
                            "Ref": "AWS::URLSuffix"
                          },
                          "/AWSServiceRoleForAmazonSSM"
                        ]
                      ]
                    },
                    "Condition": {
                      "StringEquals": {
                        "iam:AWSServiceName": "ssm.amazonaws.com"
                      }
                    }
                  }
                ]
              },
              "PolicyName": "SSMQuickSetupEnableExplorerInlinePolicy"
            },
            {
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "ssm:GetAutomationExecution",
                      "ec2:DescribeIamInstanceProfileAssociations",
                      "ec2:AssociateIamInstanceProfile",
                      "ec2:DisassociateIamInstanceProfile",
                      "ec2:DescribeInstances",
                      "ssm:StartAutomationExecution",
                      "iam:GetInstanceProfile",
                      "iam:AddRoleToInstanceProfile",
                      "iam:AttachRolePolicy",
                      "iam:ListInstanceProfilesForRole"
                    ],
                    "Resource": "*"
                  },
                  {
                    "Effect": "Allow",
                    "Action": [
                      "ssm:UpdateServiceSetting",
                      "ssm:GetServiceSetting"
                    ],
                    "Resource": [
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":ssm:*:*:servicesetting/ssm/opsitem/EC2"
                          ]
                        ]
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":ssm:*:*:servicesetting/ssm/opsdata/ExplorerOnboarded"
                          ]
                        ]
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":ssm:*:*:servicesetting/ssm/opsdata/Association"
                          ]
                        ]
                      }
                    ]
                  },
                  {
                    "Effect": "Allow",
                    "Action": [
                      "iam:CreateInstanceProfile",
                      "iam:GetInstanceProfile",
                      "iam:AddRoleToInstanceProfile"
                    ],
                    "Resource": [
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":iam::*:instance-profile/AmazonSSMRoleForInstancesQuickSetup"
                          ]
                        ]
                      }
                    ]
                  },
                  {
                    "Effect": "Allow",
                    "Action": [
                      "iam:PassRole",
                      "iam:GetRole"
                    ],
                    "Resource": [
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":iam::*:role/AmazonSSMRoleForInstancesQuickSetup"
                          ]
                        ]
                      },
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":iam::*:role/AWS-QuickSetup-RoleForDistributor-",
                            {
                              "Ref": "AWS::Region"
                            },
                            "-",
                            {
                              "Ref": "QSType"
                            }
                          ]
                        ]
                      }
                    ]
                  },
                  {
                    "Effect": "Allow",
                    "Action": [
                      "iam:ListInstanceProfilesForRole",
                      "iam:CreateRole",
                      "iam:AttachRolePolicy"
                    ],
                    "Resource": [
                      {
                        "Fn::Join": [
                          "",
                          [
                            "arn:",
                            {
                              "Ref": "AWS::Partition"
                            },
                            ":iam::*:role/AmazonSSMRoleForInstancesQuickSetup"
                          ]
                        ]
                      }
                    ]
                  }
                ]
              },
              "PolicyName": {
                "Fn::Join": [
                  "",
                  [
                    "AWS-QuickSetup-CreateAndAttachRoleInlinePolicy-",
                    {
                      "Ref": "AWS::Region"
                    },
                    "-",
                    {
                      "Ref": "QSConfigurationId"
                    }
                  ]
                ]
              }
            }
          ],
          "PermissionsBoundary": {
            "Fn::If": [
              "ShouldAttachConfigurationPolicy",
              {
                "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/AWSQuickSetupDistributorPermissionsBoundary"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          "RoleName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-RoleForDistributor-",
                {
                  "Ref": "AWS::Region"
                },
                "-",
                {
                  "Ref": "QSType"
                }
              ]
            ]
          }
        }
      },
      "CreateAndAttachIAMToInstanceForDistributor": {
        "Type": "AWS::SSM::Document",
        "Properties": {
          "Content": {
            "description": "Composite document for Quick Setup Managing Instances association. This document ensures IAM role for instance profile is created in account with all required policies",
            "schemaVersion": "0.3",
            "assumeRole": "{{AutomationAssumeRole}}",
            "parameters": {
              "AutomationAssumeRole": {
                "type": "String"
              },
              "InstanceId": {
                "type": "String"
              },
              "IsPolicyAttachAllowed": {
                "type": "String"
              },
              "ShouldInstallEFSUtilsCondition": {
                "type": "Boolean",
                "default": false
              }
            },
            "mainSteps": [
              {
                "name": "getExistingRoleName",
                "action": "aws:executeScript",
                "maxAttempts": 3,
                "inputs": {
                  "Runtime": "python3.8",
                  "Handler": "getInstanceProfileName",
                  "InputPayload": {
                    "InstanceId": "{{InstanceId}}"
                  },
                  "Script": "import boto3\n\ndef getInstanceProfileName(events, context):\n    ec2_client = boto3.client(\"ec2\")\n    response = ec2_client.describe_instances(InstanceIds=[events[\"InstanceId\"]])\n    if 'IamInstanceProfile' in response['Reservations'][0]['Instances'][0]:\n        return {'RoleName': response['Reservations'][0]['Instances'][0]['IamInstanceProfile']['Arn'].split('/').pop()}\n    return {'RoleName': 'NoRoleFound'}"
                },
                "outputs": [
                  {
                    "Name": "existingInstanceProfileRoleName",
                    "Selector": "$.Payload.RoleName",
                    "Type": "String"
                  }
                ],
                "nextStep": "branchIfProfileExists"
              },
              {
                "name": "branchIfProfileExists",
                "action": "aws:branch",
                "inputs": {
                  "Choices": [
                    {
                      "NextStep": "createRoleIfNotExists",
                      "Variable": "{{getExistingRoleName.existingInstanceProfileRoleName}}",
                      "StringEquals": "NoRoleFound"
                    },
                    {
                      "NextStep": "createRoleIfNotExists",
                      "Variable": "{{getExistingRoleName.existingInstanceProfileRoleName}}",
                      "StringEquals": "AmazonSSMRoleForInstancesQuickSetup"
                    }
                  ],
                  "Default": "checkIfPolicyAttachAllowed"
                }
              },
              {
                "name": "checkIfPolicyAttachAllowed",
                "action": "aws:branch",
                "inputs": {
                  "Choices": [
                    {
                      "NextStep": "getRoleFromInstanceProfile",
                      "Variable": "{{IsPolicyAttachAllowed}}",
                      "StringEquals": "true"
                    }
                  ],
                  "Default": "createRoleIfNotExists"
                }
              },
              {
                "name": "getRoleFromInstanceProfile",
                "action": "aws:executeAwsApi",
                "inputs": {
                  "Service": "iam",
                  "Api": "GetInstanceProfile",
                  "InstanceProfileName": "{{getExistingRoleName.existingInstanceProfileRoleName}}"
                },
                "outputs": [
                  {
                    "Name": "existingRoleName",
                    "Selector": "$.InstanceProfile.Roles[0].RoleName",
                    "Type": "String"
                  }
                ],
                "nextStep": "checkIfShouldInstallEFSUtilsToExistingRole"
              },
              {
                "name": "checkIfShouldInstallEFSUtilsToExistingRole",
                "action": "aws:branch",
                "inputs": {
                  "Choices": [
                    {
                      "NextStep": "attachAmazonElasticFileSystemsUtilsToExistingRole",
                      "Variable": "{{ShouldInstallEFSUtilsCondition}}",
                      "BooleanEquals": true
                    }
                  ],
                  "Default": "attachAmazonSSMManagedInstanceCoreToExistingRole"
                }
              },
              {
                "name": "attachAmazonElasticFileSystemsUtilsToExistingRole",
                "action": "aws:executeAwsApi",
                "inputs": {
                  "Service": "iam",
                  "Api": "AttachRolePolicy",
                  "RoleName": "{{getRoleFromInstanceProfile.existingRoleName}}",
                  "PolicyArn": {
                    "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/AmazonElasticFileSystemsUtils"
                  }
                },
                "nextStep": "attachAmazonSSMManagedInstanceCoreToExistingRole"
              },
              {
                "name": "attachAmazonSSMManagedInstanceCoreToExistingRole",
                "action": "aws:executeAwsApi",
                "inputs": {
                  "Service": "iam",
                  "Api": "AttachRolePolicy",
                  "RoleName": "{{getRoleFromInstanceProfile.existingRoleName}}",
                  "PolicyArn": {
                    "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/AmazonSSMManagedInstanceCore"
                  }
                },
                "isEnd": true
              },
              {
                "name": "createRoleIfNotExists",
                "action": "aws:executeAwsApi",
                "inputs": {
                  "Service": "iam",
                  "Api": "CreateRole",
                  "Path": "/",
                  "RoleName": "AmazonSSMRoleForInstancesQuickSetup",
                  "AssumeRolePolicyDocument": "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"ec2.amazonaws.com\"},\"Action\":\"sts:AssumeRole\"}]}",
                  "Description": "EC2 role for SSM for Quick-Setup"
                },
                "description": "Create AmazonSSMRoleForInstancesQuickSetup Role For SSM Quick Setup",
                "onFailure": "Continue",
                "nextStep": "assertRoleForInstanceProfileExists"
              },
              {
                "name": "assertRoleForInstanceProfileExists",
                "action": "aws:assertAwsResourceProperty",
                "inputs": {
                  "Service": "iam",
                  "Api": "GetRole",
                  "PropertySelector": "$.Role.RoleName",
                  "DesiredValues": [
                    "AmazonSSMRoleForInstancesQuickSetup"
                  ],
                  "RoleName": "AmazonSSMRoleForInstancesQuickSetup"
                },
                "nextStep": "checkIfShouldInstallEFSUtilsToRole"
              },
              {
                "name": "checkIfShouldInstallEFSUtilsToRole",
                "action": "aws:branch",
                "inputs": {
                  "Choices": [
                    {
                      "NextStep": "attachAmazonElasticFileSystemsUtilsToRole",
                      "Variable": "{{ShouldInstallEFSUtilsCondition}}",
                      "BooleanEquals": true
                    }
                  ],
                  "Default": "attachAmazonSSMManagedInstanceCoreToRole"
                }
              },
              {
                "name": "attachAmazonElasticFileSystemsUtilsToRole",
                "action": "aws:executeAwsApi",
                "inputs": {
                  "Service": "iam",
                  "Api": "AttachRolePolicy",
                  "RoleName": "AmazonSSMRoleForInstancesQuickSetup",
                  "PolicyArn": {
                    "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/AmazonElasticFileSystemsUtils"
                  }
                },
                "nextStep": "attachAmazonSSMManagedInstanceCoreToRole"
              },
              {
                "name": "attachAmazonSSMManagedInstanceCoreToRole",
                "action": "aws:executeAwsApi",
                "inputs": {
                  "Service": "iam",
                  "Api": "AttachRolePolicy",
                  "RoleName": "AmazonSSMRoleForInstancesQuickSetup",
                  "PolicyArn": {
                    "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/AmazonSSMManagedInstanceCore"
                  }
                },
                "nextStep": "createInstanceProfileIfNotExists"
              },
              {
                "name": "createInstanceProfileIfNotExists",
                "action": "aws:executeAwsApi",
                "inputs": {
                  "InstanceProfileName": "AmazonSSMRoleForInstancesQuickSetup",
                  "Service": "iam",
                  "Api": "CreateInstanceProfile"
                },
                "onFailure": "Continue",
                "nextStep": "addRoleToInstanceProfile"
              },
              {
                "name": "addRoleToInstanceProfile",
                "action": "aws:executeAwsApi",
                "inputs": {
                  "InstanceProfileName": "AmazonSSMRoleForInstancesQuickSetup",
                  "RoleName": "AmazonSSMRoleForInstancesQuickSetup",
                  "Service": "iam",
                  "Api": "AddRoleToInstanceProfile"
                },
                "onFailure": "Continue",
                "nextStep": "executeAttachIAMToInstance"
              },
              {
                "name": "executeAttachIAMToInstance",
                "action": "aws:executeAutomation",
                "maxAttempts": 10,
                "timeoutSeconds": 60,
                "inputs": {
                  "DocumentName": "AWS-AttachIAMToInstance",
                  "RuntimeParameters": {
                    "RoleName": "AmazonSSMRoleForInstancesQuickSetup",
                    "ForceReplace": false,
                    "AutomationAssumeRole": "{{ AutomationAssumeRole }}",
                    "InstanceId": "{{ InstanceId }}"
                  }
                },
                "isEnd": true
              }
            ]
          },
          "DocumentType": "Automation",
          "TargetType": "/AWS::EC2::Instance",
          "UpdateMethod": "NewVersion",
          "Name": {
            "Fn::Join": [
              "",
              [
                "AWSQuickSetup-Distributor-CreateAndAttachIAMToInstanceV2-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          }
        }
      },
      "QuickSetupInstallAndUpdateEFSUtilsAssociation": {
        "Type": "AWS::SSM::Association",
        "Properties": {
          "Name": "AWS-ConfigureAWSPackage",
          "AssociationName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-Distributor-EFS-Utils-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          },
          "AutomationTargetParameterName": {
            "Fn::If": [
              "IsOrgQuickSetup",
              "InstanceId",
              {
                "Fn::If": [
                  "IsTagKeyAndValueTargetedCondition",
                  "Tag",
                  "InstanceId"
                ]
              }
            ]
          },
          "Parameters": {
            "name": [
              "AmazonEFSUtils"
            ],
            "action": [
              "Install"
            ]
          },
          "ScheduleExpression": {
            "Fn::If": [
              "ShouldUpdatePackagesCondition",
              {
                "Ref": "RemediationSchedule"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          "Targets": {
            "Fn::If": [
              "IsOrgQuickSetup",
              [
                {
                  "Key": "InstanceIds",
                  "Values": [
                    "*"
                  ]
                }
              ],
              {
                "Fn::If": [
                  "IsTagOnlyTargetedCondition",
                  [
                    {
                      "Key": "tag-key",
                      "Values": [
                        {
                          "Ref": "TargetTagKey"
                        }
                      ]
                    }
                  ],
                  {
                    "Fn::If": [
                      "IsTagKeyAndValueTargetedCondition",
                      [
                        {
                          "Key": {
                            "Fn::Join": [
                              "",
                              [
                                "tag:",
                                {
                                  "Ref": "TargetTagKey"
                                }
                              ]
                            ]
                          },
                          "Values": [
                            {
                              "Ref": "TargetTagValue"
                            }
                          ]
                        }
                      ],
                      {
                        "Fn::If": [
                          "IsResourceGroupTargetedCondition",
                          [
                            {
                              "Key": "resource-groups:Name",
                              "Values": [
                                {
                                  "Ref": "ResourceGroupName"
                                }
                              ]
                            }
                          ],
                          {
                            "Fn::If": [
                              "TargetAll",
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": [
                                    "*"
                                  ]
                                }
                              ],
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": {
                                    "Fn::Split": [
                                      ",",
                                      {
                                        "Ref": "TargetInstances"
                                      }
                                    ]
                                  }
                                }
                              ]
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        "Condition": "ShouldInstallEFSUtilsCondition",
        "DependsOn": "QuickSetupCreateAndAttachIAMToInstanceForDistributorUtilsAssociation"
      },
      "InstallAndManageCloudWatchDocument": {
        "Type": "AWS::SSM::Document",
        "Properties": {
          "Content": {
            "schemaVersion": "2.2",
            "description": "The AWS-InstallAndManageCloudWatch command document installs the Amazon CloudWatch agent and manages the configuration of the agent for Amazon EC2 instances.",
            "mainSteps": [
              {
                "action": "aws:runDocument",
                "name": "installCWAgent",
                "inputs": {
                  "documentType": "SSMDocument",
                  "documentPath": "AWS-ConfigureAWSPackage",
                  "documentParameters": {
                    "action": "Install",
                    "name": "AmazonCloudWatchAgent"
                  }
                }
              },
              {
                "action": "aws:runDocument",
                "name": "manageCWAgent",
                "inputs": {
                  "documentType": "SSMDocument",
                  "documentPath": "AmazonCloudWatch-ManageAgent",
                  "documentParameters": {
                    "action": "configure",
                    "mode": "ec2",
                    "optionalConfigurationSource": "default",
                    "optionalRestart": "yes"
                  }
                }
              }
            ]
          },
          "UpdateMethod": "NewVersion",
          "DocumentType": "Command",
          "Name": {
            "Fn::Join": [
              "",
              [
                "AWSQuickSetup-Distributor-InstallAndManageCloudWatchDocument-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          }
        },
        "Condition": "ShouldInstallCWAgentCondition",
        "DependsOn": "QuickSetupCreateAndAttachIAMToInstanceForDistributorUtilsAssociation"
      },
      "QuickSetupInstallAndManageCWAgentAssociation": {
        "Type": "AWS::SSM::Association",
        "Properties": {
          "Name": {
            "Ref": "InstallAndManageCloudWatchDocument"
          },
          "AssociationName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-Distributor-CloudWatch-Agent-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          },
          "ScheduleExpression": {
            "Ref": "AWS::NoValue"
          },
          "Targets": {
            "Fn::If": [
              "IsOrgQuickSetup",
              [
                {
                  "Key": "InstanceIds",
                  "Values": [
                    "*"
                  ]
                }
              ],
              {
                "Fn::If": [
                  "IsTagOnlyTargetedCondition",
                  [
                    {
                      "Key": "tag-key",
                      "Values": [
                        {
                          "Ref": "TargetTagKey"
                        }
                      ]
                    }
                  ],
                  {
                    "Fn::If": [
                      "IsTagKeyAndValueTargetedCondition",
                      [
                        {
                          "Key": {
                            "Fn::Join": [
                              "",
                              [
                                "tag:",
                                {
                                  "Ref": "TargetTagKey"
                                }
                              ]
                            ]
                          },
                          "Values": [
                            {
                              "Ref": "TargetTagValue"
                            }
                          ]
                        }
                      ],
                      {
                        "Fn::If": [
                          "IsResourceGroupTargetedCondition",
                          [
                            {
                              "Key": "resource-groups:Name",
                              "Values": [
                                {
                                  "Ref": "ResourceGroupName"
                                }
                              ]
                            }
                          ],
                          {
                            "Fn::If": [
                              "TargetAll",
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": [
                                    "*"
                                  ]
                                }
                              ],
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": {
                                    "Fn::Split": [
                                      ",",
                                      {
                                        "Ref": "TargetInstances"
                                      }
                                    ]
                                  }
                                }
                              ]
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        "Condition": "ShouldInstallCWAgentCondition",
        "DependsOn": "QuickSetupCreateAndAttachIAMToInstanceForDistributorUtilsAssociation"
      },
      "UpdateCloudWatchAgentDocument": {
        "Type": "AWS::SSM::Document",
        "Properties": {
          "Content": {
            "schemaVersion": "2.2",
            "description": "A composite document for updating CloudWatch agent.",
            "mainSteps": [
              {
                "precondition": {
                  "StringEquals": [
                    "platformType",
                    "Linux"
                  ]
                },
                "action": "aws:runShellScript",
                "name": "first",
                "inputs": {
                  "runCommand": [
                    "sleep 1800"
                  ]
                }
              },
              {
                "precondition": {
                  "StringEquals": [
                    "platformType",
                    "Windows"
                  ]
                },
                "action": "aws:runPowerShellScript",
                "name": "second",
                "inputs": {
                  "runCommand": [
                    "Start-Sleep -Seconds 1800"
                  ]
                }
              },
              {
                "action": "aws:runDocument",
                "name": "installCWAgent",
                "inputs": {
                  "documentType": "SSMDocument",
                  "documentPath": "AWS-ConfigureAWSPackage",
                  "documentParameters": {
                    "action": "Install",
                    "name": "AmazonCloudWatchAgent"
                  }
                }
              }
            ]
          },
          "DocumentType": "Command",
          "UpdateMethod": "NewVersion",
          "Name": {
            "Fn::Join": [
              "",
              [
                "AWSQuickSetup-Distributor-UpdateCloudWatchDocument-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          }
        },
        "Condition": "ShouldUpdateCWAgentCondition",
        "DependsOn": "QuickSetupCreateAndAttachIAMToInstanceForDistributorUtilsAssociation"
      },
      "UpdateCloudWatchDocumentAssociation": {
        "Type": "AWS::SSM::Association",
        "Properties": {
          "Name": {
            "Ref": "UpdateCloudWatchAgentDocument"
          },
          "AssociationName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-Distributor-UpdateCloudWatchAgent-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          },
          "ScheduleExpression": {
            "Ref": "RemediationSchedule"
          },
          "Targets": {
            "Fn::If": [
              "IsOrgQuickSetup",
              [
                {
                  "Key": "InstanceIds",
                  "Values": [
                    "*"
                  ]
                }
              ],
              {
                "Fn::If": [
                  "IsTagOnlyTargetedCondition",
                  [
                    {
                      "Key": "tag-key",
                      "Values": [
                        {
                          "Ref": "TargetTagKey"
                        }
                      ]
                    }
                  ],
                  {
                    "Fn::If": [
                      "IsTagKeyAndValueTargetedCondition",
                      [
                        {
                          "Key": {
                            "Fn::Join": [
                              "",
                              [
                                "tag:",
                                {
                                  "Ref": "TargetTagKey"
                                }
                              ]
                            ]
                          },
                          "Values": [
                            {
                              "Ref": "TargetTagValue"
                            }
                          ]
                        }
                      ],
                      {
                        "Fn::If": [
                          "IsResourceGroupTargetedCondition",
                          [
                            {
                              "Key": "resource-groups:Name",
                              "Values": [
                                {
                                  "Ref": "ResourceGroupName"
                                }
                              ]
                            }
                          ],
                          {
                            "Fn::If": [
                              "TargetAll",
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": [
                                    "*"
                                  ]
                                }
                              ],
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": {
                                    "Fn::Split": [
                                      ",",
                                      {
                                        "Ref": "TargetInstances"
                                      }
                                    ]
                                  }
                                }
                              ]
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        "Condition": "ShouldUpdateCWAgentCondition",
        "DependsOn": "QuickSetupCreateAndAttachIAMToInstanceForDistributorUtilsAssociation"
      },
      "QuickSetupInstallAndUpdateEC2LaunchAgentAssociation": {
        "Type": "AWS::SSM::Association",
        "Properties": {
          "Name": "AWS-ConfigureAWSPackage",
          "AssociationName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-Distributor-EC2Launch-Agent-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          },
          "AutomationTargetParameterName": {
            "Fn::If": [
              "IsOrgQuickSetup",
              "InstanceId",
              {
                "Fn::If": [
                  "IsTagKeyAndValueTargetedCondition",
                  "Tag",
                  "InstanceId"
                ]
              }
            ]
          },
          "Parameters": {
            "name": [
              "AWSEC2Launch-Agent"
            ],
            "action": [
              "Install"
            ],
            "additionalArguments": [
              "{\"SSM_upgrade_legacy_agent\": \"false\"}"
            ]
          },
          "ScheduleExpression": {
            "Fn::If": [
              "ShouldUpdatePackagesCondition",
              {
                "Ref": "RemediationSchedule"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          "Targets": {
            "Fn::If": [
              "IsOrgQuickSetup",
              [
                {
                  "key": "InstanceIds",
                  "values": [
                    "*"
                  ]
                }
              ],
              {
                "Fn::If": [
                  "IsTagOnlyTargetedCondition",
                  [
                    {
                      "key": "tag-key",
                      "values": [
                        {
                          "Ref": "TargetTagKey"
                        }
                      ]
                    }
                  ],
                  {
                    "Fn::If": [
                      "IsTagKeyAndValueTargetedCondition",
                      [
                        {
                          "key": {
                            "Fn::Join": [
                              "",
                              [
                                "tag:",
                                {
                                  "Ref": "TargetTagKey"
                                }
                              ]
                            ]
                          },
                          "values": [
                            {
                              "Ref": "TargetTagValue"
                            }
                          ]
                        }
                      ],
                      {
                        "Fn::If": [
                          "IsResourceGroupTargetedCondition",
                          [
                            {
                              "key": "resource-groups:Name",
                              "values": [
                                {
                                  "Ref": "ResourceGroupName"
                                }
                              ]
                            }
                          ],
                          {
                            "Fn::If": [
                              "TargetAll",
                              [
                                {
                                  "Key": "InstanceIds",
                                  "values": [
                                    "*"
                                  ]
                                }
                              ],
                              [
                                {
                                  "key": "InstanceIds",
                                  "values": {
                                    "Fn::Split": [
                                      ",",
                                      {
                                        "Ref": "TargetInstances"
                                      }
                                    ]
                                  }
                                }
                              ]
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        "Condition": "ShouldInstallEC2LaunchAgentCondition",
        "DependsOn": "QuickSetupCreateAndAttachIAMToInstanceForDistributorUtilsAssociation"
      },
      "QuickSetupCreateAndAttachIAMToInstanceForDistributorUtilsAssociation": {
        "Type": "AWS::SSM::Association",
        "Properties": {
          "Name": {
            "Ref": "CreateAndAttachIAMToInstanceForDistributor"
          },
          "AssociationName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-AttachIAMToInstanceForEFSUtils-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          },
          "AutomationTargetParameterName": "InstanceId",
          "Parameters": {
            "AutomationAssumeRole": [
              {
                "Fn::GetAtt": [
                  "RoleForDistributor",
                  "Arn"
                ]
              }
            ],
            "IsPolicyAttachAllowed": [
              {
                "Ref": "IsPolicyAttachAllowed"
              }
            ],
            "ShouldInstallEFSUtilsCondition": [
              {
                "Fn::If": [
                  "ShouldInstallEFSUtilsCondition",
                  true,
                  false
                ]
              }
            ]
          },
          "ScheduleExpression": "rate(1 day)",
          "Targets": {
            "Fn::If": [
              "IsOrgQuickSetup",
              [
                {
                  "Key": "InstanceIds",
                  "Values": [
                    "*"
                  ]
                }
              ],
              {
                "Fn::If": [
                  "IsTagOnlyTargetedCondition",
                  [
                    {
                      "Key": "tag-key",
                      "Values": [
                        {
                          "Ref": "TargetTagKey"
                        }
                      ]
                    }
                  ],
                  {
                    "Fn::If": [
                      "IsTagKeyAndValueTargetedCondition",
                      [
                        {
                          "Key": {
                            "Fn::Join": [
                              "",
                              [
                                "tag:",
                                {
                                  "Ref": "TargetTagKey"
                                }
                              ]
                            ]
                          },
                          "Values": [
                            {
                              "Ref": "TargetTagValue"
                            }
                          ]
                        }
                      ],
                      {
                        "Fn::If": [
                          "IsResourceGroupTargetedCondition",
                          [
                            {
                              "Key": "ResourceGroup",
                              "Values": [
                                {
                                  "Ref": "ResourceGroupName"
                                }
                              ]
                            }
                          ],
                          {
                            "Fn::If": [
                              "TargetAll",
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": [
                                    "*"
                                  ]
                                }
                              ],
                              [
                                {
                                  "Key": "ParameterValues",
                                  "Values": {
                                    "Fn::Split": [
                                      ",",
                                      {
                                        "Ref": "TargetInstances"
                                      }
                                    ]
                                  }
                                }
                              ]
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        }
      },
      "QuickSetupEnableExplorerAssociation": {
        "Type": "AWS::SSM::Association",
        "Properties": {
          "Name": "AWS-EnableExplorer",
          "AssociationName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-Distributor-EnableExplorer-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          },
          "Parameters": {
            "AutomationAssumeRole": [
              {
                "Fn::GetAtt": [
                  "RoleForDistributor",
                  "Arn"
                ]
              }
            ]
          }
        }
      }
    }
  }
}
