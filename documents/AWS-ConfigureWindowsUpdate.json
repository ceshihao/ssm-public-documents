{
  "description": "Enable or disable automatic Windows Updates.",
  "parameters": {
    "scheduledInstallDay": {
      "allowedValues": [
        "Daily",
        "Sunday",
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "Saturday"
      ],
      "default": "Sunday",
      "description": "(Optional) The day of the week when you want Windows to download and install updates. Applies only if Install Updates Automatically is selected. Default is Sunday.",
      "type": "String"
    },
    "scheduledInstallTime": {
      "allowedValues": [
        "00:00",
        "01:00",
        "02:00",
        "03:00",
        "04:00",
        "05:00",
        "06:00",
        "07:00",
        "08:00",
        "09:00",
        "10:00",
        "11:00",
        "12:00",
        "13:00",
        "14:00",
        "15:00",
        "16:00",
        "17:00",
        "18:00",
        "19:00",
        "20:00",
        "21:00",
        "22:00",
        "23:00"
      ],
      "default": "03:00",
      "description": "(Optional) The time of day when you want Windows to download and install updates. Applies only if Install Updates Automatically is selected. Default is 03:00.",
      "type": "String"
    },
    "updateLevel": {
      "allowedValues": [
        "InstallUpdatesAutomatically",
        "NeverCheckForUpdates"
      ],
      "description": "(Required) Install Updates Automatically: Windows automatically downloads and installs updates. If an update requires a reboot, the computer is automatically rebooted 15 minutes after updates have been installed. Never Check For Updates: Windows never checks for or downloads updates.",
      "type": "String"
    }
  },
  "runtimeConfig": {
    "aws:runPowerShellScript": {
      "properties": [
        {
          "id": "0.aws:runPowerShellScript",
          "runCommand": [
            "# Check the OS version",
            "if ([Environment]::OSVersion.Version.Major -le 5) {",
            "    Write-Error 'This command is not supported on Windows 2003 or lower.'",
            "    exit -1",
            "} elseif ([Environment]::OSVersion.Version -ge \"10.0\") {",
            "    $sku = (Get-CimInstance -ClassName Win32_OperatingSystem).OperatingSystemSKU",
            "    if ($sku -eq 143 -or $sku -eq 144) {",
            "        Write-Host \\\"This command is not supported on Windows 2016 Nano Server.\\\"",
            "        exit -1",
            "    }",
            "}",
            "$configureWindowsUpdateFileVersion = 'Amazon.ConfigureWindowsUpdate-1.6.zip'",
            "$configureWindowsUpdateFileHash = '86FA5BE8791AB45CD7B7DCEDFE0833F527C1AAAFB1FD924C58DDAA58EB635A58'",
            "$psModuleHashes = @{     'Amazon.ConfigureWindowsUpdate.dll' = '06FF7488D11D6E0EEC9A5B27A8920FB2371C870ACA318BF82DD88B68CFA3D48F';",
            "    'Amazon.ConfigureWindowsUpdate.dll-help.xml' = '168E6C2364D642996218E867FDE3FBE7EB3914E9F686A1292893E57FCBD74C69';",
            " }",
            "$tempLocation = [Environment]::GetEnvironmentVariable('Temp') + '\\\\' + $configureWindowsUpdateFileVersion",
            "$powerShellModuleLocation = [Environment]::GetEnvironmentVariable('Windir') + '\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\Modules'",
            "",
            "# Regional domain information. Not currently used by windows payload, but added here for completeness.",
            "# Use the \"$env:\" syntax because it only needs to be active for this process",
            "$Env:AWS_SSM_PATCHMANAGER_API_DOMAIN=\"amazonaws.com\"",
            "$Env:AWS_SSM_PATCHMANAGER_API_DOMAIN_DUALSTACK=\"api.aws\"",
            "",
            "function MakeWebClient {",
            "\tparam(",
            "\t \t [boolean] $addUserAgentHeader",
            "\t)",
            "",
            "\t# Add Tls 1.2 support.",
            "\t[Net.ServicePointManager]::SecurityProtocol = [Net.ServicePointManager]::SecurityProtocol -bOr [Net.SecurityProtocolType]::Tls12",
            "\t$webClient = New-Object Net.WebClient",
            "",
            "\tif ($addUserAgentHeader) {",
            "\t \t # Get environment variables with fallback to \"<missing>\"",
            "\t \t $instanceId = if ($env:AWS_SSM_INSTANCE_ID) { $env:AWS_SSM_INSTANCE_ID } else { \"<missing>\" }",
            "\t \t $ssmCommandId = if ($env:SSM_COMMAND_ID) { $env:SSM_COMMAND_ID } else { \"<missing>\" }",
            "",
            "\t \t # Get PowerShell version",
            "\t \t $downloadAgent = \"PowerShell/$($PSVersionTable.PSVersion.ToString())\"",
            "",
            "\t \t # Create user agent header in same format as Python version",
            "\t \t $userAgent = \"RPB(instance_id=$instanceId; ssm_command_id=$ssmCommandId; download_agent=$downloadAgent)\"",
            "\t \t $webClient.Headers.Add(\"User-Agent\", $userAgent)",
            "\t}",
            "",
            "\treturn $webClient",
            "}",
            "",
            "function DownloadToFile {",
            "\tparam(",
            "\t \t [String] $appName,",
            "\t \t [String] $s3Location,",
            "\t \t [String] $downloadPath",
            "\t)",
            "\t$webClientWithUserAgent = MakeWebClient -addUserAgentHeader $true",
            "\ttry {",
            "\t \t $webClientWithUserAgent.DownloadFile($s3Location, $downloadPath)",
            "\t} catch {",
            "\t \t Write-Output (\"Call with custom user agent failed. Retry downloading {0} PowerShell module from {1} to {2} without setting user agent`r`n\" -f $appName, $s3Location, $downloadPath)",
            "\t \t $webClient = MakeWebClient -addUserAgentHeader $false",
            "\t \t $webClient.DownloadFile($s3Location, $downloadPath)",
            "\t}",
            "}",
            "",
            "function ExtractZipCoreOs ([string]$zipFilePath, [string]$destPath) {",
            "    try",
            "    {",
            "        [System.Reflection.Assembly]::LoadWithPartialName(\"System.IO.Compression.FileSystem\") | Out-Null",
            "        $zip = [System.IO.Compression.ZipFile]::OpenRead($zipFilePath)",
            "        foreach ($item in $zip.Entries) {",
            "            $extractedPath = Join-Path $destPath $item.FullName",
            "            if ($item.Length -eq 0) {",
            "                if ((Test-Path $extractedPath) -eq 0) {",
            "                    mkdir $extractedPath | Out-Null",
            "                }",
            "            } else {",
            "                $fileParent = Split-Path $extractedPath",
            "                if ((Test-Path $fileParent) -eq 0) {",
            "                    mkdir $fileParent | Out-Null",
            "                }",
            "                [System.IO.Compression.ZipFileExtensions]::ExtractToFile($item, $extractedPath, $true)",
            "            }",
            "        }",
            "    }",
            "    catch",
            "    {",
            "        throw \"Error encountered when extracting ConfigureWindowsUpdate zip file.`n$($_.Exception.Message)\"",
            "    }",
            "    finally",
            "    {",
            "        $zip.Dispose()",
            "    }",
            "}",
            "",
            "function GetUseDualStackSetting {",
            "\tif ($env:AWS_SSM_USE_DUALSTACK_ENDPOINT) {",
            "\t\t$value = $env:AWS_SSM_USE_DUALSTACK_ENDPOINT",
            "\t\tWrite-Host (\"Found use_dual_stack configuration in environment variables (AWS_SSM_USE_DUALSTACK_ENDPOINT={0})\" -f $value)",
            "        # powershell -eq is not case sensitive",
            "\t\tif ($value -eq \"true\") {",
            "\t\t\treturn $true",
            "\t\t} else {",
            "\t\t\treturn $false",
            "\t\t}",
            "\t}",
            "\tWrite-Host (\"Could not find a use_dual_stack configuration anywhere\")",
            "\treturn $false",
            "}",
            "",
            "try {",
            "    $useDualStack = GetUseDualStackSetting",
            "    Write-Host (\"use_dual_stack = {0}\" -f $useDualStack)",
            "    if ($useDualStack -and 's3.dualstack.us-east-1.amazonaws.com/aws-ssm-us-east-1') {",
            "        $s3Location = 'https://s3.dualstack.us-east-1.amazonaws.com/aws-ssm-us-east-1/' + 'patchbaselineoperations/configurewindowsupdate/' + $configureWindowsUpdateFileVersion",
            "    } else {",
            "        $s3Location = 'https://s3.amazonaws.com/aws-ssm-us-east-1/' + 'patchbaselineoperations/configurewindowsupdate/' + $configureWindowsUpdateFileVersion",
            "    }",
            "",
            "    Write-Host 'Downloading ConfigureWindowsUpdate PowerShell module from S3' $region $s3Location",
            "    ",
            "    # Use enhanced download with user agent",
            "    DownloadToFile \"ConfigureWindowsUpdate\" $s3Location $tempLocation",
            "    Write-Host 'Verifying SHA 256 of the ConfigureWindowsUpdate PowerShell module zip file.'",
            "    $fileStream = New-Object System.IO.FileStream($tempLocation, [System.IO.FileMode]::Open, [System.IO.FileAccess]::Read)",
            "    $sha256 = [System.Security.Cryptography.HashAlgorithm]::Create('System.Security.Cryptography.SHA256CryptoServiceProvider')",
            "    $sourceHash = [System.BitConverter]::ToString($sha256.ComputeHash($fileStream), 0).Replace('-', '').ToLower()",
            "    $sha256.Dispose()",
            "    $fileStream.Dispose()",
            "    if ($sourceHash -ne $configureWindowsUpdateFileHash) {",
            "        Write-Error -Message 'The SHA of the PowerShell module does not pass match the expected value.' -Category InvalidResult",
            "        rm $tempLocation",
            "        exit 1",
            "    }",
            "    Write-Host 'Extracting ConfigureWindowsUpdate zip file contents to the Windows PowerShell module folder.'",
            "    try {",
            "        (New-Object -Com Shell.Application).namespace($powerShellModuleLocation).CopyHere((New-Object -Com Shell.Application).namespace($tempLocation).Items(), 16)",
            "    } catch [Exception] {",
            "        ExtractZipCoreOs $tempLocation $powerShellModuleLocation",
            "    }",
            "    rm $tempLocation",
            "    Write-Host 'Successfully downloaded and installed PowerShell module for the AWS-ConfigureWindowsUpdate document.'",
            "} catch [Exception] {",
            "    $exceptionMessage = 'Exception thrown while downloading ConfigureWindowsUpdate PowerShell module with message: {0}' -f $_.Exception.Message",
            "    Write-Error $exceptionMessage",
            "    if (Test-Path $tempLocation) {",
            "        rm $tempLocation",
            "    }",
            "    exit 1",
            "}",
            "try {",
            "    $datetime = [DateTime]::MinValue",
            "    if ([DateTime]::TryParse('{{ scheduledInstallTime }}', [ref]$datetime)) {",
            "        Set-WindowsUpdate -UpdateLevel {{ updateLevel }} -ScheduledInstallDay {{ scheduledInstallDay }} -ScheduledInstallTime $datetime.Hour",
            "    } else {",
            "        Write-Error -Message 'Invalid value for the 'scheduledInstallTime' parameter.' -Category InvalidArgument",
            "        exit 1",
            "    }",
            "} catch [Exception] {",
            "    $exceptionMessage = 'Exception thrown while setting Windows update message: {0}' -f $_.Exception.Message",
            "    Write-Error $exceptionMessage",
            "    exit 1",
            "}"
          ]
        }
      ]
    }
  },
  "schemaVersion": "1.2"
}
