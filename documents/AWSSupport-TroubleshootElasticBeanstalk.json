{
  "schemaVersion": "0.3",
  "description": "The **AWSSupport-TroubleshootElasticBeanstalk** runbook helps you troubleshoot the potential reasons why your AWS Elastic Beanstalk environment is in a ```Degraded``` or ```Severe``` state. This automation checks the following AWS resources associated with your Elastic Beanstalk environment:\n\n- Configuration details for a load balancer, AWS CloudFormation stack, Amazon EC2 Auto Scaling group, Amazon Elastic Compute Cloud (Amazon EC2) instances, and virtual private cloud (VPC).\n- Network configuration issues with the associated security group rules, route tables, and network access control lists (ACLs) associated with your subnets.\n- Verifies connectivity to the Elastic Beanstalk endpoints and public internet access.\n- Verifies the status of the load balancer.\n- Verifies the status of the Amazon EC2 instances.\n- Retrieves a log bundle from your Elastic Beanstalk environment, and optionally uploads the files to AWS Support.",
  "assumeRole": "{{ AutomationAssumeRole }}",
  "parameters": {
    "AutomationAssumeRole": {
      "type": "AWS::IAM::Role::Arn",
      "description": "(Optional) The Amazon Resource Name (ARN) of the AWS Identity and Access Management (IAM) role that allows Systems Manager Automation to perform the actions on your behalf. If no role is specified, Systems Manager Automation uses the permissions of the user that starts this runbook.",
      "maxChars": 2048,
      "default": ""
    },
    "ApplicationName": {
      "type": "String",
      "description": "(Required) The name of your Elastic Beanstalk application.",
      "allowedPattern": "^[A-Za-z0-9\\_\\'\\.\\,\\+\\-\\[\\]\\(\\)]{1,100}$"
    },
    "EnvironmentName": {
      "type": "String",
      "description": "(Required) The name of your Elastic Beanstalk environment.",
      "allowedPattern": "^[a-zA-Z0-9]{1}[a-zA-Z0-9\\-]{2,38}[a-zA-Z0-9]{1}$"
    },
    "AWSS3UploaderLink": {
      "default": "",
      "type": "String",
      "description": "(Optional) A URL provided to you by AWS Support to upload the log bundle from your Elastic Beanstalk environment to the AWS Support S3 Uploader. This option is only available to customers who have purchased an AWS Support plan, and have opened a Support case. Please make sure you are not sending any sensitive data, including access credentials and data bound by special requirements or regulations.",
      "allowedPattern": "^$|https://d1mg6achc83nsz.cloudfront.net/[a-z0-9]{1,64}/us-east-1"
    }
  },
  "mainSteps": [
    {
      "name": "IAMPermissionsCheck",
      "onFailure": "Abort",
      "onCancel": "Abort",
      "action": "aws:executeScript",
      "isCritical": true,
      "description": "Verifies the AWS Identity and Access Management (IAM) principal who started the automation has the requisite permissions to perform all of the actions defined in the runbook.",
      "timeoutSeconds": 60,
      "inputs": {
        "Runtime": "python3.8",
        "Handler": "modules/iam_permission_handler.iam_permission_handler",
        "Attachment": "attachment.zip"
      },
      "outputs": [
        {
          "Name": "out",
          "Selector": "$.Payload.FinalResult",
          "Type": "String"
        }
      ],
      "nextStep": "ProceedOnlyIfUserHasPermission"
    },
    {
      "name": "ProceedOnlyIfUserHasPermission",
      "action": "aws:branch",
      "onFailure": "Abort",
      "description": "Branches the workflow based on the results of the previous step.",
      "inputs": {
        "Choices": [
          {
            "Variable": "{{ IAMPermissionsCheck.out }}",
            "StringEquals": "OK",
            "NextStep": "GetEnvironmentDetails"
          }
        ],
        "Default": "Finish"
      }
    },
    {
      "name": "GetEnvironmentDetails",
      "description": "Collects information about the Elastic Beanstalk environment including the load balancer, AWS CloudFormation stack, Auto Scaling group, Amazon EC2 instances, and VPC configuration.",
      "action": "aws:executeScript",
      "onFailure": "Abort",
      "onCancel": "Abort",
      "isCritical": true,
      "timeoutSeconds": 180,
      "maxAttempts": 1,
      "inputs": {
        "Runtime": "python3.8",
        "Handler": "get_environment_details.script_handler",
        "Attachment": "attachment.zip",
        "InputPayload": {
          "EnvironmentName": "{{ EnvironmentName }}",
          "ApplicationName": "{{ ApplicationName }}"
        }
      },
      "outputs": [
        {
          "Name": "EnvironmentType",
          "Selector": "$.Payload.EnvironmentType",
          "Type": "String"
        },
        {
          "Name": "EC2Subnet",
          "Selector": "$.Payload.EC2Subnet",
          "Type": "StringList"
        },
        {
          "Name": "LBSubnets",
          "Selector": "$.Payload.LBSubnets",
          "Type": "StringList"
        },
        {
          "Name": "EC2Security",
          "Selector": "$.Payload.EC2Security",
          "Type": "StringList"
        },
        {
          "Name": "ELBSecurity",
          "Selector": "$.Payload.ELBSecurity",
          "Type": "StringList"
        },
        {
          "Name": "VPC",
          "Selector": "$.Payload.VPC",
          "Type": "String"
        },
        {
          "Name": "LoadBalancer",
          "Selector": "$.Payload.LoadBalancer",
          "Type": "String"
        },
        {
          "Name": "LoadBalancerType",
          "Selector": "$.Payload.LoadBalancerType",
          "Type": "String"
        },
        {
          "Name": "CloudFormation",
          "Selector": "$.Payload.CloudFormation",
          "Type": "String"
        },
        {
          "Name": "EC2Instances",
          "Selector": "$.Payload.EC2Instances",
          "Type": "StringList"
        },
        {
          "Name": "EnvironmentName",
          "Selector": "$.Payload.EnvironmentName",
          "Type": "String"
        },
        {
          "Name": "ApplicationName",
          "Selector": "$.Payload.ApplicationName",
          "Type": "String"
        }
      ]
    },
    {
      "name": "CheckVPCSubnets",
      "description": "Checks for network connectivity issues with the route tables and ACLs associated with the subnets in your VPC.",
      "action": "aws:executeScript",
      "onFailure": "Continue",
      "onCancel": "Abort",
      "timeoutSeconds": 180,
      "maxAttempts": 1,
      "inputs": {
        "Runtime": "python3.8",
        "Handler": "modules/check_vpcsubnets.script_handler",
        "Attachment": "attachment.zip",
        "InputPayload": {
          "EnvironmentType": "{{ GetEnvironmentDetails.EnvironmentType }}",
          "VPC": "{{ GetEnvironmentDetails.VPC }}",
          "LBSubnets": "{{ GetEnvironmentDetails.LBSubnets }}",
          "EC2Subnet": "{{ GetEnvironmentDetails.EC2Subnet }}"
        }
      },
      "outputs": [
        {
          "Name": "out",
          "Selector": "$.Payload.FinalResult",
          "Type": "String"
        }
      ]
    },
    {
      "name": "CheckSecurityGroups",
      "description": "Checks for network connectivity issues with the security group rules associated with your Amazon EC2 instances.",
      "action": "aws:executeScript",
      "onFailure": "Continue",
      "onCancel": "Abort",
      "timeoutSeconds": 180,
      "maxAttempts": 1,
      "inputs": {
        "Runtime": "python3.8",
        "Handler": "modules/check_securitygroups.script_handler",
        "Attachment": "attachment.zip",
        "InputPayload": {
          "EnvironmentType": "{{ GetEnvironmentDetails.EnvironmentType }}",
          "EC2Security": "{{ GetEnvironmentDetails.EC2Security }}",
          "ELBSecurity": "{{ GetEnvironmentDetails.ELBSecurity }}"
        }
      },
      "outputs": [
        {
          "Name": "out",
          "Selector": "$.Payload.FinalResult",
          "Type": "String"
        }
      ]
    },
    {
      "name": "CheckEc2Health",
      "description": "Verifies the status checks for the Amazon EC2 instances.",
      "action": "aws:executeScript",
      "onFailure": "Continue",
      "onCancel": "Abort",
      "timeoutSeconds": 180,
      "maxAttempts": 1,
      "inputs": {
        "Runtime": "python3.8",
        "Handler": "modules/check_ec2_health.script_handler",
        "Attachment": "attachment.zip",
        "InputPayload": {
          "EnvironmentName": "{{ GetEnvironmentDetails.EnvironmentName }}",
          "ApplicationName": "{{ GetEnvironmentDetails.ApplicationName }}",
          "EnvironmentType": "{{ GetEnvironmentDetails.EnvironmentType }}",
          "LoadBalancer": "{{ GetEnvironmentDetails.LoadBalancer }}",
          "LoadBalancerType": "{{ GetEnvironmentDetails.LoadBalancerType }}"
        }
      },
      "outputs": [
        {
          "Name": "out",
          "Selector": "$.Payload.FinalResult",
          "Type": "String"
        }
      ]
    },
    {
      "name": "CollectLogsLink",
      "description": "Generates a link for a log bundle of your Elastic Beanstalk environment.",
      "action": "aws:executeScript",
      "onFailure": "Continue",
      "onCancel": "Abort",
      "timeoutSeconds": 180,
      "maxAttempts": 1,
      "inputs": {
        "Runtime": "python3.8",
        "Handler": "modules/generate_log_link.script_handler",
        "Attachment": "attachment.zip",
        "InputPayload": {
          "EnvironmentName": "{{ GetEnvironmentDetails.EnvironmentName }}",
          "ApplicationName": "{{ GetEnvironmentDetails.ApplicationName }}"
        }
      },
      "outputs": [
        {
          "Name": "out",
          "Selector": "$.Payload.FinalResult",
          "Type": "String"
        }
      ]
    },
    {
      "name": "UploadLogs",
      "description": "Uploads log bundle to AWS Support.",
      "action": "aws:executeScript",
      "onFailure": "Continue",
      "onCancel": "Abort",
      "timeoutSeconds": 180,
      "maxAttempts": 2,
      "inputs": {
        "Runtime": "python3.8",
        "Handler": "modules/collect_bundle_logs.script_handler",
        "Attachment": "attachment.zip",
        "InputPayload": {
          "EnvironmentName": "{{ GetEnvironmentDetails.EnvironmentName }}",
          "S3Uploader": "{{ AWSS3UploaderLink }}",
          "EC2Instances": "{{ GetEnvironmentDetails.EC2Instances }}"
        }
      },
      "outputs": [
        {
          "Name": "out",
          "Selector": "$.Payload.FinalResult",
          "Type": "String"
        }
      ]
    },
    {
      "name": "Finish",
      "description": "Outputs a report of action items to help you troubleshoot issues that might be affecting the status of your Elastic Beanstalk environment.",
      "action": "aws:executeScript",
      "onFailure": "Continue",
      "onCancel": "Abort",
      "isCritical": true,
      "timeoutSeconds": 180,
      "maxAttempts": 2,
      "inputs": {
        "Runtime": "python3.8",
        "Handler": "modules/finish_execution.script_handler",
        "Attachment": "attachment.zip",
        "InputPayload": {
          "IAMPermissionsCheck": "{{ IAMPermissionsCheck.out }}",
          "CheckVPCSubnets": "{{ CheckVPCSubnets.out }}",
          "CheckSecurityGroups": "{{ CheckSecurityGroups.out }}",
          "CheckEc2Health": "{{ CheckEc2Health.out }}",
          "CollectLogsLink": "{{ CollectLogsLink.out }}",
          "UploadLogs": "{{ UploadLogs.out }}"
        }
      },
      "outputs": [
        {
          "Name": "out",
          "Selector": "$.Payload",
          "Type": "String"
        }
      ],
      "isEnd": true
    }
  ],
  "outputs": [
    "Finish.out"
  ],
  "files": {
    "attachment.zip": {
      "checksums": {
        "sha256": "955022319333ea7506ff2c7e72c0e40bcf341265ff2e513fae1da3b59728e0e4"
      }
    }
  }
}
