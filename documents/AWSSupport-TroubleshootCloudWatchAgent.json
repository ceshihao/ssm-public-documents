{
  "description": "The **AWSSupport-TroubleshootCloudWatchAgent** runbook automates troubleshooting the Amazon CloudWatch agent on your Amazon Elastic Compute Cloud (EC2) instances. The runbook performs this troubleshooting through a series of basic, and (optional) extended checks.\n\nThe basic checks include the following:\n\n\t1. Check for an AWS Identity and Access Management (IAM) instance profile\n\t2. Verify if the necessary CloudWatch Agent IAM permissions are attached to the EC2 instance\n\nThe extended checks are only performed if the EC2 instance ID provided is an AWS Systems Manager (SSM) managed instance. These extended checks include the following:\n\n\t1. Check the status of the CloudWatch Agent on the instance\n\t2. Analyze the logs of the CloudWatch Agent for common issues and relevant troubleshooting steps\n\t3. Zip the relevant logs and configuration files on the EC2 instance and optionally upload them to an Amazon Simple Storage Service (S3) bucket of your choosing\n\t4. Perform a connectivity check between the instance and the required endpoints\n\nWhen the 'RunVpcReachabilityAnalyzer' parameter is set to 'true', this runbook will determine if there is a need to call the child runbook, **AWSSupport-AnalyzeAWSEndpointReachabilityFromEC2**. It does this if one of two criteria are satisfied:\n\n\t1. The instance is not an SSM managed instance\n\t2. The instance is an SSM manged instance, and one of the connectivity checks between the instance and the required endpoints resulted in a 'failed' message output.\nIf either of these situations occur, this child runbook can help diagnose DNS configuration issues, VPC endpoint issues, or reachability between the instance and the IGW/NAT.\n\n### Workflow Specifications\nFor information on the IAM permissions and input parameters required to run this Automation, please refer to the documentation [here](https://docs.aws.amazon.com/systems-manager-automation-runbooks/latest/userguide/automation-awssupport-troubleshoot-cloudwatch-agent.html).\n\n### Important\nThe child runbook, **AWSSupport-AnalyzeAWSEndpointReachabilityFromEC2** does not directly perform any connectivity checks to the required endpoints. Instead, it uses 'Reachability Analyzer' which has an associated cost. For more information on pricing, refer to the documentation [here](https://aws.amazon.com/vpc/pricing/).\nIf you have a complex Amazon Virtual Private Cloud (VPC) routing setup that includes peering connections or resources such as transit gateways, this may not provide an accurate assessment of the reachability to the AWS endpoints. For more information on this child runbook, please refer to the documentation [here](https://docs.aws.amazon.com/systems-manager-automation-runbooks/latest/userguide/automation-awssupport-analyzeawsendpointreachabilityfromec2.html).\n\nThis runbook only checks your IAM instance profile role for the necessary permissions. If you instead rely on credentials defined in a [.aws/credentials file](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-Agent-common-scenarios.html#CloudWatch-Agent-run-as-user), the results of the 'verifyIamPermissions' step may be inaccurate.",
  "schemaVersion": "0.3",
  "assumeRole": "{{ AutomationAssumeRole }}",
  "parameters": {
    "AutomationAssumeRole": {
      "type": "AWS::IAM::Role::Arn",
      "description": "(Optional) The Amazon Resource Name (ARN) of the AWS Identity and Access Management (IAM) role that allows Systems Manager Automation to perform the actions on your behalf. If no role is specified, Systems Manager Automation uses the permissions of the user that starts this runbook.",
      "default": ""
    },
    "InstanceId": {
      "type": "AWS::EC2::Instance::Id",
      "description": "(Required) The ID of the Amazon Elastic Compute Cloud (EC2) instance you want to troubleshoot the CloudWatch agent on."
    },
    "S3UploadBucket": {
      "type": "AWS::S3::Bucket::Name",
      "description": "(Optional) The name of an Amazon Simple Storage Service (S3) bucket to upload the collected Amazon CloudWatch agent logs. The EC2 instance profile must have correct permissions to upload files to this bucket. This also requires the target EC2 instance to be an AWS Systems Manager (SSM) managed instance.",
      "default": ""
    },
    "S3BucketOwnerAccountId": {
      "type": "String",
      "description": "(Optional) The AWS Account Number that owns the Amazon S3 bucket where you want to upload the Amazon CloudWatch agent logs. If you do not modify this parameter, the runbooks uses the AWS account ID of the user or role in which the Automation runs.",
      "allowedPattern": "^\\{\\{ global:ACCOUNT_ID \\}\\}$|^[0-9]{12}$",
      "default": "{{ global:ACCOUNT_ID }}"
    },
    "CheckEC2Endpoint": {
      "type": "String",
      "description": "(Optional) Specify 'true' if your agent configuration uses the option 'append_dimensions' to append EC2 metric dimensions to the metrics collected by the agent. When 'append_dimensions' is used, the CloudWatch Agent requires connectivity to the EC2 endpoint, so an additional connectivity tests will be performed via the extended checks. This parameter defaults to 'false'.",
      "allowedValues": [
        "false",
        "true"
      ],
      "default": "false"
    },
    "RunVpcReachabilityAnalyzer": {
      "type": "Boolean",
      "description": "(Optional) Specify 'true' to run the AWSSupport-AnalyzeAWSEndpointReachabilityFromEC2 child automation if a network issue is determined by the extended checks, or if the instance ID specified is not a managed instance. For more information on this child automation, please refer to the documentation above. This parameter defaults to 'false'.",
      "default": false
    },
    "RetainVpcReachabilityAnalysis": {
      "type": "Boolean",
      "description": "(Optional) Only relevant if 'RunVpcReachabilityAnalyzer' is true. Specify 'true' to retain the network insight path and related analyses created by VPC Reachability Analyzer. By default, those resources are deleted after successful analysis.\nIf you choose to retain the analysis, the child runbook does not delete the analysis and you can visualize it in the VPC console. The console link will be available in the child automation output. This parameter defaults to 'false'",
      "default": false
    }
  },
  "mainSteps": [
    {
      "name": "getInstanceProfile",
      "action": "aws:executeAwsApi",
      "inputs": {
        "Service": "ec2",
        "Api": "DescribeInstances",
        "InstanceIds": [
          "{{ InstanceId }}"
        ]
      },
      "outputs": [
        {
          "Name": "InstanceProfileArn",
          "Selector": "$.Reservations[0].Instances[0].IamInstanceProfile.Arn",
          "Type": "String"
        }
      ],
      "description": "Verify if the provided EC2 instance has an IAM instance profile attached.",
      "nextStep": "branchOnInstanceProfileStatus",
      "onFailure": "Abort",
      "isCritical": true
    },
    {
      "name": "branchOnInstanceProfileStatus",
      "action": "aws:branch",
      "inputs": {
        "Default": "getInstanceInformation",
        "Choices": [
          {
            "NextStep": "verifyIamPermissions",
            "Variable": "{{ getInstanceProfile.InstanceProfileArn}}",
            "Contains": "arn:{{ global:AWS_PARTITION }}:iam::"
          }
        ]
      },
      "description": "Branches the automation to check for necessary instance profile permissions if the instance profile is attached to the instance.",
      "onFailure": "Abort",
      "isCritical": true
    },
    {
      "name": "verifyIamPermissions",
      "action": "aws:executeScript",
      "inputs": {
        "Runtime": "python3.8",
        "Handler": "check_permissions.script_handler",
        "InputPayload": {
          "InstanceProfileArn": "{{ getInstanceProfile.InstanceProfileArn }}"
        },
        "Attachment": "attachment.zip"
      },
      "outputs": [
        {
          "Name": "ManagedPolicies",
          "Selector": "$.Payload.ManagedPolicies",
          "Type": "StringMap"
        },
        {
          "Name": "SimulationResults",
          "Selector": "$.Payload.SimulationResults",
          "Type": "StringMap"
        }
      ],
      "description": "Checks the instance profile associated with the instance to determine if the necessary permissions are applied.",
      "nextStep": "getInstanceInformation",
      "onFailure": "Continue",
      "isCritical": false
    },
    {
      "name": "getInstanceInformation",
      "action": "aws:executeAwsApi",
      "inputs": {
        "Service": "ssm",
        "Api": "DescribeInstanceInformation",
        "Filters": [
          {
            "Key": "InstanceIds",
            "Values": [
              "{{ InstanceId }}"
            ]
          }
        ]
      },
      "outputs": [
        {
          "Name": "PingStatus",
          "Selector": "$.InstanceInformationList[0].PingStatus",
          "Type": "String"
        },
        {
          "Name": "OS",
          "Selector": "$.InstanceInformationList[0].PlatformType",
          "Type": "String"
        }
      ],
      "description": "Checks if the instance has an active SSM agent, and fetches the OS type of the instance.",
      "nextStep": "branchOnManagedInstance",
      "onFailure": "step:branchOnRunVpcReachabilityAnalyzer",
      "isCritical": false
    },
    {
      "name": "branchOnManagedInstance",
      "action": "aws:branch",
      "inputs": {
        "Default": "branchOnRunVpcReachabilityAnalyzer",
        "Choices": [
          {
            "NextStep": "getAgentStatus",
            "Variable": "{{ getInstanceInformation.PingStatus }}",
            "StringEquals": "Online"
          }
        ]
      },
      "description": "Branches the automation to perform extended checks if the instance is managed.",
      "onFailure": "step:branchOnRunVpcReachabilityAnalyzer",
      "isCritical": true
    },
    {
      "name": "getAgentStatus",
      "timeoutSeconds": 600,
      "action": "aws:runCommand",
      "inputs": {
        "DocumentName": "AmazonCloudWatch-ManageAgent",
        "InstanceIds": [
          "{{ InstanceId }}"
        ],
        "Parameters": {
          "action": "status"
        }
      },
      "description": "Check the status of the CloudWatch agent on the instance.",
      "nextStep": "branchOnInstanceOsType",
      "onFailure": "Continue",
      "isCritical": false
    },
    {
      "name": "branchOnInstanceOsType",
      "action": "aws:branch",
      "inputs": {
        "Default": "analyzeLogs",
        "Choices": [
          {
            "NextStep": "analyzeLogsWindows",
            "Variable": "{{ getInstanceInformation.OS}}",
            "StringEquals": "Windows"
          }
        ]
      },
      "description": "Branches the automation to run a specific log collection/analysis command based on the OS.",
      "onFailure": "step:outputFindings",
      "isCritical": true
    },
    {
      "name": "analyzeLogs",
      "timeoutSeconds": 600,
      "action": "aws:runCommand",
      "inputs": {
        "DocumentName": "AWS-RunShellScript",
        "TimeoutSeconds": 600,
        "InstanceIds": [
          "{{ InstanceId }}"
        ],
        "Parameters": {
          "commands": [
            "#!/bin/bash",
            "# Copyright 2023 Amazon.com, Inc. or its affiliates. All Rights Reserved.",
            "# This script requires bash v4 or later",
            "",
            "function throw() {",
            "    echo -e \"Error: $1\"",
            "    exit 1",
            "}",
            "",
            "CLOUDWATCH_AGENT_CONFIG=\"/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.toml\"",
            "if [ ! -f \"$CLOUDWATCH_AGENT_CONFIG\" ]; then",
            "    throw \"Can't find CloudWatch Agent config TOML file. This could occur if you haven't started the agent before.\"",
            "fi",
            "AGENT_LOG=`sed -n 's/.*logfile = \"\\(.*\\)\"/\\1/p' ${CLOUDWATCH_AGENT_CONFIG}`",
            "",
            "TIMESTAMP_REGEX=\"[1-9][0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])T([0-1][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]Z \"",
            "REQUEST_ID_REGEX=\"[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}\"",
            "",
            "if [ \"3\" -ge \"${BASH_VERSION:0:1}\" ]; then",
            "    throw \"The current version of bash, ${BASH_VERSION}, is incompatbile with this script. Please review the log file manually and reach out to AWS support for any help.\"",
            "fi",
            "",
            "# Construct list of common errors and generate outputs",
            "ERROR_TYPES=( 'mount_target' 'imds' 'firewall' 'file_deleted' 'socket_fd' 'os_user' 'ec2_metrics' 'system_clock' 'permissions' 'connectivity' )",
            "MATCHERS=( \"took\\ longer\\ to\\ collect\\ than\\ collection\\ interval\"",
            "                 \"169\\.254\\.169\\.254\"",
            "                 \"No\\ connection\\ could\\ be\\ made\\ because\\ the\\ target\\ machine\\ actively\\ refused\\ it\"",
            "                 \"file\\ no\\ longer\\ exists\"",
            "                 \"socket:\\ too\\ many\\ open\\ files\"",
            "                 \"operation\\ not\\ permitted\"",
            "                 \"metrics\\ will\\ be\\ dropped\"",
            "                 \"AuthFailure\"",
            "                 \"(AccessDeniedException)|(UnauthorizedOperation)\"",
            "                 \"i\\/o\\ timeout\" )",
            "",
            "KC_ARTICLE=\"https://aws.amazon.com/premiumsupport/knowledge-center/cloudwatch-unified-agent-metrics-issues/\"",
            "IMDS=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\"",
            "NTP=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/set-time.html\"",
            "declare -A OUTPUTS=( ['mount_target']=\"The CloudWatch agent stops sending all 'disk' metrics if a mount target is unreachable. Please check whether any mounted disks on your instance are unreachable and, if necessary, unmount them.\"                            ",
            "                     ['imds']=\"The EC2 metadata service appears to be unreachable. Please ensure the instance is able to reach the metadata service at '169.254.169.254'. For more information you can review the docs on IMDS here:\\n\\t${IMDS}\"                                                                       ",
            "                     ['firewall']=\"The local firewall, or firewall in between the host and endpoint is blocking the connection to the remote IP's. Please ensure there is a valid route to the endpoint.\"",
            "                     ['file_deleted']=\"The log file to be collected as per CloudWatch Agent config no longer exists. Please review your config file for errors if you need to stream this log file, or remove the entry if it's no longer needed.\"                                                         ",
            "                     ['socket_fd']=\"The CloudWatch agent's process has reached the maximum number of open file descriptors. Please review the 'Max open files' limit of the process on your system via the command 'sudo cat /proc/<pid>/limits'.\"                                                     ",
            "                     ['os_user']=\"The user specified in the 'run_as_user' section of your CloudWatch agent config is not able to open the specified file. Please review file and directory permission on the OS.\"   ",
            "                     ['ec2_metrics']=\"The CloudWatch agent has failed to deliver EC2 Metrics due to an endpoint failure. Confirm connectivity to the EC2 endpoint and review our public knowledge article for more troubleshooting steps:\\n\\t${KC_ARTICLE}\"                                                          ",
            "                     ['system_clock']=\"The system credentials have failed to be validated. A common cause of this is due to an out of sync system clock. Please review the docs here for assistance in configuring the system clock:\\n\\t${NTP}\"                                                                         ",
            "                     ['permissions']=\"The attached IAM instance profile role but does not have sufficient permissions. Please refer to the section 'Confirm that the host has permissions to publish metrics and logs' in our public knowledge article for more information:\\n\\t${KC_ARTICLE}\"                                   ",
            "                     ['connectivity']=\"The agent has failed to connect to one of the required endpoints. Please ensure the instance (and any proxy - if configured) is able to connect to all required endpoints.\\nFor more information on the required endpoints, please refer to our public knowledge article:\\n\\t${KC_ARTICLE}\" )                ",
            "",
            "# Read log into 'errors' array without duplicate error keys",
            "# Change multi-line logs into single record errors, drop empty errors",
            "# Read unique \"Error\" or \"Warning\" logs into array",
            "readarray -t errors < <(awk -v timestamp=$TIMESTAMP_REGEX -v rid=$REQUEST_ID_REGEX \\",
            "                            'BEGIN{RS=timestamp}                                   \\",
            "                            !/retrying|(I!)|(D!)/ && NF > 0                        \\",
            "                            {                                                      \\",
            "                                if($NF~rid){                                       \\",
            "                                    OUT=$1;                                        \\",
            "                                    for( i=2; i<NF; i++ ){                         \\",
            "                                        if( $i == \"\\n\"){                           \\",
            "                                            $i = \" \"                               \\",
            "                                        }                                          \\",
            "                                        OUT=OUT OFS $i                             \\",
            "                                    }                                              \\",
            "                                }                                                  \\",
            "                                else{                                              \\",
            "                                    OUT=$1;                                        \\",
            "                                    for( i=2; i<=NF; i++ ){                        \\",
            "                                        if( $i == \"\\n\"){                           \\",
            "                                            $i = \" \"                               \\",
            "                                        }                                          \\",
            "                                        OUT=OUT OFS $i                             \\",
            "                                    }                                              \\",
            "                                }                                                  \\",
            "                                { print OUT }                                      \\",
            "                            }'                                                     \\",
            "                            $AGENT_LOG | sort | uniq)                              \\",
            "                || throw \"Internal Failure while parsing log file\"                                          ",
            "",
            "# Loop through errors array and output recommendation action based on the matching regex - will start with more",
            "# specific errors and then output broader errors like i/o timeout if the specific ones havent matched",
            "# The 'errors' array may have stale errors or duplicate root causes but we will match all of these anyways and provide that information",
            "matches=0",
            "for error in \"${errors[@]}\";",
            "do",
            "    # ERROR_TYPES array and MATCHERS array have same length/elem positions",
            "    for (( i=0; i<${#ERROR_TYPES[@]}; i++ ));",
            "    do",
            "        if [[ \"$error\" =~ ${MATCHERS[i]} ]]; then",
            "            ((matches+=1))",
            "            echo \"---------------Log Finding---------------\"",
            "            echo -e \"The following error was found in your logs:\\n===> ${error}\"",
            "            echo -e \"\\n${OUTPUTS[${ERROR_TYPES[i]}]}\\n\\n\"",
            "            break",
            "        fi",
            "    done",
            "done",
            "",
            "if [ \"${#errors[@]}\" -ne \"$matches\" ]; then",
            "    echo \"---------------Log Finding---------------\"",
            "    echo -e \"Some errors in the logs were unable to be matched. Please review your CloudWatch agent logs, and reach out to AWS support if you need further help.\"",
            "elif [ \"${#errors[@]}\" -eq \"0\" ]; then",
            "    echo \"No errors found while analyzing CloudWatch agent logs.\"",
            "fi"
          ]
        }
      },
      "description": "Analyze and output findings of CloudWatch agent logs on Linux OSs.",
      "nextStep": "collectLogs",
      "onFailure": "step:collectLogs",
      "isCritical": false
    },
    {
      "name": "collectLogs",
      "timeoutSeconds": 600,
      "action": "aws:runCommand",
      "inputs": {
        "DocumentName": "AWS-RunShellScript",
        "TimeoutSeconds": 600,
        "InstanceIds": [
          "{{ InstanceId }}"
        ],
        "Parameters": {
          "commands": [
            "#!/bin/bash",
            "# Copyright 2023 Amazon.com, Inc. or its affiliates. All Rights Reserved.",
            "",
            "function throw() {",
            "    echo -e \"Error: $1\"",
            "    exit 1",
            "}",
            "",
            "# Zip file constants",
            "DATE=`date +\"%Y-%m-%dT%H:%M:%SZ\"`",
            "ZIP_FILE_NAME=\"TroubleshootCloudWatchAgentLogs_{{automation:EXECUTION_ID}}_${DATE}.zip\"",
            "THRESHOLD=75",
            "",
            "# S3 upload constants",
            "S3_BUCKET={{S3UploadBucket}}",
            "REGION={{global:REGION}}",
            "PUBLIC_ACL_INDICATOR='http://acs.amazonaws.com/groups/global/AllUsers'",
            "",
            "## Configuration file path constants",
            "CLOUDWATCH_AGENT_CONFIG=\"/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.toml\"",
            "CLOUDWATCH_LOG_CONFIGS=\"/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.d/*\"",
            "CLOUDWATCH_AGENT_COMMON_CONFIG=\"/opt/aws/amazon-cloudwatch-agent/etc/common-config.toml\"",
            "",
            "# The below are locations of configs that may or may not be in use depending on how the agent was started",
            "# These may be relevant to troubleshooting, but the above locations are the source of truth for actual configuration",
            "AGENT_CREATED_CONFIG=\"/opt/aws/amazon-cloudwatch-agent/bin/config.json\"",
            "SSM_DOWNLOADED_CONFIG=\"/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json\"",
            "",
            "# Log file path constants - the agent log can have a modified log location so we can parse this from the config",
            "# Agent log can be rotated - https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-Agent-Configuration-File-Details.html#CloudWatch-Agent-Configuration-File-Agentsection",
            "CONFIGURATION_VALIDATION_LOG=\"/opt/aws/amazon-cloudwatch-agent/logs/configuration-validation.log\"",
            "if [ ! -f \"$CLOUDWATCH_AGENT_CONFIG\" ]; then",
            "    throw \"Can't find CloudWatch Agent config TOML file. This could occur if you haven't started the agent before.\"",
            "fi",
            "AGENT_LOG=`sed -n 's/.*logfile = \"\\(.*\\)\"/\\1/p' ${CLOUDWATCH_AGENT_CONFIG}`",
            "ROTATED_AGENT_LOGS=`echo $AGENT_LOG | sed 's/\\.log/*.gz/'`",
            "",
            "if [ ! -f \"$AGENT_CREATED_CONFIG\" ]; then",
            "    echo \"No wizard-created config files found. Skipping...\"",
            "fi",
            "",
            "if [ ! -f \"$SSM_DOWNLOADED_CONFIG\" ]; then",
            "    echo \"No SSM-downloaded config files found. Skipping...\"",
            "fi",
            "",
            "ALL_FILES=(${CLOUDWATCH_AGENT_CONFIG} ${CLOUDWATCH_LOG_CONFIGS} ${CLOUDWATCH_AGENT_COMMON_CONFIG} ${AGENT_CREATED_CONFIG} ${SSM_DOWNLOADED_CONFIG} ${CONFIGURATION_VALIDATION_LOG} ${AGENT_LOG} ${ROTATED_AGENT_LOGS})",
            "",
            "# Check server disk space before zipping",
            "result=$(df | grep -ve \"Filesystem\\|loop\" | awk '{print $5}' | sed 's/%//g')",
            "partition_name=($(df | grep -ve \"Filesystem\\|loop\" | awk '{print $1}'))",
            "exceeded=0",
            "",
            "partition_index=0",
            "for percent in ${result}; do",
            "    if [[ \"${percent}\" -gt \"${THRESHOLD}\" ]]; then",
            "        echo \"${partition_name[partition_index]} is ${percent}% full, please ensure your partitions are less than ${THRESHOLD}% full to collect and store the log files.\"",
            "        ((exceeded+=1))",
            "    fi",
            "    ((partition_index+=1))",
            "done",
            "",
            "if [ \"$exceeded\" -gt 0 ]; then",
            "    throw \"Exiting early due to disk usage. Please cleanup disk partitions and run the automation again, or manually bundle/inspect your CloudWatch Agent logs.\"",
            "fi",
            "",
            "cd /tmp/",
            "zip -q -r $ZIP_FILE_NAME ${ALL_FILES[@]} && echo -e \"Files zipped successfully to location $(pwd)/${ZIP_FILE_NAME}\" || throw \"Failed to zip files\"",
            "",
            "# Upload zipfile to S3 if a bucket was provided",
            "if [ ! -z \"$S3_BUCKET\" ]; then",
            "    which aws &> /dev/null \\",
            "        || throw \"The AWS CLI is not installed, or not on the system path. For information on installing the AWS CLI, please refer to the below link:\\n\\thttps://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html\"",
            "",
            "    aws s3api head-bucket --bucket $S3_BUCKET --expected-bucket-owner \"{{S3BucketOwnerAccountId}}\" --region $REGION &> /dev/null \\",
            "        || throw \"The specified bucket could not be found in the account, or an error occurred while listing the bucket.\\nLeaving zipfile on instance, please cleanup manually if you want it removed.\"",
            "",
            "    if ! aws s3api get-bucket-policy-status --bucket $S3_BUCKET --region $REGION 2>&1 | grep -q \"does not exist\"; then",
            "        policy_status=`aws s3api get-bucket-policy-status --bucket $S3_BUCKET --output text --region $REGION 2> /dev/null` \\",
            "            || throw \"Failed to get bucket policy status. Please make sure the instance profile has the s3:GetBucketPolicyStatus permission.\\nLeaving zipfile on instance, please cleanup manually if you want it removed.\"",
            "        ",
            "        test \"$(echo $policy_status | cut -d \" \" -f2)\" = \"True\" \\",
            "            && throw \"The bucket policy allows public access. Cannot upload when bucket is public.\\nLeaving zipfile on instance, please cleanup manually if you want it removed.\" \\",
            "            || echo \"Bucket policy not public\" > /dev/null",
            "    fi",
            "",
            "    bucket_acls=`aws s3api get-bucket-acl --output text --bucket $S3_BUCKET --region $REGION 2> /dev/null` \\",
            "        || throw \"Failed to get bucket ACL. Please make sure the instance profile has the s3:GetBucketAcl permission.\\nLeaving zipfile on instance, please cleanup manually if you want it removed.\"",
            "",
            "    echo \"$bucket_acls\" | grep -A1 'READ\\|WRITE' | grep -q \"${PUBLIC_ACL_INDICATOR}\" \\",
            "        && throw \"The bucket ACLs allow public access. Cannot upload when bucket is public.\\nLeaving zipfile on instance, please cleanup manually if you want it removed.\" \\",
            "        || echo \"Bucket ACLs not public\" > /dev/null",
            "",
            "    aws s3 cp --quiet $(pwd)/${ZIP_FILE_NAME} s3://${S3_BUCKET}/AWSSupport-TroubleshootCloudWatchAgent/Execution_ID_{{automation:EXECUTION_ID}}/${ZIP_FILE_NAME} --region $REGION \\",
            "        && echo -e \"Successfully uploaded the log zipfile to the S3 bucket. This can be found in the following S3 path:\\n\\ts3://${S3_BUCKET}/AWSSupport-TroubleshootCloudWatchAgent/Execution_ID_{{automation:EXECUTION_ID}}/\" \\",
            "        || throw \"S3 upload command failed. Please ensure the instance profile associated with your instance has proper permissions to upload to this bucket.\\nLeaving zipfile on instance, please cleanup manually if you want it removed.\"",
            "",
            "    rm ${ZIP_FILE_NAME} && echo \"Cleaned up zipfile on the instance.\" \\",
            "        || throw \"Couldn't cleanup zipfile on instance. Please cleanup manually.\"",
            "else",
            "    echo \"No S3 bucket provided. Skipping zip upload...\"",
            "fi"
          ]
        }
      },
      "description": "Bundle and output the relevant CloudWatch agent troubleshooting files on Linux OSs.",
      "nextStep": "checkEndpointReachability",
      "onFailure": "step:checkEndpointReachability",
      "isCritical": false
    },
    {
      "name": "checkEndpointReachability",
      "timeoutSeconds": 600,
      "action": "aws:runCommand",
      "inputs": {
        "DocumentName": "AWS-RunShellScript",
        "TimeoutSeconds": 600,
        "InstanceIds": [
          "{{ InstanceId }}"
        ],
        "Parameters": {
          "commands": [
            "#!/bin/bash",
            "# Copyright 2023 Amazon.com, Inc. or its affiliates. All Rights Reserved.",
            "",
            "function get_suffix() {",
            "    if [[ \"$1\" == \"aws-cn\" ]]; then",
            "        eval \"$2='amazonaws.com.cn'\"",
            "    else",
            "        eval \"$2='amazonaws.com'\"",
            "    fi;",
            "}",
            "",
            "# Set endpoint constants",
            "SUFFIX=''",
            "get_suffix \"{{global:AWS_PARTITION}}\" SUFFIX",
            "USES_EC2_ENDPOINT=\"{{CheckEC2Endpoint}}\"",
            "LOGS_ENDPOINT=\"logs.{{global:REGION}}.${SUFFIX}\"",
            "CLOUDWATCH_ENDPOINT=\"monitoring.{{global:REGION}}.${SUFFIX}\"",
            "EC2_ENDPOINT=\"ec2.{{global:REGION}}.${SUFFIX}\"",
            "",
            "logs_status=''",
            "cloudwatch_status=''",
            "ec2_status=''",
            "",
            "function check_endpoint() {",
            "    if `which curl &> /dev/null`; then",
            "        curl -I https://$1 --connect-timeout 10 &> /dev/null",
            "    elif `which wget &> /dev/null`; then",
            "        wget -S https://$1 --timeout 10 -t 1 &> /dev/null",
            "    else",
            "        echo \"Neither curl nor wget are installed, or they're missing on the system path. Can't run connection test.\" && exit 1",
            "    fi;",
            "}",
            "",
            "function test_success() {",
            "    # wget exits with return status of 8 if server returns 404",
            "    if [[ \"$1\" != \"0\" && \"$1\" != \"8\" ]]; then",
            "        eval \"$2='failed'\"",
            "    else",
            "        eval \"$2='success'\"",
            "    fi;",
            "}",
            "",
            "check_endpoint $LOGS_ENDPOINT ",
            "test_success $? logs_status",
            "check_endpoint $CLOUDWATCH_ENDPOINT",
            "test_success $? cloudwatch_status",
            "",
            "if [[ \"$USES_EC2_ENDPOINT\" == \"true\" ]]; then",
            "    check_endpoint $EC2_ENDPOINT",
            "    test_success $? ec2_status",
            "else",
            "    ec2_status=\"not_run\"",
            "fi;",
            "",
            "echo -e \"{\\n  \\\"logs\\\":\\\"${logs_status}\\\",\\n  \\\"monitoring\\\":\\\"${cloudwatch_status}\\\",\\n  \\\"ec2\\\":\\\"${ec2_status}\\\"\\n}\""
          ]
        }
      },
      "description": "Check if the instance can reach the required endpoints on Linux OSs.",
      "nextStep": "branchOnRunVpcReachabilityAnalyzer",
      "onFailure": "step:outputFindings",
      "isCritical": false
    },
    {
      "name": "analyzeLogsWindows",
      "timeoutSeconds": 600,
      "action": "aws:runCommand",
      "inputs": {
        "DocumentName": "AWS-RunPowerShellScript",
        "TimeoutSeconds": 600,
        "InstanceIds": [
          "{{ InstanceId }}"
        ],
        "Parameters": {
          "commands": [
            "# Copyright 2023 Amazon.com, Inc. or its affiliates. All Rights Reserved.",
            "",
            "$CloudWatchAgentConfig=\"$Env:ProgramData\\Amazon\\AmazonCloudWatchAgent\\amazon-cloudwatch-agent.toml\"",
            "# CloudWatch Agent Logging Location",
            "try {",
            "    $Match = Select-String -Path $CloudWatchAgentConfig -pattern \"(?:\\\\\\\\[^\\\\]+|[a-zA-Z]:)((?:\\\\[^\\\\\\n]+)+\\\\)?([^<>:\\n]*.log)\"",
            "    $AgentLog=$Match.Matches.groups[0].value",
            "} catch {",
            "    Write-Host \"Can't find CloudWatch Agent config TOML file. This could occur if you haven't started the agent before. Exiting log analyzer now.\"",
            "    Exit 1",
            "}",
            "",
            "# Variables containing troubleshooting links",
            "$KcArticle=\"https://aws.amazon.com/premiumsupport/knowledge-center/cloudwatch-unified-agent-metrics-issues/\"",
            "$Imds=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\"",
            "$Ntp=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/set-time.html\"",
            "",
            "# Hashtable of matchers:errortypes/descriptions",
            "$Outputs = @{ ",
            "    \"took longer to collect than collection interval\"=\"The CloudWatch agent stops sending all 'disk' metrics if a mount target is unreachable. Please check whether any mounted disks on your instance are unreachable and, if necessary, unmount them.\"",
            "    \"169.254.169.254\"=\"The EC2 metadata service appears to be unreachable. Please ensure the instance is able to reach the metadata service at '169.254.169.254'. For more information you can review the docs on IMDS here: ${Imds}.\"",
            "    \"No connection could be made because the target machine actively refused it\"=\"The local firewall, or firewall in between the host and endpoint is blocking the connection to the remote IP's. Please ensure there is a valid route to the endpoint.\"",
            "    \"file no longer exists\"=\"The log file to be collected as per CloudWatch Agent config no longer exists. Please review your config file for errors if you need to stream this log file, or remove the entry if it's no longer needed.\"",
            "    \"socket: too many open files\"=\"The CloudWatch agent's process has reached the maximum number of open file descriptors. Please review the 'Max open files' limit of the process on your system via the command 'sudo cat /proc/<pid>/limits'.\"",
            "    \"operation not permitted\"=\"The user specified in the 'run_as_user' section of your CloudWatch agent config is not able to open the specified file. Please review file and directory permission on the OS.\"",
            "    \"metrics will be dropped\"=\"The CloudWatch agent has failed to deliver EC2 Metrics due to an endpoint failure. Confirm connectivity to the EC2 endpoint and review our public knowledge article for more troubleshooting steps: ${KcArticle}.\"",
            "    \"AuthFailure\"=\"The system credentials have failed to be validated. A common cause of this is due to an out of sync system clock. Please review the docs here for assistance in configuring the system clock: ${Ntp}.\"",
            "    \"UnauthorizedOperation\"=\"The attached IAM instance profile role but does not have sufficient permission. Please refer to the section 'Confirm that the host has permissions to publish metrics and logs' in our public knowledge article for more information: ${KcArticle}.\"",
            "    \"AccessDenied\"=\"The attached IAM instance profile role but does not have sufficient permission. Please refer to the section 'Confirm that the host has permissions to publish metrics and logs' in our public knowledge article for more information: ${KcArticle}.\"",
            "    \"i/o timeout\"=\"The agent has failed to connect to one of the required endpoints. Please ensure the instance (and any proxy - if configured) is able to connect to all required endpoints. For more information on the required endpoints, please refer to our public knowledge article: ${KcArticle}.\"",
            "}",
            "",
            "# Strings to parse the log for",
            "$ErrorsTypes = @(",
            "    'took longer to collect than collection interval', ",
            "    '169.254.169.254', ",
            "    'No connection could be made because the target machine actively refused it', ",
            "    'file no longer exists', ",
            "    'socket: too many open files', ",
            "    'operation not permitted', ",
            "    'metrics will be dropped', ",
            "    'AuthFailure', ",
            "    'UnauthorizedOperation', ",
            "    'AccessDenied', ",
            "    'i/o timeout'",
            ")",
            "",
            "# Selects all single and multi-line errors and drops the timestamps at the beginning",
            "$TimeStampRegex = \"\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z\"",
            "$ErrorMessageRegex = \"(?<=${TimeStampRegex} )(W!|E!).*\\r?\\n((?:(?!${TimeStampRegex}).*(?:\\r?\\n|$))*)\"",
            "$RequestIdRegex = \"[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}\"",
            "",
            "try {",
            "    $ErrorMatches = @(Get-Content $AgentLog -Raw | Select-String -Pattern $ErrorMessageRegex -AllMatches)",
            "    # Drop request-ids, non-unique errs, and retries",
            "    $LogEntries = @(ForEach ($Match in $ErrorMatches) {$Match.Matches.Value -NotMatch \"retrying\" -Replace '\\n', ' ' -Replace $RequestIdRegex, ''})",
            "    $LogEntries = $LogEntries | Sort-Object -Unique",
            "    $Counter=0",
            "",
            "    ForEach ($Log in $LogEntries) {",
            "        $LogResult = New-Object PSObject",
            "        ForEach ($ErrorType in $ErrorsTypes) {",
            "            if ($Log -Match $ErrorType){",
            "                Write-Host \"---------------Log Finding---------------\"",
            "                Write-Host \"The following error was found in your logs:`n===> ${Log}\"",
            "                $Output = $Outputs[$ErrorType]",
            "                Write-Host \"`n$Output`n`n\" ",
            "                $Counter++",
            "                break",
            "            }",
            "        }",
            "    }",
            "",
            "    if ($LogEntries.Count -ne $Counter) {",
            "        Write-Host \"---------------Log Finding---------------\"",
            "        Write-Host \"Some errors in the logs were unable to be matched. Please review your CloudWatch agent logs, and reach out to AWS support if you need further help.\"",
            "    } elseif ($LogEntries.Count -eq 0) {",
            "        Write-Host \"No errors found while analyzing CloudWatch agent logs.\"",
            "    }",
            "    ",
            "} catch {",
            "    Write-Host \"Error! Could not process logs on instance. Please review your CloudWatch agent logs, and reach out to AWS support if you need further help\"",
            "    Exit 1",
            "}"
          ]
        }
      },
      "description": "Analyze and output findings of CloudWatch agent logs on Windows OSs.",
      "nextStep": "collectLogsWindows",
      "onFailure": "step:collectLogsWindows",
      "isCritical": false
    },
    {
      "name": "collectLogsWindows",
      "timeoutSeconds": 600,
      "action": "aws:runCommand",
      "inputs": {
        "DocumentName": "AWS-RunPowerShellScript",
        "TimeoutSeconds": 600,
        "InstanceIds": [
          "{{ InstanceId }}"
        ],
        "Parameters": {
          "commands": [
            "# Copyright 2023 Amazon.com, Inc. or its affiliates. All Rights Reserved.",
            "",
            "# File/Dir consts",
            "$BasePath = \"$Env:WinDir\\Temp\"",
            "# Create unique LogDir on every run to prevent \"directory already exists\" errors in the event the zip file is left over",
            "$LogDir=\"$BasePath\\TroubleshootCloudWatchAgent_{{automation:EXECUTION_ID}}\"",
            "$Date=Get-Date (Get-Date).ToUniversalTime() -UFormat '+%Y_%m_%dT%H_%M_%S'",
            "$ZipFileName=\"TroubleshootCloudWatchAgentLogs_${Date}.zip\"",
            "$ZipFile=\"$LogDir\\$ZipFileName\"",
            "",
            "# Configuration file path consts",
            "$CloudWatchAgentConfig=\"$Env:ProgramData\\Amazon\\AmazonCloudWatchAgent\\amazon-cloudwatch-agent.toml\"",
            "$CloudWatchAgentCommonConfig=\"$Env:ProgramData\\Amazon\\AmazonCloudWatchAgent\\common-config.toml\"",
            "$CloudWatchLogConfigs=\"$Env:ProgramData\\Amazon\\AmazonCloudWatchAgent\\Configs\\*.json\"",
            "",
            "# The below are locations of configs that may or may not be in use depending on how the agent was started",
            "# These may be relevant to troubleshooting, but the above locations are the source of truth for actual configuration",
            "$AgentCreatedConfig= Test-Path -Path \"$Env:ProgramFiles\\Amazon\\AmazonCloudWatchAgent\\config.json\" -PathType Leaf",
            "$SSMDownloadedConfig= Test-Path -Path \"$Env:ProgramData\\Amazon\\AmazonCloudWatchAgent\\amazon-cloudwatch-agent.json\" -PathType Leaf",
            "",
            "# Log file consts",
            "$AgentLog=\"\"",
            "$ConfigurationValidationLog=\"$Env:ProgramData\\Amazon\\AmazonCloudWatchAgent\\Logs\\configuration-validation.log\"",
            "",
            "# S3 consts",
            "$S3Bucket = \"{{S3UploadBucket}}\"",
            "$Region = \"{{global:REGION}}\"",
            "",
            "# Check disk space",
            "function Get-DiskUsage {",
            "    $threshold = 75",
            "    try {",
            "        $drive = Get-WmiObject Win32_LogicalDisk -Filter \"DeviceID='$Env:SystemDrive'\"",
            "        $percent = 100 - ([math]::round($drive.FreeSpace/1GB, 0) / ([math]::round($drive.Size/1GB, 0)) * 100)",
            "    } catch {",
            "        Write-Host \"Error! Unable to Determine Free Disk Space\"",
            "        Exit 1",
            "    } if ($percent -gt $threshold){",
            "        Write-Host \"$Env:SystemDrive drive is $percent% full, please ensure the disk is less than $threshold% full to collect and store the log files. Exiting early.\" ",
            "        Exit 1",
            "    }",
            "}",
            "",
            "# Creates a directory to store the files",
            "Function New-TempDir{",
            "    try {",
            "        Write-Host \"Creating temporary directory\"",
            "        New-Item -type directory -path $script:LogDir -Force > $null",
            "    } catch {",
            "        Write-Host \"Error! Unable to create temporary directory. This is required to zip the files. Exiting...\"",
            "        Exit 1",
            "    }",
            "}",
            "",
            "# Check to see if the intial agent config files exists",
            "# Whichever method was used i.e. via the Wizard or via SSM, it stores the path in the $AgentConfig variable for collection",
            "function Get-OptionalConfigs {",
            "    If ($AgentCreatedConfig -eq $True) {",
            "        $script:AgentConfig=\"$Env:ProgramFiles\\Amazon\\AmazonCloudWatchAgent\\config.json\"",
            "        Write-Host \"Wizard Config is present! and located at $AgentConfig\"",
            "    } elseif ($SSMDownloadedConfig -eq $True) {",
            "        $script:AgentConfig=\"$Env:ProgramData\\Amazon\\AmazonCloudWatchAgent\\amazon-cloudwatch-agent.json\"",
            "        write-host \"SSM Config File is present! and located at $AgentConfig\"",
            "    } else {",
            "        write-Host \"Config Files cannot be found!\"",
            "    }",
            "        ",
            "}",
            "",
            "# Log file path constants - the agent log can have a modified log location so we will parse this from the TOML config",
            "# Regex to match the file pertaining that '.log' is used as the extension \"(?:\\\\\\\\[^\\\\]+|[a-zA-Z]:)((?:\\\\[^\\\\\\n]+)+\\\\)?([^<>:\\n]*.log)\"",
            "function Get-LoggingLocation() {",
            "    try {",
            "        $Match = Select-String -Path $CloudWatchAgentConfig -pattern \"(?:\\\\\\\\[^\\\\]+|[a-zA-Z]:)((?:\\\\[^\\\\\\n]+)+\\\\)?([^<>:\\n]*.log)\"",
            "        $script:AgentLog=$Match.Matches.groups[0].value",
            "        $script:AgentLogsRotated = $script:AgentLog.Split('.')[0] + \"*.gz\"",
            "    } catch {",
            "        Write-Host \"Error! Unable to find logging location. This could occur if you haven't started the agent before. Exiting...\"",
            "        Exit 1",
            "    }",
            "}",
            "",
            "# Remove temp directory and any copied items",
            "Function Remove-TempItems([bool]$RemoveZip) {",
            "    try {",
            "        if ( $RemoveZip -AND (Test-Path -Path $LogDir -Type Container) ) {",
            "            Remove-Item -Recurse -Force $LogDir",
            "        } elseif (-NOT $RemoveZip -AND (Test-Path -Path $LogDir -Type Container) ) {",
            "            Remove-Item -Recurse -Force \"${LogDir}/*\" -Exclude $ZipFileName",
            "        } else {",
            "            Write-Host \"Unable to cleanup $LogDir, Please cleanup manually!\" ",
            "            Exit 1",
            "        }",
            "    } catch {",
            "        Write-Host \"Unable to cleanup $LogDir, Please cleanup manually!\" ",
            "        Exit 1",
            "    }",
            "}",
            "",
            "# Compresses the agent files to the new location i.e. $LogDir\\$ZipFileName",
            "function New-Zip {",
            "    try {",
            "        $Files = @($script:CloudWatchAgentConfig, $script:CloudWatchAgentCommonConfig, $script:AgentConfig, $script:CloudWatchLogConfigs, $script:AgentLog, $script:ConfigurationValidationLog, $script:AgentLogsRotated)",
            "        # Get rid of any null or empty strings when zipping to avoid errors",
            "        $Files = $Files.where({ ($null -ne $_) -AND ('' -ne $_) })",
            "        Copy-Item $Files -Destination $LogDir",
            "        # Create temp directory where we can bundle logs",
            "        $script:S3ZipFile=\"$LogDir\\$ZipFileName\"",
            "        Compress-Archive -Path $LogDir -CompressionLevel Optimal -DestinationPath $script:S3ZipFile",
            "        Write-Host \"Files zipped successfully to location $LogDir\\$ZipFileName\"",
            "    } catch {",
            "        Write-Host \"Error! Zip command failed due to an Internal Failure - Unable to archive data.\"",
            "        Remove-TempItems $True",
            "        Write-Host \"Temp folder cleaned up. Exiting...\"",
            "        Exit 1",
            "    }",
            "}",
            "",
            "Get-DiskUsage",
            "Get-OptionalConfigs",
            "Get-LoggingLocation",
            "New-TempDir",
            "New-Zip",
            "",
            "function Eval-BucketPolicy {",
            "    try {",
            "        $bucketPolicy = Get-S3BucketPolicyStatus -BucketName $S3Bucket -ExpectedBucketOwner \"{{S3BucketOwnerAccountId}}\" -Region $script:Region",
            "    } catch {",
            "        if ($_.Exception.Message -eq \"The bucket policy does not exist\") {",
            "            return $False",
            "        } else {",
            "            Write-Host \"There was an error while verifying S3 bucket policy:\" $_.Exception.Message",
            "            return $True",
            "        }",
            "    }",
            "    if($bucketPolicy.IsPublic) {",
            "        Write-Host \"Verifying bucket Policy: Bucket is public, cannot Upload to a public bucket!\"",
            "        return $True",
            "    }",
            "    return $False",
            "}",
            "",
            "function Eval-BucketAcl {",
            "    try {",
            "        $bucketAcl = Get-S3ACL -Bucketname $S3Bucket -ExpectedBucketOwner \"{{S3BucketOwnerAccountId}}\" -Region $script:Region",
            "        foreach ($grant in $bucketAcl.Grants) {",
            "            if ($grant.Grantee.URI -eq \"http://acs.amazonaws.com/groups/global/AllUsers\") {",
            "                Write-Host \"Verifying bucket ACL: Bucket is public, cannot Upload to a public bucket!\"",
            "                return $True",
            "            }",
            "        }",
            "    } catch{",
            "        Write-Host \"There was an error while verifying S3 bucket ACL:\" $_.Exception.Message",
            "        return $True",
            "    }",
            "    return $False",
            "}",
            "",
            "function Check-Module($ModuleName) {",
            "    return [bool](Get-Module -ListAvailable -Name $ModuleName -ErrorAction SilentlyContinue)",
            "}",
            "",
            "if ($S3Bucket) {",
            "    if (Check-Module AWSPowershell) {",
            "        Import-Module AWSPowershell -Force",
            "        if (Test-S3Bucket -BucketName $S3Bucket -Region $Region) {",
            "            if ( (Eval-BucketPolicy) -or (Eval-BucketAcl) ) {",
            "                Write-Host \"Error! Specified S3 bucket is public, doesn't belong to this account, or an error occurred while checking the bucket properties.`nLeaving the zip file on the instance, please cleanup this file if you want it removed.\"",
            "                Remove-TempItems $False",
            "                Write-Host \"Temp file clean-up completed. Exiting...\"",
            "                Exit 1",
            "            } else {",
            "                try{",
            "                    Write-S3Object -BucketName $S3Bucket -Key \"AWSSupport-TroubleshootCloudWatchAgent/Execution_ID_{{automation:EXECUTION_ID}}/${ZipFileName}\" -File $S3ZipFile -Region $Region",
            "                    Write-Host \"Successfully uploaded the log zipfile to the S3 bucket. This can be found in the following S3 path:`n`t's3://$S3Bucket/AWSSupport-TroubleshootCloudWatchAgent/Execution_ID_{{automation:EXECUTION_ID}}/'\"",
            "                    Remove-TempItems $True",
            "                    Write-Host \"Temp folder and zip cleaned up. Exiting...\"",
            "                } catch {",
            "                    Write-Host \"Error! Failed to upload log file to S3 bucket 's3://$S3Bucket/AWSSupport-TroubleshootCloudWatchAgent/Execution_ID_{{automation:EXECUTION_ID}}/'. Please ensure the instance profile has the required permissions.\"",
            "                    Write-Host \"Leaving the Zip file on the instance, please cleanup this file if you want it removed.\"",
            "                    Remove-TempItems $False",
            "                    Write-Host \"Temp file clean-up completed. Exiting...\"",
            "                    Exit 1",
            "                }",
            "            }    ",
            "        }",
            "        else{",
            "            Write-Host \"No S3 bucket called '$S3Bucket' found in the current AWS account, or access denied. Please specify a S3 bucket in your account that the instance can access.\"",
            "            Write-Host \"Leaving the Zip file on the instance, please cleanup this file if you want it removed.\"",
            "            Remove-TempItems $False",
            "            Write-Host \"Temp file clean-up completed. Exiting...\"",
            "            Exit 1",
            "        }",
            "    } else {",
            "        Write-Host \"AWS Tools for Windows PowerShell not installed. Please install the latest version of the AWS Tools for Windows PowerShell and try again.\"",
            "        Write-Host \"Download location: https://aws.amazon.com/powershell/\"",
            "        Write-Host \"Leaving the Zip file on the instance, please cleanup this file if you want it removed.\"",
            "        Remove-TempItems $False",
            "        Write-Host \"Temp file clean-up completed. Exiting...\"",
            "        Exit 1",
            "    }",
            "} else {",
            "    Write-Host \"No S3 Bucket provided. Skipping upload.\"",
            "    Remove-TempItems $False",
            "    Write-Host \"Temp file clean-up completed. Exiting...\"",
            "}"
          ]
        }
      },
      "description": "Bundle and output the relevant CloudWatch agent troubleshooting files on Windows OSs.",
      "nextStep": "checkEndpointReachabilityWindows",
      "onFailure": "step:checkEndpointReachabilityWindows",
      "isCritical": false
    },
    {
      "name": "checkEndpointReachabilityWindows",
      "timeoutSeconds": 600,
      "action": "aws:runCommand",
      "inputs": {
        "DocumentName": "AWS-RunPowerShellScript",
        "TimeoutSeconds": 600,
        "InstanceIds": [
          "{{ InstanceId }}"
        ],
        "Parameters": {
          "commands": [
            "# Copyright 2023 Amazon.com, Inc. or its affiliates. All Rights Reserved.",
            "",
            "function Check-Command($cmdname) {",
            "    return [bool](Get-Command -Name $cmdname -ErrorAction SilentlyContinue)",
            "}",
            "",
            "if (-NOT(Check-Command Invoke-WebRequest)) {",
            "    throw \"Error! Invoke-WebRequest Cmdlet not available on server. Exiting.\"",
            "}",
            "",
            "function Get-Suffix($partition) {",
            "    if ($partition -eq 'aws-cn') {",
            "        return \"amazonaws.com.cn\"",
            "    } else {",
            "        return \"amazonaws.com\"",
            "    }",
            "}",
            "",
            "# Set endpoint constants",
            "$Suffix=Get-Suffix \"{{global:AWS_PARTITION}}\"",
            "$UsesEc2Endpoint=\"{{CheckEC2Endpoint}}\"",
            "$LogsEndpoint=\"logs.{{global:REGION}}.${Suffix}\"",
            "$CloudWatchEndpoint=\"monitoring.{{global:REGION}}.${Suffix}\"",
            "$Ec2Endpoint=\"ec2.{{global:REGION}}.${Suffix}\"",
            "",
            "function Check-Endpoint($endpoint) {",
            "    try {",
            "        $Response = Invoke-WebRequest -Uri https://$endpoint -TimeoutSec 10 -Method HEAD -UseBasicParsing",
            "        # This will only execute if the Invoke-WebRequest is successful.",
            "        $StatusCode = $Response.StatusCode",
            "    } catch {",
            "        $StatusCode = $_.Exception.Response.StatusCode.value__",
            "        # If no return code assume the response failed and set to -1",
            "        if ($StatusCode -eq $null) {",
            "            $StatusCode = -1",
            "        }",
            "    }",
            "    return $StatusCode",
            "}",
            "",
            "function Test-Success {",
            "    [CmdletBinding()]",
            "        param (",
            "            [Parameter(Mandatory,",
            "                   ValueFromPipeline)]",
            "            [int]$status",
            "        )",
            "    if ($status -gt 0){",
            "        return \"success\"",
            "    }",
            "    return \"failed\"",
            "}",
            "",
            "$LogsStatus=Check-Endpoint $LogsEndpoint | Test-Success",
            "$CloudWatchStatus=Check-Endpoint $CloudWatchEndpoint | Test-Success",
            "$Ec2Status=''",
            "if ($UsesEc2Endpoint -eq \"true\") {",
            "    $Ec2Status=Check-Endpoint $Ec2Endpoint | Test-Success",
            "} else {",
            "    $Ec2Status=\"not_run\"",
            "}",
            "",
            "Write-Host \"{`n  \"\"logs\"\":\"\"${LogsStatus}\"\",`n  \"\"monitoring\"\":\"\"${CloudWatchStatus}\"\",`n  \"\"ec2\"\":\"\"${Ec2Status}\"\"`n}\""
          ]
        }
      },
      "description": "Check if the instance can reach the required endpoints on Windows OSs.",
      "nextStep": "branchOnRunVpcReachabilityAnalyzer",
      "onFailure": "step:outputFindings",
      "isCritical": false
    },
    {
      "name": "branchOnRunVpcReachabilityAnalyzer",
      "action": "aws:branch",
      "inputs": {
        "Default": "outputFindings",
        "Choices": [
          {
            "And": [
              {
                "Variable": "{{ RunVpcReachabilityAnalyzer}}",
                "BooleanEquals": true
              },
              {
                "Variable": "{{ checkEndpointReachabilityWindows.Output }}",
                "Contains": "failed"
              }
            ],
            "NextStep": "generateEndpoints"
          },
          {
            "And": [
              {
                "Variable": "{{ RunVpcReachabilityAnalyzer}}",
                "BooleanEquals": true
              },
              {
                "Variable": "{{ checkEndpointReachability.Output }}",
                "Contains": "failed"
              }
            ],
            "NextStep": "generateEndpoints"
          },
          {
            "And": [
              {
                "Variable": "{{ RunVpcReachabilityAnalyzer}}",
                "BooleanEquals": true
              },
              {
                "Not": {
                  "Variable": "{{ checkEndpointReachability.Status }}",
                  "StringEquals": "Success"
                }
              },
              {
                "Not": {
                  "Variable": "{{ checkEndpointReachabilityWindows.Status }}",
                  "StringEquals": "Success"
                }
              }
            ],
            "NextStep": "generateEndpoints"
          }
        ]
      },
      "description": "Branches the automation to run a specific log collection/analysis command based on the OS.",
      "onFailure": "step:outputFindings",
      "isCritical": true
    },
    {
      "name": "generateEndpoints",
      "action": "aws:executeScript",
      "inputs": {
        "Runtime": "python3.8",
        "Handler": "generate_endpoints.script_handler",
        "InputPayload": {
          "CheckEC2Endpoint": "{{ CheckEC2Endpoint }}",
          "EndpointConnectionResults": "{{ checkEndpointReachability.Output }}",
          "EndpointConnectionResultsWindows": "{{ checkEndpointReachabilityWindows.Output }}"
        },
        "Attachment": "attachment.zip"
      },
      "outputs": [
        {
          "Name": "Endpoints",
          "Selector": "$.Payload.Endpoints",
          "Type": "StringList"
        },
        {
          "Name": "Domain",
          "Selector": "$.Payload.Domain",
          "Type": "String"
        }
      ],
      "description": "Generates an endpoint to check from the extended check failures and the value of 'CheckEC2Endpoint'",
      "nextStep": "analyzeAwsEndpointReachabilityFromEC2",
      "onFailure": "step:outputFindings",
      "isCritical": true
    },
    {
      "name": "analyzeAwsEndpointReachabilityFromEC2",
      "action": "aws:executeAutomation",
      "timeoutSeconds": 3600,
      "inputs": {
        "DocumentName": "AWSSupport-AnalyzeAWSEndpointReachabilityFromEC2",
        "MaxErrors": "100%",
        "TargetParameterName": "ServiceEndpoint",
        "Targets": [
          {
            "Key": "ParameterValues",
            "Values": "{{ generateEndpoints.Endpoints }}"
          }
        ],
        "RuntimeParameters": {
          "Source": "{{ InstanceId }}",
          "RetainVpcReachabilityAnalysis": "{{ RetainVpcReachabilityAnalysis }}",
          "AutomationAssumeRole": "{{ AutomationAssumeRole }}"
        }
      },
      "description": "Calls the automation runbook, `AWSSupport-AnalyzeAWSEndpointReachabilityFromEC2` to check the reachability of the selected instance to the required endpoints.",
      "nextStep": "outputFindings",
      "onFailure": "step:outputFindings",
      "isCritical": false
    },
    {
      "name": "outputFindings",
      "action": "aws:executeScript",
      "inputs": {
        "Runtime": "python3.8",
        "Handler": "output_findings.script_handler",
        "InputPayload": {
          "InstanceId": "{{ InstanceId }}"
        },
        "Attachment": "attachment.zip"
      },
      "outputs": [
        {
          "Name": "Results",
          "Selector": "$.Payload.Output",
          "Type": "String"
        }
      ],
      "description": "Output results of the automation execution steps.",
      "onFailure": "Abort",
      "isCritical": true,
      "isEnd": true
    }
  ],
  "outputs": [
    "outputFindings.Results"
  ],
  "files": {
    "attachment.zip": {
      "checksums": {
        "sha256": "e663fd7f234e1bc5dbf75e3d61f2e1779d1d78ba639ebc895cbc5cbfbab1d3b6"
      }
    }
  }
}
