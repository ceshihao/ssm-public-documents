{
  "description": "The **AWSSupport-ConnectivityTroubleshooter** runbook helps to troubleshoot network connectivity between two resources using their IP addresses as input. This document supports both IPv4 and IPv6 addresses and provides comprehensive analysis of AWS networking components including Amazon Virtual Private Cloud (Amazon VPC), subnets, security groups, NACLs, route tables, and gateways (Internet Gateway, NAT Gateway, Egress-Only Internet Gateway, and VPC Peering).",
  "schemaVersion": "0.3",
  "assumeRole": "{{ AutomationAssumeRole }}",
  "parameters": {
    "AutomationAssumeRole": {
      "type": "AWS::IAM::Role::Arn",
      "description": "(Optional) The Amazon Resource Name (ARN) of the AWS Identity and Access Management (IAM) role that allows Systems Manager Automation to perform the actions on your behalf. If no role is specified, Systems Manager Automation uses the permissions of the user that starts this runbook.",
      "default": ""
    },
    "SourceIP": {
      "type": "String",
      "description": "(Required) Private IPv4 address or IPv6 address of an Amazon VPC resource.",
      "allowedPattern": "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$|^::$|^::(?:[0-9a-fA-F]{1,4}(?::|$)){1,7}|^(?:[0-9a-fA-F]{1,4}:){1,7}:$|^(?:[0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}$|^(?:[0-9a-fA-F]{1,4}:){1,5}(?::[0-9a-fA-F]{1,4}){1,2}$|^(?:[0-9a-fA-F]{1,4}:){1,4}(?::[0-9a-fA-F]{1,4}){1,3}$|^(?:[0-9a-fA-F]{1,4}:){1,3}(?::[0-9a-fA-F]{1,4}){1,4}$|^(?:[0-9a-fA-F]{1,4}:){1,2}(?::[0-9a-fA-F]{1,4}){1,5}$|^[0-9a-fA-F]{1,4}:(?::[0-9a-fA-F]{1,4}){1,6}$|^(?:[0-9a-fA-F]{1,4}:){1,7}:$"
    },
    "DestinationIP": {
      "type": "String",
      "description": "(Required) IPv4 or IPv6 address of the destination resource.",
      "allowedPattern": "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$|^::$|^::(?:[0-9a-fA-F]{1,4}(?::|$)){1,7}|^(?:[0-9a-fA-F]{1,4}:){1,7}:$|^(?:[0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}$|^(?:[0-9a-fA-F]{1,4}:){1,5}(?::[0-9a-fA-F]{1,4}){1,2}$|^(?:[0-9a-fA-F]{1,4}:){1,4}(?::[0-9a-fA-F]{1,4}){1,3}$|^(?:[0-9a-fA-F]{1,4}:){1,3}(?::[0-9a-fA-F]{1,4}){1,4}$|^(?:[0-9a-fA-F]{1,4}:){1,2}(?::[0-9a-fA-F]{1,4}){1,5}$|^[0-9a-fA-F]{1,4}:(?::[0-9a-fA-F]{1,4}){1,6}$|^(?:[0-9a-fA-F]{1,4}:){1,7}:$"
    },
    "DestinationPort": {
      "type": "String",
      "description": "(Required) Destination Server port to which the source is trying to connect. For e.g 22 for SSH, 80 for HTTP, 443 for HTTPS, 3389 for RDP.",
      "allowedPattern": "^(6553[0-5]|655[0-2]\\d|65[0-4]\\d\\d|6[0-4]\\d{3}|[1-5]\\d{4}|[1-9]\\d{0,3}|0)$"
    },
    "SourceVpc": {
      "type": "String",
      "description": "(Optional) VPC ID of the source Amazon VPC.",
      "allowedPattern": "^$|^(?:vpc-[0-9a-f]{8}|vpc-[0-9a-f]{17}|)$",
      "default": ""
    },
    "DestinationVpc": {
      "type": "String",
      "description": "(Optional) VPC ID of the destination Amazon VPC.",
      "allowedPattern": "^$|^(?:vpc-[0-9a-f]{8}|vpc-[0-9a-f]{17}|)$",
      "default": ""
    },
    "SourcePortRange": {
      "type": "String",
      "description": "(Optional) Source port range used by the source resource. For e.g. if the source port is fixed- 123-123 or if source ports uses a defined range- 32000-65000.",
      "allowedPattern": "^(6553[0-5]|655[0-2]\\d|65[0-4]\\d\\d|6[0-4]\\d{3}|[1-5]\\d{4}|[1-9]\\d{0,3}|0)-(6553[0-5]|655[0-2]\\d|65[0-4]\\d\\d|6[0-4]\\d{3}|[1-5]\\d{4}|[1-9]\\d{0,3}|0)$",
      "default": "0-65535"
    }
  },
  "mainSteps": [
    {
      "name": "getSourceDetails",
      "action": "aws:executeScript",
      "description": "Retrieves network interface details, security groups, subnet ID, VPC ID, and route table information for the source IP address.",
      "inputs": {
        "InputPayload": {
          "SourceVpc": "{{SourceVpc}}",
          "SourceIP": "{{SourceIP}}",
          "DestinationIP": "{{DestinationIP}}"
        },
        "Handler": "get_source_details.get_source_details",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        },
        {
          "Name": "SourceNetworkInterface",
          "Selector": "$.Payload.SourceNetworkInterface",
          "Type": "StringMap"
        },
        {
          "Name": "SourceSecurityGroups",
          "Selector": "$.Payload.SourceSecurityGroups",
          "Type": "StringList"
        },
        {
          "Name": "SourceSubnetId",
          "Selector": "$.Payload.SourceSubnetId",
          "Type": "String"
        },
        {
          "Name": "SourceVpcId",
          "Type": "String",
          "Selector": "$.Payload.SourceVpcId"
        },
        {
          "Name": "Routes",
          "Selector": "$.Payload.Routes",
          "Type": "MapList"
        }
      ],
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Abort",
      "nextStep": "getNextHop"
    },
    {
      "name": "getNextHop",
      "action": "aws:executeScript",
      "description": "Determines the next hop in the network path from the source to the destination IP address based on the route table information.",
      "inputs": {
        "InputPayload": {
          "Routes": "{{getSourceDetails.Routes}}",
          "DestinationIP": "{{DestinationIP}}"
        },
        "Handler": "get_next_hop.get_next_hop",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        },
        {
          "Name": "NextHop",
          "Selector": "$.Payload.NextHop",
          "Type": "String"
        }
      ],
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Abort",
      "nextStep": "branchOnNextHopType"
    },
    {
      "name": "branchOnNextHopType",
      "action": "aws:branch",
      "description": "Branches the workflow based on the type of next hop identified in the route table (local, peering connection, Amazon NAT Gateway, or Amazon Internet Gateway).",
      "inputs": {
        "Choices": [
          {
            "NextStep": "checkLocalDestination",
            "Variable": "{{getNextHop.NextHop}}",
            "StringEquals": "local"
          },
          {
            "NextStep": "checkPeeringDestination",
            "Variable": "{{getNextHop.NextHop}}",
            "StartsWith": "pcx-"
          },
          {
            "NextStep": "checkNATGatewayDestination",
            "Variable": "{{getNextHop.NextHop}}",
            "StartsWith": "nat-"
          },
          {
            "NextStep": "checkInternetGatewayDestination",
            "Variable": "{{getNextHop.NextHop}}",
            "StartsWith": "igw-"
          },
          {
            "NextStep": "checkEgressOnlyInternetGatewayDestination",
            "Variable": "{{getNextHop.NextHop}}",
            "StartsWith": "eigw-"
          }
        ],
        "Default": "hopTypeNotSupported"
      },
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Abort",
      "isEnd": true
    },
    {
      "name": "checkLocalDestination",
      "action": "aws:executeScript",
      "description": "Retrieves network interface details for the destination IP address when it is in the same Amazon VPC as the source.",
      "outputs": [
        {
          "Name": "DestinationSecurityGroups",
          "Selector": "$.Payload.SecurityGroups",
          "Type": "StringList"
        },
        {
          "Name": "DestinationSubnetId",
          "Selector": "$.Payload.SubnetId",
          "Type": "String"
        },
        {
          "Name": "DestinationVpcId",
          "Selector": "$.Payload.VpcId",
          "Type": "String"
        },
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        }
      ],
      "inputs": {
        "InputPayload": {
          "DestinationIP": "{{DestinationIP}}",
          "DestinationVpc": "{{DestinationVpc}}"
        },
        "Handler": "local_destination.local_destination",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Abort",
      "nextStep": "evaluateSecurityGroups"
    },
    {
      "name": "evaluateSecurityGroups",
      "action": "aws:executeScript",
      "description": "Evaluates the security group rules to determine if they allow the required traffic between source and destination.",
      "inputs": {
        "InputPayload": {
          "SrcSecurityGroups": "{{getSourceDetails.SourceSecurityGroups}}",
          "DstSecurityGroups": "{{checkLocalDestination.DestinationSecurityGroups}}",
          "SourceIP": "{{SourceIP}}",
          "DestinationIP": "{{DestinationIP}}",
          "DestinationPort": "{{DestinationPort}}"
        },
        "Handler": "eval_security_groups.eval_security_groups",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        }
      ],
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Continue",
      "nextStep": "evaluateNACLs"
    },
    {
      "name": "evaluateNACLs",
      "action": "aws:executeScript",
      "description": "Evaluates the Network ACL rules to determine if they allow the required traffic between source and destination subnets.",
      "inputs": {
        "InputPayload": {
          "SourceIP": "{{SourceIP}}",
          "DestinationIP": "{{DestinationIP}}",
          "DestinationPort": "{{DestinationPort}}",
          "SrcSubnetId": "{{getSourceDetails.SourceSubnetId}}",
          "DstSubnetId": "{{checkLocalDestination.DestinationSubnetId}}",
          "SourcePortRange": "{{SourcePortRange}}"
        },
        "Handler": "eval_nacls.eval_nacls",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        }
      ],
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Continue",
      "nextStep": "generateReport"
    },
    {
      "name": "checkInternetGatewayDestination",
      "action": "aws:executeScript",
      "description": "Evaluates connectivity when the destination is accessed through an Amazon Internet Gateway, checking if the source has a public IP.",
      "inputs": {
        "InputPayload": {
          "SrcNetworkInterface": "{{getSourceDetails.SourceNetworkInterface}}",
          "SourceIP": "{{SourceIP}}"
        },
        "Handler": "igw_destination.igw_destination",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        }
      ],
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Continue",
      "nextStep": "evaluateSourceSecurityGroups"
    },
    {
      "name": "evaluateSourceSecurityGroups",
      "action": "aws:executeScript",
      "description": "Evaluates the source security group egress rules to determine if outbound traffic to the destination is allowed.",
      "inputs": {
        "InputPayload": {
          "SrcSecurityGroups": "{{getSourceDetails.SourceSecurityGroups}}",
          "DestinationIP": "{{DestinationIP}}",
          "DestinationPort": "{{DestinationPort}}"
        },
        "Handler": "eval_src_security_groups.eval_src_security_groups",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        }
      ],
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Continue",
      "nextStep": "evaluateSourceNACLs"
    },
    {
      "name": "evaluateSourceNACLs",
      "action": "aws:executeScript",
      "description": "Evaluates the source Network ACL rules to determine if outbound traffic to the destination is allowed.",
      "inputs": {
        "InputPayload": {
          "SrcSubnetId": "{{getSourceDetails.SourceSubnetId}}",
          "DestinationIP": "{{DestinationIP}}",
          "DestinationPort": "{{DestinationPort}}",
          "SourcePortRange": "{{SourcePortRange}}"
        },
        "Handler": "eval_src_nacls.eval_src_nacls",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        }
      ],
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Continue",
      "nextStep": "generateReport"
    },
    {
      "name": "checkEgressOnlyInternetGatewayDestination",
      "action": "aws:executeScript",
      "description": "Evaluates connectivity when the destination is accessed through an Amazon VPC Egress-only Internet Gateway, checking if the source has a public IP and provided IP is IPv6.",
      "inputs": {
        "InputPayload": {
          "SrcNetworkInterface": "{{getSourceDetails.SourceNetworkInterface}}",
          "SourceIP": "{{SourceIP}}",
          "SourceNextHop": "{{getNextHop.NextHop}}"
        },
        "Handler": "eigw_destination.eigw_destination",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        }
      ],
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Continue",
      "nextStep": "evaluateSourceSecurityGroups"
    },
    {
      "name": "checkNATGatewayDestination",
      "action": "aws:executeAwsApi",
      "description": "Retrieves details about the Amazon NAT Gateway when it is the next hop in the route to the destination.",
      "inputs": {
        "Service": "ec2",
        "Api": "DescribeNatGateways",
        "Filters": [
          {
            "Name": "nat-gateway-id",
            "Values": [
              "{{getNextHop.NextHop}}"
            ]
          }
        ]
      },
      "outputs": [
        {
          "Name": "NATSubnetId",
          "Selector": "$.NatGateways[0]['SubnetId']",
          "Type": "String"
        },
        {
          "Name": "NATVpcId",
          "Selector": "$.NatGateways[0]['VpcId']",
          "Type": "String"
        }
      ],
      "nextStep": "evaluateNATNACLs",
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Continue"
    },
    {
      "name": "evaluateNATNACLs",
      "action": "aws:executeScript",
      "description": "Evaluates the Network ACL rules for the Amazon NAT Gateway subnet to determine if traffic to the destination is allowed.",
      "inputs": {
        "InputPayload": {
          "SourceIP": "{{SourceIP}}",
          "DestinationIP": "{{DestinationIP}}",
          "DestinationPort": "{{DestinationPort}}",
          "NatSubnetId": "{{checkNATGatewayDestination.NATSubnetId}}",
          "SourcePortRange": "{{SourcePortRange}}"
        },
        "Handler": "eval_nat_nacls.eval_nat_nacls",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        }
      ],
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Continue",
      "nextStep": "getNATRouteDetails"
    },
    {
      "name": "getNATRouteDetails",
      "action": "aws:executeScript",
      "description": "Retrieves the route table details for the Amazon NAT Gateway subnet to determine the next hop for outbound traffic.",
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        },
        {
          "Name": "NATRoutes",
          "Selector": "$.Payload.NatRoutes",
          "Type": "MapList"
        }
      ],
      "inputs": {
        "InputPayload": {
          "NatSubnetId": "{{checkNATGatewayDestination.NATSubnetId}}",
          "NatVpcId": "{{checkNATGatewayDestination.NATVpcId}}"
        },
        "Handler": "get_nat_route_details.get_nat_route_details",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Continue",
      "nextStep": "getNATNextHop"
    },
    {
      "name": "getNATNextHop",
      "action": "aws:executeScript",
      "description": "Determines the next hop from the Amazon NAT Gateway to the destination IP address based on the route table information.",
      "inputs": {
        "InputPayload": {
          "NatRoutes": "{{getNATRouteDetails.NATRoutes}}",
          "DestinationIP": "{{DestinationIP}}",
          "NatSubnetId": "{{checkNATGatewayDestination.NATSubnetId}}",
          "SrcSubnetId": "{{getSourceDetails.SourceSubnetId}}"
        },
        "Handler": "get_nat_next_hop.get_nat_next_hop",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        },
        {
          "Name": "NextHop",
          "Selector": "$.Payload.NextHop",
          "Type": "String"
        }
      ],
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Continue",
      "nextStep": "branchOnNATNextHop"
    },
    {
      "name": "branchOnNATNextHop",
      "action": "aws:branch",
      "description": "Branches based on the next hop type for the Amazon NAT Gateway.",
      "inputs": {
        "Choices": [
          {
            "NextStep": "checkInternetGatewayDestination",
            "Variable": "{{getNATNextHop.NextHop}}",
            "StartsWith": "igw-"
          }
        ],
        "Default": "generateReport"
      },
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Abort",
      "isEnd": true
    },
    {
      "name": "checkPeeringDestination",
      "action": "aws:executeScript",
      "description": "Retrieves details about the Amazon VPC peering connection when it is the next hop in the route to the destination.",
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        },
        {
          "Name": "PeeringConnectionStatus",
          "Selector": "$.Payload.PeeringConnectionStatus",
          "Type": "Boolean"
        }
      ],
      "inputs": {
        "InputPayload": {
          "ConnectionId": "{{getNextHop.NextHop}}",
          "DestinationVpc": "{{DestinationVpc}}"
        },
        "Handler": "peering_destination.peering_destination",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Continue",
      "nextStep": "branchOnVpcPeeringConnection"
    },
    {
      "name": "branchOnVpcPeeringConnection",
      "action": "aws:branch",
      "description": "Branches based on the VPC peering connection status.",
      "inputs": {
        "Choices": [
          {
            "NextStep": "getDestinationPeeringRouteDetails",
            "Variable": "{{checkPeeringDestination.PeeringConnectionStatus}}",
            "BooleanEquals": true
          }
        ],
        "Default": "generateReport"
      },
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Abort",
      "isEnd": true
    },
    {
      "name": "getDestinationPeeringRouteDetails",
      "action": "aws:executeScript",
      "description": "Retrieves the route table details for the destination subnet in the peered VPC.",
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        },
        {
          "Name": "Routes",
          "Selector": "$.Payload.PeerRoutes",
          "Type": "MapList"
        }
      ],
      "inputs": {
        "InputPayload": {
          "DestinationIP": "{{DestinationIP}}"
        },
        "Handler": "get_dst_peer_route_details.get_dst_peer_route_details",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Continue",
      "nextStep": "evaluatePeeringRouteTable"
    },
    {
      "name": "evaluatePeeringRouteTable",
      "action": "aws:executeScript",
      "description": "Evaluates the route table in the peered VPC to ensure it has a route back to the source IP address via the peering connection.",
      "inputs": {
        "InputPayload": {
          "Routes": "{{getDestinationPeeringRouteDetails.Routes}}",
          "SourceIP": "{{SourceIP}}",
          "PeeringId": "{{getNextHop.NextHop}}"
        },
        "Handler": "eval_peer_route_table.eval_peer_route_table",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        },
        {
          "Name": "PeeringNextHop",
          "Selector": "$.Payload.NextHop",
          "Type": "String"
        }
      ],
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Continue",
      "nextStep": "checkLocalDestination"
    },
    {
      "name": "hopTypeNotSupported",
      "action": "aws:executeScript",
      "description": "Handles cases where the next hop type in the route table is not supported by this troubleshooter.",
      "inputs": {
        "InputPayload": {
          "NextHop": "{{getNextHop.NextHop}}"
        },
        "Handler": "hop_type_not_supported.hop_type_not_supported",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "String"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "String"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        },
        {
          "Name": "Status",
          "Selector": "$.Payload.Status",
          "Type": "String"
        }
      ],
      "isCritical": true,
      "timeoutSeconds": 600,
      "maxAttempts": 1,
      "onFailure": "Continue",
      "nextStep": "generateReport"
    },
    {
      "name": "generateReport",
      "action": "aws:executeScript",
      "description": "Generates the connectivity troubleshooting report.",
      "inputs": {
        "InputPayload": {
          "SourceIP": "{{SourceIP}}",
          "DestinationIP": "{{DestinationIP}}",
          "DestinationPort": "{{DestinationPort}}",
          "SourceVpc": "{{SourceVpc}}",
          "DestinationVpc": "{{DestinationVpc}}",
          "SourcePortRange": "{{SourcePortRange}}",
          "SrcNetworkInterface": "{{getSourceDetails.SourceNetworkInterface}}",
          "SrcSecurityGroups": "{{getSourceDetails.SourceSecurityGroups}}",
          "SrcSubnetId": "{{getSourceDetails.SourceSubnetId}}",
          "SrcVpcId": "{{getSourceDetails.SourceVpcId}}",
          "Routes": "{{getSourceDetails.Routes}}",
          "SourceDetailsReport": {
            "Report": "{{getSourceDetails.Report}}",
            "Summary": "{{getSourceDetails.Summary}}",
            "IssuesFound": "{{getSourceDetails.IssuesFound}}",
            "IssueCount": "{{getSourceDetails.IssueCount}}",
            "Status": "{{getSourceDetails.Status}}"
          },
          "NextHopReport": {
            "Report": "{{getNextHop.Report}}",
            "Summary": "{{getNextHop.Summary}}",
            "IssuesFound": "{{getNextHop.IssuesFound}}",
            "IssueCount": "{{getNextHop.IssueCount}}",
            "Status": "{{getNextHop.Status}}"
          },
          "SecurityGroupEvaluation": {
            "Report": "{{evaluateSecurityGroups.Report}}",
            "Summary": "{{evaluateSecurityGroups.Summary}}",
            "IssuesFound": "{{evaluateSecurityGroups.IssuesFound}}",
            "IssueCount": "{{evaluateSecurityGroups.IssueCount}}",
            "Status": "{{evaluateSecurityGroups.Status}}"
          },
          "NACLEvaluation": {
            "Report": "{{evaluateNACLs.Report}}",
            "Summary": "{{evaluateNACLs.Summary}}",
            "IssuesFound": "{{evaluateNACLs.IssuesFound}}",
            "IssueCount": "{{evaluateNACLs.IssueCount}}",
            "Status": "{{evaluateNACLs.Status}}"
          },
          "CheckInternetGatewayDestinationReport": {
            "Report": "{{checkInternetGatewayDestination.Report}}",
            "Summary": "{{checkInternetGatewayDestination.Summary}}",
            "IssuesFound": "{{checkInternetGatewayDestination.IssuesFound}}",
            "IssueCount": "{{checkInternetGatewayDestination.IssueCount}}",
            "Status": "{{checkInternetGatewayDestination.Status}}"
          },
          "SourceSecurityGroupsReport": {
            "Report": "{{evaluateSourceSecurityGroups.Report}}",
            "Summary": "{{evaluateSourceSecurityGroups.Summary}}",
            "IssuesFound": "{{evaluateSourceSecurityGroups.IssuesFound}}",
            "IssueCount": "{{evaluateSourceSecurityGroups.IssueCount}}",
            "Status": "{{evaluateSourceSecurityGroups.Status}}"
          },
          "SourceNACLsReport": {
            "Report": "{{evaluateSourceNACLs.Report}}",
            "Summary": "{{evaluateSourceNACLs.Summary}}",
            "IssuesFound": "{{evaluateSourceNACLs.IssuesFound}}",
            "IssueCount": "{{evaluateSourceNACLs.IssueCount}}",
            "Status": "{{evaluateSourceNACLs.Status}}"
          },
          "NATNACLsReport": {
            "Report": "{{evaluateNATNACLs.Report}}",
            "Summary": "{{evaluateNATNACLs.Summary}}",
            "IssuesFound": "{{evaluateNATNACLs.IssuesFound}}",
            "IssueCount": "{{evaluateNATNACLs.IssueCount}}",
            "Status": "{{evaluateNATNACLs.Status}}"
          },
          "NATNextHopReport": {
            "Report": "{{getNATNextHop.Report}}",
            "Summary": "{{getNATNextHop.Summary}}",
            "IssuesFound": "{{getNATNextHop.IssuesFound}}",
            "IssueCount": "{{getNATNextHop.IssueCount}}",
            "Status": "{{getNATNextHop.Status}}"
          },
          "CheckLocalDestinationReport": {
            "Report": "{{checkLocalDestination.Report}}",
            "Summary": "{{checkLocalDestination.Summary}}",
            "IssuesFound": "{{checkLocalDestination.IssuesFound}}",
            "IssueCount": "{{checkLocalDestination.IssueCount}}",
            "Status": "{{checkLocalDestination.Status}}"
          },
          "CheckPeeringDestinationReport": {
            "Report": "{{checkPeeringDestination.Report}}",
            "Summary": "{{checkPeeringDestination.Summary}}",
            "IssuesFound": "{{checkPeeringDestination.IssuesFound}}",
            "IssueCount": "{{checkPeeringDestination.IssueCount}}",
            "Status": "{{checkPeeringDestination.Status}}"
          },
          "EvaluatePeeringRouteTableReport": {
            "Report": "{{evaluatePeeringRouteTable.Report}}",
            "Summary": "{{evaluatePeeringRouteTable.Summary}}",
            "IssuesFound": "{{evaluatePeeringRouteTable.IssuesFound}}",
            "IssueCount": "{{evaluatePeeringRouteTable.IssueCount}}",
            "Status": "{{evaluatePeeringRouteTable.Status}}"
          },
          "CheckEgressOnlyInternetGatewayDestinationReport": {
            "Report": "{{checkEgressOnlyInternetGatewayDestination.Report}}",
            "Summary": "{{checkEgressOnlyInternetGatewayDestination.Summary}}",
            "IssuesFound": "{{checkEgressOnlyInternetGatewayDestination.IssuesFound}}",
            "IssueCount": "{{checkEgressOnlyInternetGatewayDestination.IssueCount}}",
            "Status": "{{checkEgressOnlyInternetGatewayDestination.Status}}"
          },
          "HopTypeNotSupportedReport": {
            "Report": "{{hopTypeNotSupported.Report}}",
            "Summary": "{{hopTypeNotSupported.Summary}}",
            "IssuesFound": "{{hopTypeNotSupported.IssuesFound}}",
            "IssueCount": "{{hopTypeNotSupported.IssueCount}}",
            "Status": "{{hopTypeNotSupported.Status}}"
          }
        },
        "Handler": "generate_report.generate_report",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload.Report",
          "Type": "StringMap"
        },
        {
          "Name": "Summary",
          "Selector": "$.Payload.Summary",
          "Type": "StringMap"
        },
        {
          "Name": "IssuesFound",
          "Selector": "$.Payload.IssuesFound",
          "Type": "Boolean"
        },
        {
          "Name": "IssueCount",
          "Selector": "$.Payload.IssueCount",
          "Type": "String"
        }
      ],
      "isCritical": true,
      "timeoutSeconds": 60,
      "maxAttempts": 1,
      "onFailure": "Abort",
      "isEnd": true
    }
  ],
  "outputs": [
    "generateReport.Report",
    "generateReport.Summary",
    "generateReport.IssuesFound",
    "generateReport.IssueCount"
  ],
  "files": {
    "artifact.zip": {
      "checksums": {
        "SHA256": "6000557df47e2e4f8fe166c766d2ccbdc81de2c39cf6f178492ba1e10004f5a1"
      }
    }
  }
}
