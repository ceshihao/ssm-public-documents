{
  "schemaVersion": "2.2",
  "description": "Detect the workload that installed on the host",
  "parameters": {},
  "mainSteps": [
    {
      "name": "WINDOWS",
      "action": "aws:runPowerShellScript",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Windows"
        ]
      },
      "inputs": {
        "runCommand": [
          "Function getIISLogPath{",
          "foreach($WebSite in $(get-website)){",
          "return \"$($Website.logFile.directory)\\**\".replace(\"%SystemDrive%\",$env:SystemDrive)",
          "}",
          "}",
          "Function getSQLServerLogPath{",
          "$instanceName = Get-ItemProperty -Path HKLM:\"SOFTWARE\\Microsoft\\Microsoft SQL Server\\Instance Names\\SQL\" -ErrorAction SilentlyContinue | Get-Member -MemberType NoteProperty | Select -ExpandProperty Name | Where-Object { (-not($_ -match 'PSChildName|PSDrive|PSParentPath|PSPath|PSProvider')) }",
          "$directoryName = (Get-ItemProperty -Path HKLM:\"SOFTWARE\\Microsoft\\Microsoft SQL Server\\Instance Names\\SQL\").$instanceName",
          "return \"C:\\Program Files\\Microsoft SQL Server\\%DIRECTORY%\\MSSQL\\Log\\ERRORLOG\".replace(\"%DIRECTORY%\", $directoryName)",
          "}",
          "Function getPostgreLogPath{",
          "$dataDirectory = (Get-ItemProperty -Path HKLM:\"SOFTWARE\\PostgreSQL\\Services\\*\").\"Data Directory\"",
          "return \"$dataDirectory\\log\\*.log\"",
          "}",
          "Function checkIISWorkload{",
          "$workload = Get-WindowsFeature Web*Server* | Where-Object {$_.InstallState -eq 'Installed'} | foreach {$_.DisplayName}",
          "if($workload){",
          "$logPath = getIISLogPath",
          "return $jsonResult = @{",
          "DOT_NET_WEB_TIER= @{",
          "Priority= \"4\"",
          "LogPath= \"$logPath\"",
          "}",
          "}",
          "}",
          "}",
          "Function checkMySQLWorkload{",
          "$mysql = net start | Out-String -stream | Select-String \"MySQL\"",
          "if($mysql){",
          "return $jsonResult = @{",
          "MYSQL= @{",
          "Priority= \"3\"",
          "LogPath= \"\"",
          "}",
          "}",
          "}else{",
          "return @{}",
          "}",
          "}",
          "Function checkSQLServerWorkload{",
          "$inst = (get-itemproperty \"HKLM:\\SOFTWARE\\Microsoft\\Microsoft SQL Server\").InstalledInstances",
          "if($inst){",
          "foreach ($i in $inst) {",
          "$p = (Get-ItemProperty \"HKLM:\\SOFTWARE\\Microsoft\\Microsoft SQL Server\\Instance Names\\SQL\").$i",
          "$v = (Get-ItemProperty \"HKLM:\\SOFTWARE\\Microsoft\\Microsoft SQL Server\\\\$p\\Setup\").Version",
          "if ($v) {",
          "$logPath = getSQLServerLogPath",
          "return $jsonResult = @{",
          "SQL_SERVER= @{",
          "Priority= \"3\"",
          "LogPath= \"$logPath\"",
          "}",
          "}",
          "}",
          "}",
          "}else{",
          "return @{}",
          "}",
          "}",
          "Function checkPostgreWorkload{",
          "$version = (Get-ItemProperty -Path HKLM:\"SOFTWARE\\PostgreSQL\\Services\\*\").\"Product Code\"",
          "if($version){",
          "$logPath = getPostgreLogPath",
          "return $jsonResult = @{",
          "POSTGRESQL= @{",
          "Priority= \"3\"",
          "LogPath= \"$logPath\"",
          "}",
          "}",
          "}",
          "}",
          "Function checkDotNetWorkload{",
          "$dotnet = Get-WindowsFeature NET*Framework* | Where-Object {$_.InstallState -eq 'Installed'} | foreach {$_.DisplayName}",
          "if($dotnet){",
          "return $jsonResult = @{",
          "DOT_NET_CORE= @{",
          "Priority= \"2\"",
          "LogPath= \"\"",
          "}",
          "}",
          "}",
          "}",
          "Function checkJavaWorkload{",
          "try{",
          "$version = (Get-ItemProperty -Path HKLM:\"SOFTWARE\\JavaSoft\\JDK\").\"CurrentVersion\"",
          "} catch {",
          "$version = (Get-ItemProperty -Path HKLM:\"SOFTWARE\\JavaSoft\\Java Runtime Environment\").\"CurrentVersion\"",
          "}",
          "if($version){",
          "return $jsonResult = @{",
          "JAVA_JMX= @{",
          "Priority= \"2\"",
          "LogPath= \"\"",
          "}",
          "}",
          "}else{",
          "return @{}",
          "}",
          "}",
          "$ErrorActionPreference = 'Stop'",
          "try{",
          "$iis = checkIISWorkload",
          "} Catch {",
          "$iis = @{}",
          "}",
          "try{",
          "$mysql = checkMySQLWorkload",
          "} Catch {",
          "$mysql = @{}",
          "}",
          "try{",
          "$sqlserver = checkSQLServerWorkload",
          "} Catch {",
          "$sqlserver = @{}",
          "}",
          "try{",
          "$postgresql = checkPostgreWorkload",
          "} Catch {",
          "$postgresql = @{}",
          "}",
          "try{",
          "$dotnet = checkDotNetWorkload",
          "} Catch {",
          "$dotnet = @{}",
          "}",
          "try{",
          "$java = checkJavaWorkload",
          "} Catch {",
          "$java = @{}",
          "}",
          "$iis + $mysql + $sqlserver + $postgresql + $dotnet + $java | ConvertTo-Json"
        ]
      }
    },
    {
      "name": "LINUX",
      "action": "aws:runShellScript",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Linux"
        ]
      },
      "inputs": {
        "runCommand": [
          "#!/bin/bash",
          "function getJavaWorkload {",
          "VER=$(java -version 2>&1 | sed -n ';s/.* version \"\\(.*\\)\\.\\(.*\\)\\..*\"/\\1\\2/p;')",
          "if [ ! -z \"$VER\" ]; then",
          "echo $(cat <<EOF",
          "\"JAVA_JMX\": {",
          "\"Priority\": \"2\",",
          "\"LogPath\": \"\"",
          "},",
          "EOF",
          ")",
          "fi",
          "}",
          "function getDotNetWorkload {",
          "VER=$(dotnet --info 2>&1 | sed -n ';s/Version: \\(.*\\)\\..*\\..*/\\1/p;')",
          "if [ ! -z \"$VER\" ]; then",
          "echo $(cat <<EOF",
          "\"DOT_NET_CORE\": {",
          "\"Priority\": \"2\",",
          "\"LogPath\": \"\"",
          "},",
          "EOF",
          ")",
          "fi",
          "}",
          "function getSqlServerWorkload {",
          "STATUS=$(systemctl status mssql-server 2>&1 | sed -n ';s/Active: \\(.*\\)/\\1/p;')",
          "if [ ! -z \"$STATUS\" ]; then",
          "echo $(cat <<EOF",
          "\"SQL_SERVER\": {",
          "\"Priority\": \"3\",",
          "\"LogPath\": \"/var/opt/mssql/log/errorlog\"",
          "},",
          "EOF",
          ")",
          "fi",
          "}",
          "function getMySqlWorkload {",
          "LOC=$(type mysql 2>&1 | sed -n ';s/mysql is \\(.*\\)/\\1/p;')",
          "if [ ! -z \"$LOC\" ]; then",
          "echo $(cat <<EOF",
          "\"MYSQL\": {",
          "\"Priority\": \"3\",",
          "\"LogPath\": \"/var/log/mysql\"",
          "},",
          "EOF",
          ")",
          "fi",
          "}",
          "function getPostgreSqlWorkload {",
          "LOC=$(type psql 2>&1 | sed -n ';s/psql is \\(.*\\)/\\1/p;')",
          "if [ ! -z \"$LOC\" ]; then",
          "echo $(cat <<EOF",
          "\"POSTGRESQL\": {",
          "\"Priority\": \"3\",",
          "\"LogPath\": \"/var/lib/pgsql/data/log\"",
          "},",
          "EOF",
          ")",
          "fi",
          "}",
          "function getSqlServerWorkload {",
          "STATUS=$(systemctl status mssql-server 2>&1 | sed -n ';s/Active: \\(.*\\)/\\1/p;')",
          "if [ ! -z \"$STATUS\" ]; then",
          "echo $(cat <<EOF",
          "\"SQL_SERVER\": {",
          "\"Priority\": \"3\",",
          "\"LogPath\": \"/var/opt/mssql/log/errorlog\"",
          "},",
          "EOF",
          ")",
          "fi",
          "}",
          "echo \"{$(getJavaWorkload)$(getDotNetWorkload)$(getMySqlWorkload)$(getSqlServerWorkload)$(getPostgreSqlWorkload)}\" | sed 's/,\\(.\\)$/\\1/'"
        ]
      }
    }
  ]
}
