{
  "schemaVersion": "2.2",
  "description": "Detect the workload that installed on the host",
  "parameters": {},
  "mainSteps": [
    {
      "name": "WINDOWS",
      "action": "aws:runPowerShellScript",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Windows"
        ]
      },
      "inputs": {
        "runCommand": [
          "Function ConvertTo-Json20 {",
          "[CmdletBinding()]",
          "param(",
          "[Parameter(Mandatory=$True,",
          "ValueFromPipeline=$True)]",
          "$inputObject)",
          "add-type -assembly system.web.extensions;",
          "$serializer=new-object system.web.script.serialization.javascriptSerializer;",
          "return $serializer.Serialize($inputObject)}",
          "Function getIISLogPath{",
          "foreach($WebSite in $(get-website)){",
          "return \"$($Website.logFile.directory)\\**\".replace(\"%SystemDrive%\",$env:SystemDrive)",
          "}",
          "}",
          "Function getSQLServerLogPath{",
          "$instanceName = Get-ItemProperty -Path HKLM:\"SOFTWARE\\Microsoft\\Microsoft SQL Server\\Instance Names\\SQL\" -ErrorAction SilentlyContinue | Get-Member -MemberType NoteProperty | Select -ExpandProperty Name | Where-Object { (-not($_ -match 'PSChildName|PSDrive|PSParentPath|PSPath|PSProvider')) }",
          "$directoryName = (Get-ItemProperty -Path HKLM:\"SOFTWARE\\Microsoft\\Microsoft SQL Server\\Instance Names\\SQL\").$instanceName",
          "return \"C:\\Program Files\\Microsoft SQL Server\\%DIRECTORY%\\MSSQL\\Log\\ERRORLOG\".replace(\"%DIRECTORY%\", $directoryName)",
          "}",
          "Function getPostgreLogPath{",
          "$dataDirectory = (Get-ItemProperty -Path HKLM:\"SOFTWARE\\PostgreSQL\\Services\\*\").\"Data Directory\"",
          "return \"$dataDirectory\\log\\*.log\"",
          "}",
          "Function getOracleLogPath{",
          "$oracle_base = (Get-ItemProperty -Path HKLM:\\SOFTWARE\\ORACLE\\*).ORACLE_BASE",
          "$oracle_sid = (Get-ItemProperty -Path HKLM:\\SOFTWARE\\ORACLE\\*).ORACLE_SID",
          "$path_builder = \"%oracle_base%\\diag\\rdbms\\%sid%\\%sid%\\trace\\alert_%sid%.log\".replace(\"%oracle_base%\",$oracle_base)",
          "$path_builder = $path_builder.replace(\"%sid%\",$oracle_sid)",
          "$alert_path = $path_builder.replace(\" \",\"\")",
          "$lstn_builder = \"%oracle_base%\\diag\\tnslsnr\\**\\**\\trace\\*.log\".replace(\"%oracle_base%\",$oracle_base).replace(\" \", \"\")",
          "$listener_path = (Get-ChildItem $lstn_builder | Select-Object -ExpandProperty Fullname)",
          "$log_paths = @($alert_path, $listener_path)",
          "return $log_paths",
          "}",
          "Function checkADWorkload{",
          "try{",
          "$adPresent = Get-Service | Where-Object {$_.Name -eq 'NTDS' -and $_.Status -eq 'Running'}",
          "if($adPresent){",
          "return $jsonResult = @{",
          "ACTIVE_DIRECTORY= @{",
          "Priority= \"8\"",
          "LogPath= \"\"",
          "}",
          "}",
          "}",
          "}",
          "Catch { ",
          "return @{}",
          "}",
          "return @{}",
          "}",
          "Function checkIISWorkload{",
          "$workload = Get-ItemProperty -Path registry::HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\InetStp\\ | Select-Object",
          "if($workload){",
          "$logPath = getIISLogPath",
          "return $jsonResult = @{",
          "DOT_NET_WEB_TIER= @{",
          "Priority= \"4\"",
          "LogPath= \"$logPath\"",
          "}",
          "}",
          "}",
          "}",
          "Function checkMySQLWorkload{",
          "$mysql = net start | Out-String -stream | Select-String \"MySQL\"",
          "if($mysql){",
          "return $jsonResult = @{",
          "MYSQL= @{",
          "Priority= \"3\"",
          "LogPath= \"\"",
          "}",
          "}",
          "}else{",
          "return @{}",
          "}",
          "}",
          "Function checkSQLServerWorkload{",
          "$inst = (get-itemproperty \"HKLM:\\SOFTWARE\\Microsoft\\Microsoft SQL Server\").InstalledInstances",
          "if($inst){",
          "foreach ($i in $inst) {",
          "$p = (Get-ItemProperty \"HKLM:\\SOFTWARE\\Microsoft\\Microsoft SQL Server\\Instance Names\\SQL\").$i",
          "$v = (Get-ItemProperty \"HKLM:\\SOFTWARE\\Microsoft\\Microsoft SQL Server\\\\$p\\Setup\").Version",
          "if ($v) {",
          "$logPath = getSQLServerLogPath",
          "return $jsonResult = @{",
          "SQL_SERVER= @{",
          "Priority= \"3\"",
          "LogPath= \"$logPath\"",
          "}",
          "}",
          "}",
          "}",
          "}else{",
          "return @{}",
          "}",
          "}",
          "Function checkSQLFCIWorkload{",
          "$inst = (get-itemproperty \"HKLM:\\SOFTWARE\\Microsoft\\Microsoft SQL Server\").InstalledInstances",
          "if($inst){",
          "foreach ($i in $inst) {",
          "$instanceName = (Get-ItemProperty \"HKLM:\\SOFTWARE\\Microsoft\\Microsoft SQL Server\\Instance Names\\SQL\").$i",
          "$clusterExists = Test-Path \"HKLM:\\SOFTWARE\\Microsoft\\Microsoft SQL Server\\\\$instanceName\\Cluster\"",
          "if($clusterExists){",
          "$clusterName = (Get-ItemProperty \"HKLM:\\SOFTWARE\\Microsoft\\Microsoft SQL Server\\\\$instanceName\\Cluster\").ClusterName",
          "$root = (Get-ItemProperty \"HKLM:\\SOFTWARE\\Microsoft\\Microsoft SQL Server\\\\$instanceName\\Setup\").SQLDataRoot",
          "$logPath = $root + \"\\Log\\ERRORLOG\"",
          "$dnsName = $root.split(\"\\\")[2]",
          "return $jsonResult = @{",
          "SQL_SERVER_FAILOVER_CLUSTER_INSTANCE= @{",
          "Priority= \"4\"",
          "ClusterName= \"$clusterName\"",
          "LogPath= \"$logPath\"",
          "DNSName= \"$dnsName\"",
          "}",
          "}",
          "}",
          "}",
          "return @{}",
          "}else{",
          "return @{}",
          "}",
          "}",
          "Function checkPostgreWorkload{",
          "$version = (Get-ItemProperty -Path HKLM:\"SOFTWARE\\PostgreSQL\\Services\\*\").\"Product Code\"",
          "if($version){",
          "$logPath = getPostgreLogPath",
          "return $jsonResult = @{",
          "POSTGRESQL= @{",
          "Priority= \"3\"",
          "LogPath= \"$logPath\"",
          "}",
          "}",
          "}else{",
          "return @{}",
          "}",
          "}",
          "Function checkOracleWorkload {",
          "$ora = (Get-ChildItem -Path \"C:\\Program Files\\Oracle\" -Filter inventory.xml -Recurse -ErrorAction SilentlyContinue -Force | Select-Object -ExpandProperty FullName)",
          "$version = (Get-Content $ora ) -match \".*OraDB.*\"",
          "if($version){",
          "$log_path = getOracleLogPath",
          "return $jsonResult = @{",
          "ORACLE= @{",
          "Priority= \"3\"",
          "LogPath1= $log_path[0]",
          "LogPath2= $log_path[1]",
          "}",
          "}",
          "}else{",
          "return @{}",
          "}",
          "}",
          "Function checkDotNetWorkload{",
          "try{",
          "$dotnet = (dotnet --info 2>&1 | Select-String 'Version:\\s*.*\\..*\\..*')",
          "}catch{",
          "$dotnet = Get-WindowsFeature NET*Framework* | Where-Object {$_.InstallState -eq 'Installed'} | foreach {$_.DisplayName}",
          "}",
          "if($dotnet){",
          "return $jsonResult = @{",
          "DOT_NET_CORE= @{",
          "Priority= \"2\"",
          "LogPath= \"\"",
          "}",
          "}",
          "}else{",
          "return @{}",
          "}",
          "}",
          "Function checkJavaWorkload{",
          "try{",
          "$version = (Get-ItemProperty -Path HKLM:\"SOFTWARE\\JavaSoft\\JDK\").\"CurrentVersion\"",
          "} catch {",
          "$version = (Get-ItemProperty -Path HKLM:\"SOFTWARE\\JavaSoft\\Java Runtime Environment\").\"CurrentVersion\"",
          "}",
          "if($version){",
          "return $jsonResult = @{",
          "JAVA_JMX= @{",
          "Priority= \"2\"",
          "LogPath= \"\"",
          "}",
          "}",
          "}else{",
          "return @{}",
          "}",
          "}",
          "Function checkSharePointWorkload{",
          "try{",
          "$sharepoint=wmic product get Name | findstr /bi /c:'Microsoft SharePoint Server'",
          "if($sharepoint){",
          "return $jsonResult = @{",
          "SHAREPOINT= @{",
          "Priority= \"7\"",
          "LogPath= '' ",
          "}",
          "}",
          "}",
          "}",
          "Catch { ",
          "return @{}",
          "}",
          "return @{}",
          "}",
          "$ErrorActionPreference = 'Stop'",
          "try{",
          "$iis = checkIISWorkload",
          "} Catch {",
          "$iis = @{}",
          "}",
          "try{",
          "$ad = checkADWorkload",
          "} Catch {",
          "$ad = @{}",
          "}",
          "try{",
          "$mysql = checkMySQLWorkload",
          "} Catch {",
          "$mysql = @{}",
          "}",
          "try{",
          "$sqlserver = checkSQLServerWorkload",
          "} Catch {",
          "$sqlserver = @{}",
          "}",
          "try{",
          "$sqlfci = checkSQLFCIWorkload",
          "} Catch {",
          "$sqlfci = @{}",
          "}",
          "try{",
          "$postgresql = checkPostgreWorkload",
          "} Catch {",
          "$postgresql = @{}",
          "}",
          "try{",
          "$dotnet = checkDotNetWorkload",
          "} Catch {",
          "$dotnet = @{}",
          "}",
          "try{",
          "$java = checkJavaWorkload",
          "} Catch {",
          "$java = @{}",
          "}",
          "try{",
          "$oracle = checkOracleWorkload",
          "} Catch {",
          "$oracle = @{}",
          "}",
          "try{ ",
          "$sp = checkSharePointWorkload",
          "} Catch { ",
          "$sp = @{} ",
          "}",
          "if($host.Version.Major -lt 3){",
          "$iis + $mysql + $sqlserver + $sqlfci + $postgresql + $dotnet + $java  + $oracle + $ad + $sp | ConvertTo-Json20",
          "}else{",
          "$iis + $mysql + $sqlserver + $sqlfci + $postgresql + $dotnet + $java  + $oracle + $ad + $sp | ConvertTo-Json",
          "}"
        ]
      }
    },
    {
      "name": "LINUX",
      "action": "aws:runShellScript",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Linux"
        ]
      },
      "inputs": {
        "runCommand": [
          "#!/bin/bash",
          "function getContainerWorkload {",
          "CLUSTER=$(sudo kubectl config view 2>&1 | sed -n ';6s/name: \\(.*\\)/\\1/p;')",
          "if [ ! -z \"$CLUSTER\" ]; then",
          "IFS=$' \\n' read -r -d '' -a NODES < <( sudo kubectl get nodes && printf '\\0' )",
          "echo $(cat <<EOF",
          "\"Kubernetes\": {",
          "\"CLUSTER_NAME\": \"$CLUSTER\",",
          "\"CLUSTER_NODES\": \"${NODES[@]}\"",
          "},",
          "EOF",
          ")",
          "fi",
          "}",
          "function getJavaWorkload {",
          "VER=$(java -version 2>&1 | sed -n ';s/.* version \"\\(.*\\)\\.\\(.*\\)\\..*\"/\\1\\2/p;')",
          "if [ ! -z \"$VER\" ]; then",
          "echo $(cat <<EOF",
          "\"JAVA_JMX\": {",
          "\"Priority\": \"2\",",
          "\"LogPath\": \"\"",
          "},",
          "EOF",
          ")",
          "fi",
          "}",
          "function getDotNetWorkload {",
          "VER=$(dotnet --info 2>&1 | sed -n ';s/Version: \\(.*\\)\\..*\\..*/\\1/p;')",
          "if [ ! -z \"$VER\" ]; then",
          "echo $(cat <<EOF",
          "\"DOT_NET_CORE\": {",
          "\"Priority\": \"2\",",
          "\"LogPath\": \"\"",
          "},",
          "EOF",
          ")",
          "fi",
          "}",
          "function getSqlServerWorkload {",
          "STATUS=$(systemctl status mssql-server 2>&1 | sed -n ';s/Active: \\(.*\\)/\\1/p;')",
          "if [ ! -z \"$STATUS\" ]; then",
          "echo $(cat <<EOF",
          "\"SQL_SERVER\": {",
          "\"Priority\": \"3\",",
          "\"LogPath\": \"/var/opt/mssql/log/errorlog\"",
          "},",
          "EOF",
          ")",
          "fi",
          "}",
          "function getMySqlWorkload {",
          "LOC=$(type mysql 2>&1 | sed -n ';s/mysql is \\(.*\\)/\\1/p;')",
          "if [ ! -z \"$LOC\" ]; then",
          "echo $(cat <<EOF",
          "\"MYSQL\": {",
          "\"Priority\": \"3\",",
          "\"LogPath\": \"/var/log/mysql\"",
          "},",
          "EOF",
          ")",
          "fi",
          "}",
          "function getPostgreSqlWorkload {",
          "LOC=$(type psql 2>&1 | sed -n ';s/psql is \\(.*\\)/\\1/p;')",
          "if [ ! -z \"$LOC\" ]; then",
          "echo $(cat <<EOF",
          "\"POSTGRESQL\": {",
          "\"Priority\": \"3\",",
          "\"LogPath\": \"/var/lib/pgsql/data/log\"",
          "},",
          "EOF",
          ")",
          "fi",
          "}",
          "function getSqlServerWorkload {",
          "STATUS=$(systemctl status mssql-server 2>&1 | sed -n ';s/Active: \\(.*\\)/\\1/p;')",
          "if [ -n \"$STATUS\" ]; then",
          "echo $(cat <<EOF",
          "\"SQL_SERVER\": {",
          "\"Priority\": \"3\",",
          "\"LogPath\": \"/var/opt/mssql/log/errorlog\"",
          "},",
          "EOF",
          ")",
          "fi",
          "}",
          "function getOracleWorkload {",
          "sid=$(pgrep  -lf _pmon_ | cut -d '_' -f3 | sed 's/[^a-zA-Z0-9]*//g')",
          "sid_case_sensative=$(cat /etc/oratab 2>/dev/null | grep -i $sid 2> /dev/null| cut -d ':' -f1)",
          "ORACLE_HOME=$(cat /etc/oratab 2>/dev/null | grep -i $sid 2> /dev/null| cut -d ':' -f2)",
          "lsnrctl=$ORACLE_HOME'/bin/lsnrctl'",
          "if [ -d \"$ORACLE_HOME\" ]; then",
          "export ORACLE_HOME=$ORACLE_HOME",
          "ORACLE_BASE=$($ORACLE_HOME/bin/orabase)",
          "cd $ORACLE_BASE/diag/rdbms/",
          "dbname=$(ls -ltar | tail -1| awk '{print $9}')",
          "listener_log=$($lsnrctl status | awk '/Listener Parameter File/ {print $NF}')",
          "listener_name=$(basename $listener_log 2>/dev/null | cut -d '.' -f1)",
          "lsnr=$(ps aux | grep tnslsnr | grep inherit |  awk '/tnslsnr/ {print $(NF-1)}')",
          "lsnr_lower=$(echo $lsnr | tr '[:upper:]' '[:lower:]' 2> /dev/null)",
          "log1_test1=$($procdir/lsnrctl show trc_directory 2>/dev/null | awk '/set to / {print $NF}')\"/\"$lsnr\".log\"",
          "log1_test2=$($procdir/lsnrctl show trc_directory 2>/dev/null | awk '/set to / {print $NF}')\"/\"$lsnr_lower\".log\"",
          "if [ -f \"$log1_test1\" ]; then",
          "log1=$log1_test1",
          "fi",
          "if [ -f \"$log1_test2\" ]; then",
          "log1=$log1_test2",
          "fi",
          "log2=$($lsnrctl status | awk '/Listener Log File/ {print $NF}'  | awk -F 'oracle' '{print $1 FS \"\"}')\"/diag/rdbms/$dbname/$sid_case_sensative/trace/alert_$sid_case_sensative.log\"",
          "echo $(cat <<EOF",
          "\"ORACLE\": {",
          "\"Priority\": \"3\",",
          "\"LogPath1\": \"$log1\",",
          "\"LogPath2\": \"$log2\"",
          "},",
          "EOF",
          ")",
          "fi",
          "}",
          "function getHanaWorkload {",
          "HANAPATH=$(find /usr/sap/*/HDB* 2>/dev/null)",
          "if [ -n \"$HANAPATH\" ]; then",
          "SID=$(find /usr/sap/*/HDB* | cut -c 10-12)",
          "INSTANCENR=$(find /usr/sap/*/HDB* | cut -c 17-18)",
          "PRIORITY=5",
          "HANAPORT=$\"3${INSTANCENR}13\"",
          "HOSTNAME=$(hostname)",
          "HOSTS=$(/usr/sap/hostctrl/exe/sapcontrol -nr $INSTANCENR -function GetSystemInstanceList | tail -n +6 | awk '{ print $1 }' | tr -d \"\\n\" | sed 's/.$//')",
          "HANALOGPATH=$\"/usr/sap/$SID/HDB$INSTANCENR/$HOSTNAME/trace\"",
          "HA_SIMPLE_STATUS=$(eval \"crm_mon -s | grep 'CLUSTER OK'\")",
          "ISHAPRIMARY=\"\"",
          "NODES=\"\"",
          "if [ -z \"$HA_SIMPLE_STATUS\" ]; then IS_HA=\"false\"; else IS_HA=\"true\"; fi",
          "if [ \"$IS_HA\" = \"true\" ]; then",
          "    PRIORITY=6",
          "    NODES=\"$HOSTNAME\"",
          "    isPri=$(eval \"crm_mon -1 | grep 'Master' | grep $HOSTNAME\")",
          "    if [ -z \"$isPri\" ]; then ISHAPRIMARY=\"false\"; else ISHAPRIMARY=\"true\"; fi ;",
          "fi",
          "echo $(cat <<EOF",
          "\"SAP_HANA\": [{",
          "\"Priority\": \"$PRIORITY\",",
          "\"Host\": \"$HOSTNAME\",",
          "\"SID\": \"$SID\",",
          "\"HanaPort\": \"$HANAPORT\",",
          "\"InstanceNumber\": \"$INSTANCENR\",",
          "\"LogPath\" : \"$HANALOGPATH\",",
          "\"Hosts\": \"$HOSTS\",",
          "\"IsHA\": \"$IS_HA\",",
          "\"IsHAPrimary\": \"$ISHAPRIMARY\",",
          "\"Nodes\": \"$NODES\"",
          "}]",
          "EOF",
          ")",
          "fi",
          "}",
          "echo \"{$(getContainerWorkload)$(getJavaWorkload)$(getDotNetWorkload)$(getMySqlWorkload)$(getSqlServerWorkload)$(getPostgreSqlWorkload)$(getOracleWorkload)$(getHanaWorkload)}\" | sed 's/,\\(.\\)$/\\1/'"
        ]
      }
    }
  ]
}
