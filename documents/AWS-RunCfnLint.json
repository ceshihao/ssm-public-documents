{
  "description": "### Document name - AWS-RunCfnLint\n\n## What does this document do?\nThis document uses a [CloudFormation Linter](https://github.com/aws-cloudformation/cfn-python-lint) (cfn-python-lint) to validate YAML and JSON templates against the AWS CloudFormation resource specification. The AWS-RunCfnLint document performs additional checks, such as ensuring that valid values have been entered for resource properties. If validation is not successful, the RunCfnLintAgainstTemplate step fails and the linter tool's output is provided in an error message. This Document is using cfn-lint 0.24.4.\n\n## Input Parameters\n* TemplateS3BucketName: (Required) The name of the Amazon S3 bucket that contains the CloudFormation template.\n* TemplateFileName: (Required) The name, or key, of the template file in the S3 bucket.\n* FormatFlag: (Optional) Value to pass to the --format parameter to specify the output format.\n  * Allowed Values: Default | quiet | parseable | json\n  * Default: Default\n* RegionsFlag: (Optional) Values to pass to the for --regions parameter to test the template against specified AWS Regions.\n  * Example: us-east-1,us-west-1\n* IgnoreChecksFlag: (Optional) IDs of rules to pass to the --ignore-checks parameter. These rules are not checked.\n  * Example: E1001,E1003,W7001\n* IncludeChecksFlag: (Optional) IDs of rules to pass to the --include-checks parameter. These rules are checked.\n  * Example: E1001,E1003,W7001\n* ConfigureRuleFlag: (Optional) Configuration options for a rule to pass to the --configure-rule parameter.\n  * Example: E2001:strict=false,E3012:strict=false\n* InfoFlag: (Optional) Option for the --info parameter. Include the option to enable additional logging information about the template processing.\n  * Default: False\n* AutomationAssumeRole: (Optional) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Output parameters\n* RunCfnLintAgainstTemplate.output: The stdout from the cfn-python-lint tool.\n",
  "schemaVersion": "0.3",
  "assumeRole": "{{AutomationAssumeRole}}",
  "parameters": {
    "TemplateS3BucketName": {
      "type": "String",
      "description": "(Required) The name of the Amazon S3 bucket that contains the CloudFormation template."
    },
    "TemplateFileName": {
      "type": "String",
      "description": "(Required) The name, or key, of the template file in the S3 bucket."
    },
    "FormatFlag": {
      "type": "String",
      "description": "(Optional) Value to pass to the --format parameter to specify the output format.",
      "default": "Default",
      "allowedValues": [
        "Default",
        "quiet",
        "parseable",
        "json"
      ]
    },
    "RegionsFlag": {
      "type": "StringList",
      "description": "(Optional) Values to pass to the for --regions parameter to test the template against specified AWS Regions. e.g. us-east-1,us-west-1",
      "default": []
    },
    "IgnoreChecksFlag": {
      "type": "StringList",
      "description": "(Optional) IDs of rules to pass to the --ignore-checks parameter. These rules are not checked. e.g. E1001,E1003,W7001",
      "default": []
    },
    "IncludeChecksFlag": {
      "type": "StringList",
      "description": "(Optional) IDs of rules to pass to the --include-checks parameter. These rules are checked. e.g. E1001,E1003,W7001",
      "default": []
    },
    "ConfigureRuleFlag": {
      "type": "StringList",
      "description": "(Optional) Configuration options for a rule to pass to the --configure-rule parameter. e.g. E2001:strict=false,E3012:strict=false",
      "default": []
    },
    "InfoFlag": {
      "type": "Boolean",
      "description": "(Optional) Option for the --info parameter. Include the option to enable additional logging information about the template processing.",
      "default": false
    },
    "AutomationAssumeRole": {
      "type": "String",
      "description": "(Optional) The ARN of the role that allows Automation to perform the actions on your behalf.",
      "default": ""
    }
  },
  "outputs": [
    "RunCfnLintAgainstTemplate.output"
  ],
  "mainSteps": [
    {
      "name": "RunCfnLintAgainstTemplate",
      "action": "aws:executeScript",
      "onFailure": "Abort",
      "isCritical": true,
      "timeoutSeconds": 500,
      "description": "## RunCfnLintAgainstTemplate\nRuns the cfn-python-lint tool against the provided CloudFormation template.\n## Outputs\n* output: The stdout from the cfn-python-lint tool.\n",
      "inputs": {
        "Runtime": "python3.8",
        "Handler": "cfnlint_handler",
        "Attachment": "cfnlint_attachment.zip",
        "InputPayload": {
          "s3Bucket": "{{TemplateS3BucketName}}",
          "templateFileName": "{{TemplateFileName}}",
          "FormatFlag": "{{FormatFlag}}",
          "RegionsFlag": "{{RegionsFlag}}",
          "IgnoreChecksFlag": "{{IgnoreChecksFlag}}",
          "IncludeChecksFlag": "{{IncludeChecksFlag}}",
          "ConfigureRuleFlag": "{{ConfigureRuleFlag}}",
          "InfoFlag": "{{InfoFlag}}"
        },
        "Script": "import json\nimport os\nimport boto3\nimport sys\nimport subprocess\n\ndef execute_command(command, shell=False):\n  if not shell:\n      cmd = command.split(\" \")\n  else:\n      cmd = command\n  p = subprocess.Popen(cmd, shell, stdout=subprocess.PIPE, stderr=subprocess.PIPE)\n  out, err = p.communicate()\n  return out.decode(\"utf-8\"), err.decode(\"utf-8\")\n\ndef get_download_folder():\n  return os.getcwd()\n\ndef download_template(s3_bucket, s3_key):\n  s3_path_head, file_name = os.path.split(s3_key)\n  download_path = os.path.join(\"/tmp/\",file_name)\n  s3 = boto3.client('s3')\n  s3.download_file(s3_bucket, s3_key, download_path)\n  return download_path\n\ndef get_flag_options(event):\n  flags = ''\n  if event['FormatFlag'] != 'Default':\n    flags += ' -f ' + event['FormatFlag']\n  if event['RegionsFlag']:\n    flags += ' -r ' + ','.join(event['RegionsFlag'])\n  if event['IgnoreChecksFlag']:\n    flags += ' -i ' + ','.join(event['IgnoreChecksFlag'])\n  if event['IncludeChecksFlag']:\n    flags += ' -c ' + ','.join(event['IncludeChecksFlag'])\n  if event['ConfigureRuleFlag']:\n    flags += ' -x ' + ','.join(event['ConfigureRuleFlag'])\n  if event['InfoFlag']:\n    flags += ' -I'\n  return flags\n\ndef cfnlint_handler(event, context):\n  s3_bucket = event['s3Bucket']\n  s3_key = event['templateFileName']\n\n  attachment_path = get_download_folder()\n  cfn_lint_path = os.path.join(attachment_path, \"bin/cfn-lint\")\n\n  template_path = download_template(s3_bucket, s3_key)\n\n  cmd = \"python3 \" + cfn_lint_path + \" -t \" + template_path\n  flags = get_flag_options(event)\n  cmd += flags\n  out, err = execute_command(cmd, False)\n  if err != \"\":\n    raise Exception('ERROR IN EXECUTION CFN-PYTHON-LINT', err)\n  if len(out)<5:\n    out = \"VALID TEMPLATE\"\n  else:\n    raise Exception('INVALID TEMPLATE', out)\n  return {\n    'output': json.dumps(out)\n  }\n"
      },
      "outputs": [
        {
          "Name": "output",
          "Selector": "$.Payload.output",
          "Type": "String"
        }
      ]
    }
  ],
  "files": {
    "cfnlint_attachment.zip": {
      "checksums": {
        "sha256": "d7862f459f4b261c106c4af784d50ddb7a2b6340869b51f87e3a293943fe2106"
      },
      "size": 13961311
    }
  }
}
