{
  "description": "The **AWSSupport-TroubleshootVPN** runbook helps diagnose AWS Site-to-Site VPN issues by searching for errors found in its associated CloudWatch logs group. The runbook makes Amazon CloudWatch logs Insights API calls on the specified log group, searches for errors, and outputs the potential resolution related to the error. You can specify a `TunnelBIPAddress` if your Tunnel B IP is logging in same CloudWatch log group as Tunnel A. If the Tunnel B is configured with a different CloudWatch log group, then you need to run the automation separately for each tunnel. For setting the time window for error tracing, use either `StartTimeinEpoch` and `EndTimeinEpoch`, or `LookBackPeriod`. For `LookBackPeriod`, you need to specify the number of hours you want the automation to check for errors from the automation's start time. Alternatively, you can specify a time range using the `StartTimeinEpoch` and `EndTimeinEpoch` parameters. If you specify `StartTimeinEpoch`, `EndTimeinEpoch`, and `LookBackPeriod`, then the parameter `LookBackPeriod` takes precedence. You can find the pricing related to Amazon CloudWatch Logs Insights API in https://aws.amazon.com/cloudwatch/pricing/",
  "schemaVersion": "0.3",
  "assumeRole": "{{ AutomationAssumeRole }}",
  "outputs": [
    "traceError.Tunnel1IKEv1",
    "traceError.Tunnel1IKEv2",
    "traceError.Tunnel2IKEv1",
    "traceError.Tunnel2IKEv2"
  ],
  "parameters": {
    "AutomationAssumeRole": {
      "type": "AWS::IAM::Role::Arn",
      "description": "(Optional) The Amazon Resource Name (ARN) of the AWS Identity and Access Management (IAM) role that allows Systems Manager Automation to perform the actions on your behalf. If no role is specified, Systems Manager Automation uses the permissions of the user that runs this runbook.",
      "default": ""
    },
    "LogGroupName": {
      "type": "String",
      "description": "(Required) The Amazon CloudWatch log group name configured for AWS Site-to-Site VPN connection logging.",
      "allowedPattern": "^[\\.\\-_/#A-Za-z0-9]{1,512}"
    },
    "VpnConnectionId": {
      "type": "String",
      "description": "(Required) The AWS Site-to-Site VPN connection ID.",
      "allowedPattern": "^vpn-[0-9a-f]{8,17}$"
    },
    "TunnelAIPAddress": {
      "type": "String",
      "description": "(Required) The tunnel number 1 IPv4 address associated with your AWS Site-to-Site VPN.",
      "allowedPattern": "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)[.]){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?){1}$"
    },
    "TunnelBIPAddress": {
      "type": "String",
      "description": "(Optional) The tunnel number 2 IPv4 address associated with your AWS Site-to-Site VPN.",
      "default": "",
      "allowedPattern": "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)[.]){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?){1}|^$"
    },
    "IKEVersion": {
      "type": "String",
      "description": "(Required) Select what IKE Version you are using. Allowed values: IKEv1 or IKEv2",
      "allowedValues": [
        "IKEv1",
        "IKEv2"
      ]
    },
    "StartTimeinEpoch": {
      "type": "String",
      "description": "(Optional) The start time (as epoch time) for log analysis. You can either use StartTimeinEpoch/EndTimeinEpoch or LookBackPeriod for logs analysis. If you specify both StartTimeinEpoch/EndTimeinEpoch and LookBackPeriod, then LookBackPeriod takes precedence.",
      "allowedPattern": "^1[6-9][0-9]{8}$|^$",
      "default": ""
    },
    "EndTimeinEpoch": {
      "type": "String",
      "description": "(Optional) The end time (as epoch time) for log analysis. You can either use StartTimeinEpoch/EndTimeinEpoch or LookBackPeriod for logs analysis. If you specify both StartTimeinEpoch/EndTimeinEpoch and LookBackPeriod, then LookBackPeriod takes precedence.",
      "allowedPattern": "^1[6-9][0-9]{8}$|^$",
      "default": ""
    },
    "LookBackPeriod": {
      "type": "String",
      "description": "(Optional) The number of hours to look back in the associated CloudWatch log group for analysis. Valid range: 1 to 99. This parameter takes precedence over StartTimeinEpoch and EndTimeinEpoch.",
      "allowedPattern": "^([1-9][0-9]?)$|^$",
      "default": ""
    }
  },
  "mainSteps": [
    {
      "description": "Verifies if the input parameters exists and are valid",
      "name": "parameterValidation",
      "action": "aws:executeScript",
      "inputs": {
        "Runtime": "python3.8",
        "Handler": "parameterValidation.parameter_validation",
        "Attachment": "AWSSupport-TroubleshootVPN.zip",
        "InputPayload": {
          "LogGroupName": "{{LogGroupName}}",
          "StartTimeinEpoch": "{{StartTimeinEpoch}}",
          "EndTimeinEpoch": "{{EndTimeinEpoch}}",
          "LookBackPeriod": "{{LookBackPeriod}}",
          "VpnConnectionId": "{{VpnConnectionId}}",
          "TunnelAIPAddress": "{{TunnelAIPAddress}}",
          "TunnelBIPAddress": "{{TunnelBIPAddress}}"
        }
      }
    },
    {
      "description": "Performs Amazon CloudWatch Logs Insights APIs on the AWS Site-to-Site VPN's associated CloudWatch log group.",
      "name": "traceError",
      "action": "aws:executeScript",
      "inputs": {
        "Runtime": "python3.8",
        "Handler": "traceError.trace_error",
        "Attachment": "AWSSupport-TroubleshootVPN.zip",
        "InputPayload": {
          "LogGroupName": "{{LogGroupName}}",
          "StartTimeinEpoch": "{{StartTimeinEpoch}}",
          "EndTimeinEpoch": "{{EndTimeinEpoch}}",
          "LookBackPeriod": "{{LookBackPeriod}}",
          "IKEVersion": "{{IKEVersion}}",
          "VpnConnectionId": "{{VpnConnectionId}}",
          "TunnelAIPAddress": "{{TunnelAIPAddress}}",
          "TunnelBIPAddress": "{{TunnelBIPAddress}}"
        },
        "Script": "%TRACEERROR%"
      },
      "outputs": [
        {
          "Name": "Tunnel1IKEv1",
          "Selector": "$.Payload.Tunnel_1.IKEv1Errors",
          "Type": "StringMap"
        },
        {
          "Name": "Tunnel1IKEv2",
          "Selector": "$.Payload.Tunnel_1.IKEv2Errors",
          "Type": "StringMap"
        },
        {
          "Name": "Tunnel2IKEv1",
          "Selector": "$.Payload.Tunnel_2.IKEv1Errors",
          "Type": "StringMap"
        },
        {
          "Name": "Tunnel2IKEv2",
          "Selector": "$.Payload.Tunnel_2.IKEv2Errors",
          "Type": "StringMap"
        }
      ]
    }
  ],
  "files": {
    "AWSSupport-TroubleshootVPN.zip": {
      "checksums": {
        "sha256": "36c6b55b21c3b98e8ea92ffb078cdc941e3ca3d520deb4a8ee9b8bcdd5628ee8"
      }
    }
  }
}
