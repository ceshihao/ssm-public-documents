{
  "schemaVersion": "2.2",
  "description": "Apply STIGs for RHEL 7, Amazon Linux 2, and Windows Server 2019/2016/2012 R2 (Core/Base).",
  "parameters": {
    "Level": {
      "type": "String",
      "default": "High",
      "description": "(Required) Choose the STIG severity category to apply.",
      "allowedValues": [
        "High",
        "Medium",
        "Low"
      ]
    }
  },
  "mainSteps": [
    {
      "action": "aws:runPowerShellScript",
      "name": "ApplyWindowsSTIGs",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Windows"
        ]
      },
      "inputs": {
        "runCommand": [
          "[string]$level = '{{ Level }}'",
          "[string]$stagingPath = 'C:\\__AWSCSTIGPrep__\\STIG'",
          "[string]$stigZip = 'AWSConfigureSTIG_1_1_1.zip'",
          "[string]$stigZipPath = Join-Path $stagingPath -ChildPath $stigZip",
          "[string]$stigDownloadHash = 'ED6D74E6C5110E81C7541AEEAD12336421B8408871EE5FCC50E5B59A7C653CF8'",
          "",
          "#Test to confirm OS version",
          "Function Test-OSVersion {",
          "    [string]$osReg = 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion'",
          "    $osVersion = (Get-ItemProperty $OSReg).CurrentVersion",
          "    [string]$osType = (Get-ItemProperty $OSReg).EditionID",
          "",
          "    If ( $osVersion -lt 6.3 ) {",
          "        Write-Output 'This document is not designed to support OS versions older then Server 2012R2'",
          "        Exit -1",
          "    }",
          "",
          "    If ( $osType -like \"*Nano*\" ) {",
          "        Write-Output 'This document is not designed to support Nano Server.'",
          "        Exit -1",
          "    }",
          "}",
          "",
          "#Make dir and download the required files",
          "Function Get-Zip {",
          "",
          "    If ( !( Test-Path -Path $stagingPath ) ) {",
          "        Try {",
          "            New-Item -ItemType Directory -Path $stagingPath -Force",
          "        }",
          "        Catch {",
          "            Write-Output \"Failed to create folder due to: $_.\"",
          "            Cleanup",
          "            Exit -1",
          "        }",
          "    }",
          "",
          "    Try {",
          "        $ssmAgentService = Get-ItemProperty 'HKLM:SYSTEM\\CurrentControlSet\\Services\\AmazonSSMAgent\\' -ErrorAction SilentlyContinue",
          "",
          "        If ($ssmAgentService -and $ssmAgentService.Version -ge '2.0.533.0') {",
          "            $region = $env:AWS_SSM_REGION_NAME",
          "        }",
          "",
          "        If ( -not $region) {",
          "            Try {",
          "                $identityDocumentUrl = 'http://169.254.169.254/latest/dynamic/instance-identity/document'",
          "                $region = ((Invoke-WebRequest -UseBasicParsing -uri $identityDocumentUrl).Content | ConvertFrom-Json).region",
          "            }",
          "            Catch {",
          "                $region = 'us-east-1'",
          "            }",
          "        }",
          "",
          "        If ($region.StartsWith('cn-')) {",
          "            $s3Location = 'https://s3.{0}.amazonaws.com.cn/aws-windows-downloads-{0}/STIG/{1}'",
          "        }",
          "        elseif ($region.StartsWith('us-gov-')) {",
          "            $s3Location = 'https://s3-fips-{0}.amazonaws.com/aws-windows-downloads-{0}/STIG/{1}'",
          "        }",
          "        elseif ($region -eq 'us-east-1') {",
          "            $s3Location = 'https://s3.amazonaws.com/aws-windows-downloads-{0}/STIG/{1}'",
          "        }",
          "        else {",
          "            $s3Location = 'https://aws-windows-downloads-{0}.s3.amazonaws.com/STIG/{1}'",
          "        }",
          "",
          "        $bitSource = $s3Location -f $region, $stigZip",
          "        Write-Output $bitSource",
          "    }",
          "    Catch {",
          "        Write-Output \"Failed to identify the region to download the required files, due to: $_.\"",
          "    }",
          "",
          "    Try {",
          "        Start-BitsTransfer -Source $bitSource -Destination $stigZipPath",
          "    }",
          "    Catch {",
          "        Write-Output \"Failed to download the required files, due to: $_.\"",
          "        Cleanup",
          "        Exit -1",
          "    }",
          "",
          "    $downloadHash = (Get-FileHash -Path $stigZipPath -Algorithm SHA256).hash",
          "",
          "    If ( $downloadHash -ne $stigDownloadHash ) {",
          "        Write-Output \"The file doesn't have the expected hash.  Exiting.\"",
          "        Cleanup",
          "        Exit -1",
          "    }",
          "}",
          "",
          "#Expands downloaded zip files, 2012 doesn't have the Expand-Archive",
          "Function Expand-Zip {",
          "    [string]$psVersion = $PSVersionTable.PSVersion.Major",
          "",
          "    If ( $psVersion -le '4' ) {",
          "        Try {",
          "            Add-Type -AssemblyName System.IO.Compression.FileSystem",
          "            [IO.Compression.ZipFile]::ExtractToDirectory($stigZipPath, $stagingPath)",
          "        }",
          "        Catch {",
          "            Write-Output \"Failed to extract the zip file due to: $_.\"",
          "            Cleanup",
          "            Exit -1",
          "        }",
          "    }",
          "    Else {",
          "        Try {",
          "            Expand-Archive -Path $stigZipPath -DestinationPath $stagingPath -Force",
          "        }",
          "        Catch {",
          "            Write-Output \"Failed to extract the zip file due to: $_.\"",
          "            Cleanup",
          "            Exit -1",
          "        }",
          "    }",
          "}",
          "",
          "#Run STIG Script",
          "Function Install-STIG {",
          "    Try {",
          "        &\"$stagingPath\\WinSTIGConfig.ps1\" $level $stagingPath",
          "        Write-Output \"STIGs $level and/or lower have been applied.\"",
          "    }",
          "    Catch {",
          "        Write-Output \"Failed to run the STIG configuration script due to: $_.\"",
          "        Cleanup",
          "        Exit -1",
          "    }",
          "}",
          "",
          "#Cleanup any remaining files",
          "Function Cleanup {",
          "    If (Test-Path \"$stagingPath\") {",
          "        Try {",
          "            Remove-Item -Path \"$stagingPath\" -Recurse",
          "            Write-Output 'STIG staging path removed.'",
          "            Exit 0",
          "        }",
          "        Catch {",
          "            \"Failed to clean up the staging area, due to: $_.\"",
          "            Exit -1",
          "        }",
          "    }",
          "}",
          "",
          "Test-OSVersion",
          "Get-Zip",
          "Expand-Zip",
          "Install-STIG",
          "Cleanup"
        ]
      }
    },
    {
      "action": "aws:runShellScript",
      "name": "ApplyLinuxSTIGs",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Linux"
        ]
      },
      "inputs": {
        "runCommand": [
          "#!/bin/bash",
          "",
          "function CheckOS () {",
          "    if $(hostnamectl | grep -oq 'Amazon Linux 2')",
          "    then",
          "        script='Rhelstigconfig.sh'",
          "        Main",
          "    elif $(hostnamectl | grep -oq 'Red Hat Enterprise Linux Server 7')",
          "    then",
          "        script='Rhelstigconfig.sh'",
          "        Main",
          "    else",
          "        { echo 'This document was only designed to work with RHEL or Amazon Linux 2.  This is an unsupported OS.  Exiting'; exit 1; }",
          "    fi",
          "}",
          "",
          "function Get_Zip () {",
          "   [ ! -d \"$stagingPath\" ] && mkdir -p \"$stagingPath\"",
          "    wgetInstall=$(rpm -q wget)",
          "    region=\"$(curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | grep region|awk -F\\\" '{print $4}')\"",
          "",
          "    if [ $region == cn-* ];",
          "    then",
          "        s3Location=\"https://s3.$region.amazonaws.com.cn/aws-windows-downloads-$region/STIG/$stigZip\"",
          "    elif [ $region == us-gov-* ]",
          "    then",
          "        s3Location=\"https://s3-fips-$region.amazonaws.com/aws-windows-downloads-$region/STIG/$stigZip\"",
          "    elif [ $region == \"us-east-1\" ]",
          "    then",
          "        s3Location=\"https://s3.amazonaws.com/aws-windows-downloads-$region/STIG/$stigZip\"",
          "    else",
          "        s3Location=\"https://aws-windows-downloads-$region.s3.amazonaws.com/STIG/$stigZip\"",
          "    fi",
          "",
          "   if [ ! \"$wgetInstall\" == 'package wget is not installed' ];",
          "   then",
          "       sudo wget \"$s3Location\" -O \"$stigZip\" || { echo 'Failed to download the file properly. Exiting'; exit 1; }",
          "   else",
          "       sudo yum install wget -y",
          "       sudo wget \"$s3Location\" -O \"$stigZip\" || { echo 'Failed to download the file properly. Exiting'; exit 1; }",
          "       sudo yum remove wget -y",
          "   fi",
          "",
          "   comparedHash=\"$(echo \"$stigDownloadHash\" \"$stigZip\" | sha256sum --c)\"",
          "",
          "   [[ $comparedHash == *\"OK\"* ]] || { echo 'File does not have the expected hash. Incorrect file downloaded. Exiting.'; Cleanup; exit 1; }",
          "}",
          "",
          "function Expand_Zip () {",
          "   unzipInstalled=$(rpm -q unzip)",
          "",
          "   if [ ! \"$unzipInstalled\" == 'package unzip is not installed' ];",
          "   then",
          "       sudo unzip \"$stigZip\" -d \"$stagingPath\" || { echo 'File failed to extract properly.  Unable to continue.'; Cleanup; exit 1; }",
          "   else",
          "       sudo yum install unzip -y",
          "       sudo unzip \"$stigZip\" -d \"$stagingPath\" || { echo 'File failed to extract properly.  Unable to continue.'; Cleanup; exit 1; }",
          "       sudo yum remove unzip -y",
          "   fi",
          "}",
          "",
          "function Install_STIG () {",
          "   { sudo sh \"$stagingPath\"/\"$script\" \"$level\" \"$stagingPath\" && echo \"STIGs $level and/or lower have been applied.\"; Cleanup; exit 0; } || { echo 'Failed to run the STIG configuration script. Exiting.'; Cleanup; exit 1; }",
          "}",
          "",
          "function Cleanup () {",
          "    [ -d $stagingPath ] && ( (rm -rf \"$stagingPath\" && echo 'Staging directory has been cleaned.') || echo 'Failed to clean up the staging directory.')",
          "}",
          "",
          "function Main () {",
          "    Get_Zip",
          "    Expand_Zip",
          "    Install_STIG",
          "    Cleanup",
          "}",
          "",
          "level=\"{{ Level }}\"",
          "stagingPath=\"/var/tmp/__AWS__ConfigPrep\"",
          "stigZip='AWSConfigureSTIG_1_1_1.zip'",
          "stigZipPath=\"$stagingPath/STIG.zip\"",
          "stigDownloadHash='ed6d74e6c5110e81c7541aeead12336421b8408871ee5fcc50e5b59a7c653cf8'",
          "",
          "CheckOS"
        ]
      }
    }
  ]
}
