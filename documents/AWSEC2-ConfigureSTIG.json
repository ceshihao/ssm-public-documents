{
  "schemaVersion": "2.2",
  "description": "Applies STIGs for Amazon Linux 2/2023, Red Hat Enterprise Linux (RHEL) 7/8/9, CentOS 7/8/9, Ubuntu 18/20/22/24, SUSE Enterprise Linux Server (SLES) 12/15, and Windows Server 2022/2019/2016/2012 R2 MS (Core/Base).",
  "parameters": {
    "Level": {
      "type": "String",
      "default": "High",
      "description": "(Required) Choose the STIG severity category to apply.",
      "allowedValues": [
        "High",
        "Medium",
        "Low"
      ]
    },
    "InstallPackages": {
      "type": "String",
      "default": "No",
      "description": "(Optional Linux only) Installs the required STIG packages for maximum compliance.",
      "allowedValues": [
        "No",
        "Yes"
      ]
    },
    "SetDoDConsentBanner": {
      "type": "String",
      "default": "No",
      "description": "(Optional Linux only) Sets the Department of Defense (DoD) consent banner to display at login.",
      "allowedValues": [
        "No",
        "Yes"
      ]
    }
  },
  "mainSteps": [
    {
      "action": "aws:runPowerShellScript",
      "name": "ApplyWindowsSTIGs",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Windows"
        ]
      },
      "inputs": {
        "runCommand": [
          "$region = 'us-east-1'",
          "$urlSuffix = 'amazonaws.com'",
          "[string]$level = '{{ Level }}'",
          "[string]$stagingName = [System.Guid]::NewGuid().Guid",
          "[string]$stagingPath = [System.IO.Path]::Combine([System.IO.Path]::GetTempPath(), $stagingName)",
          "[string]$s3Bucket = 'aws-windows-downloads'",
          "[string]$stigZip = 'AWSConfigureSTIG.zip'",
          "[string]$stigZipPath = Join-Path $stagingPath -ChildPath $stigZip",
          "[string]$stigFileHash = 'ED1CCF97B42FFAC85CB521A470A7FBB5B2F1DBA8495C13216D380304E41EB50E'",
          "",
          "#Test to confirm OS version",
          "Function Test-OSVersion {",
          "    [string]$osReg = 'HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion'",
          "    $osVersion = (Get-ItemProperty $OSReg).CurrentVersion",
          "    [string]$osType = (Get-ItemProperty $OSReg).EditionID",
          "",
          "    If ( $osVersion -lt 6.3 ) {",
          "        Write-Output 'This document is not designed to support OS versions older then Server 2012R2'",
          "        Exit -1",
          "    }",
          "",
          "    If ( $osType -like \"*Nano*\" ) {",
          "        Write-Output 'This document is not designed to support Nano Server.'",
          "        Exit -1",
          "    }",
          "}",
          "",
          "#Make dir and download the required files",
          "Function Get-Zip {",
          "",
          "    If ( !( Test-Path -Path $stagingPath ) ) {",
          "        Try {",
          "            New-Item -ItemType Directory -Path $stagingPath -Force",
          "        }",
          "        Catch {",
          "            Write-Output \"Failed to create folder due to: $_.\"",
          "            Cleanup",
          "            Exit -1",
          "        }",
          "    }",
          "",
          "    $s3Path = 'https://{0}-{1}.s3.{1}.{2}/STIG/Windows/Latest/{3}'",
          "",
          "    $s3Location = $s3Path -f $s3Bucket, $region, $urlSuffix, $stigZip",
          "",
          "    $TLS12Protocol = [System.Net.SecurityProtocolType] 'Tls12'",
          "    [System.Net.ServicePointManager]::SecurityProtocol = $TLS12Protocol",
          "",
          "    Try {",
          "         [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType] \"Tls12\"",
          "         (New-Object Net.WebClient).DownloadFile($s3Location, $stigZipPath)",
          "    }",
          "    Catch {",
          "        Write-Output \"Failed to download the required files, due to: $_.\"",
          "        Cleanup",
          "        Exit -1",
          "    }",
          "",
          "}",
          "",
          "#Expands downloaded zip files, 2012 doesn't have the Expand-Archive",
          "Function Expand-Zip {",
          "    [string]$psVersion = $PSVersionTable.PSVersion.Major",
          "",
          "    If ( $psVersion -le '4' ) {",
          "        Try {",
          "            Add-Type -AssemblyName System.IO.Compression.FileSystem",
          "            [IO.Compression.ZipFile]::ExtractToDirectory($stigZipPath, $stagingPath)",
          "        }",
          "        Catch {",
          "            Write-Output \"Failed to extract the zip file due to: $_.\"",
          "            Cleanup",
          "            Exit -1",
          "        }",
          "    }",
          "    Else {",
          "        Try {",
          "            Expand-Archive -Path $stigZipPath -DestinationPath $stagingPath -Force",
          "        }",
          "        Catch {",
          "            Write-Output \"Failed to extract the zip file due to: $_.\"",
          "            Cleanup",
          "            Exit -1",
          "        }",
          "    }",
          "}",
          "",
          "#Run STIG Script",
          "Function Install-STIG {",
          "    $fileHash = (Get-FileHash -Path \"$stagingPath\\Support Files\\file_hash.txt\" -Algorithm SHA256).hash",
          "",
          "    If ( $fileHash -ne $stigFileHash ) {",
          "        Write-Output \"The file does not have the expected hash.  Exiting.\"",
          "        Cleanup",
          "        Exit -1",
          "    }",
          "    Try {",
          "        &\"$stagingPath\\WinSTIGConfig.ps1\" $level $stagingPath",
          "        Write-Output \"STIGs $level and/or lower have been applied.\"",
          "    }",
          "    Catch {",
          "        Write-Output \"Failed to run the STIG configuration script due to: $_.\"",
          "        Cleanup",
          "        Exit -1",
          "    }",
          "",
          "    If ($LastExitCode -ne 0) {",
          "        Write-Output \"Failed to run the STIG configuration script.\"",
          "        Cleanup",
          "        Exit -1",
          "    }",
          "}",
          "",
          "#Cleanup any remaining files",
          "Function Cleanup {",
          "    If (Test-Path \"$stagingPath\") {",
          "        Try {",
          "            Remove-Item -Path \"$stagingPath\" -Recurse",
          "            Write-Output 'STIG staging path removed.'",
          "        }",
          "        Catch {",
          "            \"Failed to clean up the staging area, due to: $_.\"",
          "            Exit -1",
          "        }",
          "    }",
          "}",
          "",
          "Test-OSVersion",
          "Get-Zip",
          "Expand-Zip",
          "Install-STIG",
          "Cleanup"
        ]
      }
    },
    {
      "action": "aws:runShellScript",
      "name": "ApplyLinuxSTIGs",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Linux"
        ]
      },
      "inputs": {
        "runCommand": [
          "#!/bin/bash",
          "",
          "set -e",
          "",
          "function check_os() {",
          "",
          "    os_file=/etc/os-release",
          "",
          "    if [ -e $os_file ]; then",
          "        . $os_file",
          "        os_version=\"$ID${VERSION_ID:+.${VERSION_ID}}\"",
          "    else",
          "        echo \"The file $os_file does not exist. Failing build.\"",
          "        exit 1",
          "    fi",
          "",
          "    case \"${os_version}\" in",
          "     amzn.*|centos.*|rhel.*)",
          "       package_manager='yum'",
          "       main",
          "       ;;",
          "     ubuntu.*)",
          "       package_manager='apt'",
          "       main",
          "       ;;",
          "     sles*)",
          "       package_manager='zypper'",
          "       main",
          "       ;;",
          "     *)",
          "       echo 'This document is designed to work with only Amazon Linux 2/2023, Red Hat Enterprise Linux (RHEL) 7/8/9, CentOS 7/8/9, Ubuntu 18/20/22/24, and SUSE Linux Enterprise Server (SLES) 12/15 operating systems. This OS is unsupported. Exiting.'",
          "       exit 1",
          "       ;;",
          "    esac",
          "}",
          "",
          "function check_for_curl () {",
          "   case \"${package_manager}\" in",
          "     'yum')",
          "       if rpm -qa curl* &>/dev/null; then",
          "         get_tar",
          "       else",
          "         sudo yum install curl -y",
          "         get_tar",
          "         sudo yum remove curl -y",
          "       fi",
          "       ;;",
          "     'apt')",
          "       if apt -q list installed curl &>/dev/null; then",
          "         get_tar",
          "       else",
          "         sudo apt install curl -y",
          "         get_tar",
          "         sudo apt remove curl -y",
          "       fi",
          "       ;;",
          "     'zypper')",
          "       if rpm -qa curl* &>/dev/null; then",
          "         get_tar",
          "       else",
          "         sudo zypper install curl -y",
          "         get_tar",
          "         sudo zypper remove curl -y",
          "       fi",
          "       ;;",
          "     *)",
          "       echo 'Install type is not supported at this time. Exiting.'",
          "       exit 1",
          "       ;;",
          "   esac",
          "}",
          "",
          "function get_tar () {",
          "   s3_location=\"https://$s3_bucket-$region.s3.$region.$url_suffix/STIG/Linux/Latest/$stig_tar\"",
          "   sudo mkdir -p $working_directory -m 755",
          "",
          "   [ ! -d \"$working_directory\" ] && { echo 'Staging directory not located properly. Exiting.'; exit 1; }",
          "",
          "   ( [[ $(stat -c \"%U:%G\" \"$working_directory\") = \"root:root\" ]]) || { echo 'The staging directory is not currently owned by the root account. Exiting.'; exit 1; }",
          "",
          "   sudo curl -L \"$s3_location\" -o \"$stig_tar_path\" || { echo 'Failed to download the file properly. Exiting'; exit 1; }",
          "",
          "}",
          "",
          "function expand_tar () {",
          "   case \"${package_manager}\" in",
          "     'yum')",
          "       if rpm -q tar &>/dev/null; then",
          "         sudo tar -xvf \"$stig_tar_path\" --strip-components 1 --directory \"$working_directory\" || { echo 'File failed to extract properly.  Unable to continue.'; cleanup; exit 1; }",
          "       else",
          "         sudo yum install -y tar",
          "         sudo tar -xvf \"$stig_tar_path\" --strip-components 1 --directory \"$working_directory\" || { echo 'File failed to extract properly.  Unable to continue.'; cleanup; exit 1; }",
          "         sudo yum remove -y tar",
          "       fi",
          "       ;;",
          "     'apt')",
          "       if dpkg -s tar &>/dev/null; then",
          "         sudo tar -xvf \"$stig_tar_path\" --strip-components 1 --directory \"$working_directory\" || { echo 'File failed to extract properly.  Unable to continue.'; cleanup; exit 1; }",
          "       else",
          "         sudo apt install -y tar",
          "         sudo tar -xvf \"$stig_tar_path\" --strip-components 1 --directory \"$working_directory\" || { echo 'File failed to extract properly.  Unable to continue.'; cleanup; exit 1; }",
          "         sudo apt remove -y tar",
          "       fi",
          "       ;;",
          "     'zypper')",
          "       if rpm -q tar &>/dev/null; then",
          "         sudo tar -xvf \"$stig_tar_path\" --strip-components 1 --directory \"$working_directory\" || { echo 'File failed to extract properly.  Unable to continue.'; cleanup; exit 1; }",
          "       else",
          "         sudo zypper install -y tar",
          "         sudo tar -xvf \"$stig_tar_path\" --strip-components 1 --directory \"$working_directory\" || { echo 'File failed to extract properly.  Unable to continue.'; cleanup; exit 1; }",
          "         sudo zypper remove -y tar",
          "       fi",
          "       ;;",
          "     *)",
          "       echo 'Install type is not supported at this time. Exiting.'",
          "       exit 1",
          "       ;;",
          "   esac",
          "}",
          "",
          "function install_stig () {",
          "    case \"${os_version}\" in",
          "     amzn.2*|centos*|rhel*|ubuntu*|sles*)",
          "       cd $working_directory",
          "       compared_hash=\"$(echo \"$stig_file_hash\" \"$working_directory/file_hash.txt\" | sha256sum --c)\"",
          "       [[ $compared_hash == *\"OK\"* ]] || { echo 'File does not have the expected hash. Incorrect file downloaded. Exiting.'; cleanup; exit 1; }",
          "       sudo bash main.sh -d \"./\" -l \"$level\" -h \"$install_packages\" -s \"$set_dod_consent_banner\"",
          "       ;;",
          "     *)",
          "       echo 'This document is designed to work with only Amazon Linux 2/2023, Red Hat Enterprise Linux (RHEL) 7/8/9, CentOS 7/8/9, Ubuntu 18/20/22/24, and SUSE Linux Enterprise Server (SLES) 12/15 operating systems. This OS is unsupported. Exiting.'",
          "       exit 1",
          "       ;;",
          "   esac",
          "}",
          "",
          "function cleanup () {",
          "    [ -d $working_directory ] && ( (rm -rf \"$working_directory\" && echo 'Working directory has been cleaned.') || echo 'Failed to clean up the working directory.')",
          "}",
          "",
          "function main () {",
          "    check_for_curl",
          "    expand_tar",
          "    install_stig",
          "    cleanup",
          "}",
          "",
          "region='us-east-1'",
          "url_suffix='amazonaws.com'",
          "level=\"{{ Level }}\"",
          "install_packages=\"{{ InstallPackages }}\"",
          "set_dod_consent_banner=\"{{ SetDoDConsentBanner }}\"",
          "s3_bucket='aws-windows-downloads'",
          "working_directory='/tmp/linux_stigs'",
          "stig_tar='LinuxAWSConfigureSTIG.tgz'",
          "stig_tar_path=\"$working_directory/$stig_tar\"",
          "stig_file_hash='ed1ccf97b42ffac85cb521a470a7fbb5b2f1dba8495c13216d380304e41eb50e'",
          "",
          "check_os"
        ]
      }
    }
  ]
}
