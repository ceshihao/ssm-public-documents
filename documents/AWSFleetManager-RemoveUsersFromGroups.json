{
  "schemaVersion": "2.2",
  "description": "Removes a list of users from all groups specified.",
  "parameters": {
    "Groups": {
      "type": "String",
      "description": "A command separated list of groups to modify.",
      "allowedPattern": "^[^\"'\\/\\\\\\[\\]:;|#=+*?<>\\r\\n]+$"
    },
    "Users": {
      "type": "String",
      "description": "A comma separated list of users to remove.",
      "allowedPattern": "^[^\"'\\/\\\\\\[\\]:;|=+*?<>@\\r\\n]+$"
    },
    "PerformAction": {
      "type": "String",
      "description": "(Optional) Set this to 'Yes' to perform the action.",
      "default": "No",
      "allowedValues": [
        "No",
        "Yes"
      ]
    }
  },
  "mainSteps": [
    {
      "precondition": {
        "StringEquals": [
          "platformType",
          "Windows"
        ]
      },
      "action": "aws:runPowerShellScript",
      "name": "InvokeWindowsScript",
      "inputs": {
        "runCommand": [
          "$ErrorActionPreference = 'Stop'\n\nFunction ParseInputParameter {\n    param (\n        [string]$Name,\n        [string]$Value,\n        [string]$Regex\n    )\n\n    $ValidParameterRegex = '^--%[ +{|{].*}( +)?$'\n    if ($Value -notmatch $ValidParameterRegex) {\n        ExitWithFailureMessage -Message \"Invalid syntax for the parameter $Name\"\n    }\n    $parameterValue = $Value.Substring(3)\n\n    $trimmedParameterValue = $parameterValue.TrimStart().TrimEnd()\n    $trimmedParameterValue = $trimmedParameterValue.Substring(1)\n    $trimmedParameterValue = $trimmedParameterValue.Substring(0, $trimmedParameterValue.Length - 1)\n\n    if ($Regex -and $trimmedParameterValue -notmatch $Regex) {\n        ExitWithFailureMessage -Message \"Invalid syntax for the parameter $Name\"\n    } else {\n        $trimmedParameterValue\n    }\n}\n\nfunction ExitWithFailureMessage {\n    param (\n        [string]$Message,\n        [string]$ExceptionMessage,\n        [Switch]$PrintJson\n    )\n    if ([string]::IsNullOrWhitespace($ExceptionMessage)) {\n        $errorMessage = $Message\n    } else {\n        $errorMessage = '{0} {1}' -f $Message, $ExceptionMessage\n    }\n    if ($PrintJson) {ConvertTo-Json -InputObject @{error = $errorMessage} -Compress}\n    WriteStandardError -Message $errorMessage\n    [System.Environment]::Exit(1)\n}\n\nfunction ExitWithFailureMessageAndExitCode {\n    param (\n        [string]$Message,\n        [string]$ExceptionMessage,\n        [int]$ExitCode,\n        [Switch]$PrintJson\n    )\n    if ([string]::IsNullOrWhitespace($ExceptionMessage)) {\n        $errorMessage = $Message\n    } else {\n        $errorMessage = '{0} {1}' -f $Message, $ExceptionMessage\n    }\n    if ($PSBoundParameters.ContainsKey('ExitCode') -eq $true) {\n        $exitCode = $ExitCode\n    } else {\n        $exitCode = 1\n    }\n    if ($PrintJson) {\n        $ErrorObject = @{\n            error = $errorMessage\n            exitCode = $exitCode\n        }\n        ConvertTo-Json -InputObject $ErrorObject -Compress\n    }\n    WriteStandardError -Message $errorMessage\n    [System.Environment]::Exit($exitCode)\n}\n\nfunction ExitWithSuccessMessage {\n    param (\n        [string]$Message\n    )\n    Write-Host $Message\n    [System.Environment]::Exit(0)\n}\n\nfunction WriteStandardError {\n    param (\n        [string]$Message\n    )\n    $Host.UI.WriteErrorLine($Message)\n}\n\nfunction TestPerformAction {\n    param ( [string]$PerformAction )\n    if ($PerformAction -ne 'Yes') {\n        ExitWithFailureMessage -Message \"No action was taken because the PerformAction parameter is set to $PerformAction. To make the desired change, set this parameter to Yes.\"\n    }\n}\n\n$Groups = Write-Output --%{{{ Groups }}}\n$Groups = ParseInputParameter -Name 'Groups' -Value $Groups\n\n$Users = Write-Output --%{{{ Users }}}\n$Users = ParseInputParameter -Name 'Users' -Value $Users\n\n$PerformAction = Write-Output --%{{{ PerformAction }}}\n$PerformAction = ParseInputParameter -Name 'PerformAction' -Value $PerformAction -Regex '(Yes|No)'\nTestPerformAction -PerformAction $PerformAction\n\nfunction TestLocalUserExists {\n    param (\n        [string]$Username\n    )\n    $getCimInstance = @{\n        Class = 'Win32_UserAccount'\n        Filter = 'LocalAccount=True'\n    }\n    if (Get-CimInstance @getCimInstance | Where-Object {$_.Name -eq $Username}) {\n        return $true\n    } else {\n        return $false\n    }\n}\n\nfunction TestLocalGroupExists {\n    param (\n        [string]$Name,\n        [string]$Domain\n    )\n    $getCimInstance = @{Class = 'Win32_Group' }\n    if (Get-CimInstance @getCimInstance | Where-Object { $_.Name -eq $Name -and $_.Domain -eq $Domain }) {\n        return $true\n    } else {\n        return $false\n    }\n}\n\nfunction GroupContains {\n    param (\n        [string]$Username,\n        [psobject]$Group\n    )\n    $Group.psbase.Invoke('Members') | ForEach-Object {\n        $user = $_.GetType().InvokeMember('Name', 'GetProperty', $null, $_, $null)\n        if ($user -eq $Username) {\n            return $true\n        }\n    }\n    return $false\n}\n\n$exceptionCount = 0\n\nforeach ($group in $Groups.Split(',')) {\n    try {\n        $groupName = $group.Trim()\n    } catch {\n        $exceptionCount++\n        WriteStandardError -Message \"The group name for $group is invalid.\"\n        continue\n    }\n\n    if ([string]::IsNullOrWhiteSpace($groupName)) {continue}\n\n    if (-not(TestLocalGroupExists -Name $groupName -Domain $env:COMPUTERNAME)) {\n        $exceptionCount++\n        WriteStandardError -Message \"The specified group $groupName does not exist.\"\n        continue\n    }\n\n    $groupObj = ([adsi]\"WinNT://$env:COMPUTERNAME/$groupName,group\")\n    foreach ($user in $Users.Split(',')) {\n        try {\n            $userName = $user.Trim()\n        } catch {\n            $exceptionCount++\n            WriteStandardError -Message \"The user name for $user is invalid.\"\n            continue\n        }\n\n        if ([string]::IsNullOrWhiteSpace($userName)) {continue}\n\n        if (GroupContains -UserName $userName -Group $groupObj) {\n            try {\n                $groupObj.Remove(\"WinNT://$env:COMPUTERNAME/$userName,user\")\n                Write-Host \"$($groupName): The user $userName has been removed.\"\n            } catch {\n                $exceptionCount++\n                WriteStandardError -Message \"$($groupName): Failed to remove the user $userName.\"\n            }\n        } else {\n            Write-Host \"$($groupName): The user $userName is not a member.\"\n        }\n    }\n}\n\nif ($exceptionCount -gt 0) {\n    $exitWithFailureMessage = @{\n        Message = 'There was at least one error when removing users from the specified groups.'\n        PrintJson = $true\n    }\n    ExitWithFailureMessage @exitWithFailureMessage\n}\n\nExitWithSuccessMessage 'All users have been removed from the specified groups.'\n"
        ]
      }
    },
    {
      "precondition": {
        "StringEquals": [
          "platformType",
          "Linux"
        ]
      },
      "action": "aws:runShellScript",
      "name": "InvokeLinuxScript",
      "inputs": {
        "runCommand": [
          "#!/bin/bash\nset -e\n\nif [ -f /etc/os-release ]; then\n    . /etc/os-release\n    OS_RELEASE=\"$ID${VERSION_ID:+.${VERSION_ID}}\"\nelif [ -f /etc/centos-release ]; then\n    OS_RELEASE=\"centos.$(awk '{print $3}' /etc/centos-release)\"\nelif [ -f /etc/redhat-release ]; then\n    OS_RELEASE=\"rhel.$(lsb_release -r | awk '{print $2}')\"\nfi\n\ncase \"$OS_RELEASE\" in\n    amzn.2018.03|centos.6*|debian.9|rhel.6*|ubuntu.*)\n        command_path='/bin/'\n        ;;\n    amzn.2*|centos.*|debian.*|fedora.*|rhel.*|sles*)\n        command_path='/usr/bin/'\n        ;;\n    *)\n        # Catch all without the full path for untested platforms\n        command_path=''\nesac\n\nExitWithFailureMessage() {\n    MESSAGE=\"$1\"\n    JSON=\"$2\"\n    if [[ \"$JSON\" == \"PRINT_JSON\" ]]; then\n        \"${command_path}echo\" \"{\\\"error\\\":\\\"$MESSAGE\\\"}\"\n    fi\n    WriteStandardError \"$MESSAGE\"\n    exit 1\n}\n\n# exit codes. 0-100 are reserved exit codes. 101-150 codes are for linux, 151-200 are for macos and 200 onwards codes are for windows.\nExitWithFailureMessageAndExitCode() {\n    MESSAGE=\"$1\"\n    EXITCODE=\"$2\"\n    JSON=\"$3\"\n    if [[ \"$JSON\" == \"PRINT_JSON\" ]]; then\n        \"${command_path}echo\" \"{\\\"error\\\":\\\"$MESSAGE\\\",\\\"exitCode\\\":\\\"$EXITCODE\\\"}\"\n    fi\n    WriteStandardError \"$MESSAGE\"\n    exit \"$EXITCODE\"\n}\n\nExitWithSuccessMessage() {\n    \"${command_path}echo\" \"$1\"\n    exit 0\n}\n\nWriteStandardError() {\n    MESSAGE=\"$1\"\n    (>&2 \"${command_path}echo\" \"$MESSAGE\")\n}\n\nTestPerformAction() {\n    if [[ \"$1\" != \"Yes\" ]]; then\n        ExitWithFailureMessage \"No action was taken because the PerformAction parameter is set to $1. To make the desired change, set this parameter to Yes.\"\n    fi\n}\n\nGroups='{{ Groups }}'\nUsers='{{ Users }}'\n\nPERFORMACTION='{{ PerformAction }}'\nTestPerformAction \"$PERFORMACTION\"\n\nRemoveLeadingAndTrailingWhitespace() {\n  \"${command_path}echo\" \"$1\" | \"${command_path}sed\" -e 's/^[[:space:]]*//' | \"${command_path}sed\" -e 's/[[:space:]]*$//'\n}\n\nTestLocalGroupExists() {\n  GROUP=\"$1\"\n  if \"${command_path}grep\" -q \"^$GROUP:\" /etc/group; then\n    return 0\n  else\n    return 1\n  fi\n}\n\nTestLocalUserExists() {\n  USERNAME=\"$1\"\n  if \"${command_path}grep\" -q \"^$USERNAME:\" /etc/passwd; then\n    return 0\n  else\n    return 1\n  fi\n}\n\nGroupContains() {\n  USER=\"$1\"\n  GROUP=\"$2\"\n  if /usr/bin/id --name --groups \"$USER\" | \"${command_path}grep\" -q \"$GROUP\"; then\n    return 0\n  else\n    return 1\n  fi\n}\n\nEXCEPTION_COUNT=0\n\nIFS=',' read -ra group_list <<< \"$Groups\"\nIFS=',' read -ra user_list <<< \"$Users\"\n\nfor group in \"${group_list[@]}\"; do\n  # Remove leading and trailing whitespace\n  groupName=$(RemoveLeadingAndTrailingWhitespace \"$group\")\n  if [[ \"$groupName\" == \"\" ]]; then\n    continue\n  fi\n\n  TestLocalGroupExists \"$groupName\" || {\n    EXCEPTION_COUNT=$((EXCEPTION_COUNT+1))\n    WriteStandardError \"The specified group $groupName does not exist.\"\n    continue\n  }\n\n  for user in \"${user_list[@]}\"; do\n    # Remove leading and trailing whitespace\n    userName=$(RemoveLeadingAndTrailingWhitespace \"$user\")\n    if [[ \"$userName\" == \"\" ]]; then\n      continue\n    fi\n\n    if GroupContains \"$userName\" \"$groupName\"; then\n      /usr/bin/gpasswd -d \"$userName\" \"$groupName\" > /dev/null || {\n        EXCEPTION_COUNT=$((EXCEPTION_COUNT+1))\n        WriteStandardError \"$groupName: Failed to remove the user $userName.\"\n        continue\n      }\n      \"${command_path}echo\" \"$groupName: The user $userName has been removed.\"\n    else\n      \"${command_path}echo\" \"$groupName: The user $userName is not a member.\"\n    fi\n  done\ndone\n\nif [[ \"$EXCEPTION_COUNT\" != \"0\" ]]; then\n  ExitWithFailureMessage 'There was at least one error when removing users from the specified groups.' 'PRINT_JSON'\nfi\n\nExitWithSuccessMessage 'All users have been removed from the specified groups.'\n"
        ]
      }
    }
  ]
}
