{
  "description": "#### Document name  AWS-InstallAmazonECSAgent\n## What does this document do?\nAutomation document to install Amazon ECS agent on the targeted Amazon Linux / Amazon Linux 2 instances, That's if your container instance was not launched using an Amazon ECS-optimized AMI.The Amazon ECS container agent is included in the Amazon ECS-optimized AMIs and does not require installation. \n\n## Notes\n- SSM Agent must be installed and running for this document to work.\n- Targeted instances must be managed by System Manager.\n- `AmazonEC2RoleforSSM` and `AmazonEC2ContainerServiceforEC2Role` policy must be attached to the instances iam role.\n- SSM Agent is installed, by default, on Amazon Linux and Amazon Linux 2.\n- This document follows the steps described in this link [Installing the Amazon ECS Container Agent](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-agent-install.html).\n- To manually install SSM Agent on EC2 instances for Linux: https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html\n\n## To install the Amazon ECS agent on an Amazon Linux 2 / Amazon Linux EC2 instance\n1. Launch the instance with an IAM role that allows access to Amazon ECS. For more information, see [Amazon ECS Container Instance IAM Role.](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/instance_IAM_role.html)\n2. Execute the document\n\n\n## Input Parameters\n* AutomationAssumeRole: (optional) The Amazon Resource Name (ARN) of the AWS Identity and Access Management (IAM) role that allows Systems Manager Automation to perform the actions on your behalf. If no role is specified, Systems Manager Automation uses the permissions of the user that runs this document.\n* InstanceIds: (Required) The IDs of the Amazon Linux / Amazon Linux 2 EC2 instances you want to install the Amazon ECS agent on.\n\n\n## minimum permissions required\n* - Action: \n    - ssm:GetCommandInvocation\n    - ec2:DescribeImages\n    - ec2:DescribeInstances\n    - ec2:DescribeInstanceAttribute  \n    - Resource: '*'\n\n* - Action: \n    - ssm:SendCommand\n    - Resource: \n    - \"arn:aws:ssm:\\*::document/\\*\"\n    - !Sub \"arn:aws:ssm:\\*:${AWS::AccountId}:managed-instance/\\*\"\n    - !Sub \"arn:aws:ec2:\\*:${AWS::AccountId}:instance/\\*\"\n\n## Output parameters\nInstallAmazonECSAgent.output\n* SuccessfulInstances\n    * InstanceId: The ID of the instance where the installation happened.\n    * RunCommandId: The Systems Manager run command ID which can be used future references to this request.\n    * Status: Installation status based on the ecs agent installation output.\n    * StatusDetails: Details of the execution result.\n* FailedInstances\n    * InstanceId: The ID of the instance where the installation happened.\n    * RunCommandId: The Systems Manager run command ID which can be used future references to this request.\n    * Status: Installation status based on the ecs agent installation output.\n    * StatusDetails: Details of the execution result.\n* InProgressInstances\n    * InstanceId: The ID of the instance where the installation happened.\n    * RunCommandId: The Systems Manager run command ID which can be used future references to this request.\n    * Status: Installation status based on the ecs agent installation output.\n    * StatusDetails: Details of the execution result.\n",
  "schemaVersion": "0.3",
  "assumeRole": "{{AutomationAssumeRole}}",
  "parameters": {
    "InstanceIds": {
      "type": "StringList",
      "description": "(Required) The IDs of the Amazon Linux / Amazon Linux 2 EC2 instances to install ECS Agent.",
      "minItems": 1,
      "displayType": "textarea",
      "allowedPattern": "^i-[0-9a-z,-]*$"
    },
    "AutomationAssumeRole": {
      "type": "String",
      "description": "(Optional) The ARN of the role that allows Automation to perform the actions on your behalf.",
      "default": "",
      "allowedPattern": "^arn:aws(-cn|-us-gov)?:iam::\\d{12}:role/[\\w+=,.@/-]+|^$"
    }
  },
  "outputs": [
    "InstallAmazonECSAgent.output"
  ],
  "mainSteps": [
    {
      "name": "InstallAmazonECSAgent",
      "action": "aws:executeScript",
      "onFailure": "Abort",
      "isCritical": true,
      "timeoutSeconds": 600,
      "description": "## UpdateAmazonECSAgent\nThis script installs the Amazon ECS container agent on the targeted Amazon Linux / Amazon Linux 2 EC2 instances.\n## Input Parameters\n* AutomationAssumeRole: (optional) The Amazon Resource Name (ARN) of the AWS Identity and Access Management (IAM) role that allows Systems Manager Automation to perform the actions on your behalf. If no role is specified, Systems Manager Automation uses the permissions of the user that runs this document.\n* InstanceIds: (Required) The IDs of the Amazon Linux / Amazon Linux 2 EC2 instances you want to install the Amazon ECS agent on.\n## Output parameters\n* UpdatedInstances: \n* FailedInstances: \n* InProgressInstances: \n",
      "inputs": {
        "Runtime": "python3.11",
        "Handler": "install_amazon_ecs_agent_handler",
        "InputPayload": {
          "InstanceIds": "{{InstanceIds}}"
        },
        "Script": "import json\nimport boto3\nimport pprint\nimport time\n\nssm_client = boto3.client('ssm')\nec2_client = boto3.client('ec2')\nec2_resource = boto3.resource('ec2')\n\nAWS_LINUX = \"amzn\"\nAWS_LINUX_2 = \"amzn2\"\nINCOMPATIBLE = \"incompatible\"\nMAX_RETRIALS_NUM = 3\nWAIT_MAX_RETRIALS_NUM = 6\nretries = 0\nWAITING_STATUS = ['Pending', 'InProgress', 'Delayed']\nSUCCESS_STATUS = ['Success']\nFAILURE_STATUS = ['Failed', 'Terminated',\n                'TimedOut', 'Cancelled', 'Cancelling']\nlogs = []\n\n\ndef install_ecs_agent_amzn2(instance_id):\n    method = \"install_ecs_agent_amzn2\"\n    logs.append(\"{} instance_id='{}'\".format(method, instance_id))\n    response = ssm_client.send_command(\n        InstanceIds=[instance_id],\n        DocumentName=\"AWS-RunShellScript\",\n        TimeoutSeconds=500,\n        Parameters={'commands': [\"#!/bin/bash\", \"set -x\",\"pgrep ecs\",\" if [ $? -eq 0 ]; then\",\" sudo status ecs\",\" exit 0\", \" fi \",\"sudo amazon-linux-extras disable docker; sudo service docker start\", \"sudo amazon-linux-extras install -y ecs; sudo systemctl enable --now ecs\", \"timeout=60 # timeout after 60sec\",\n                                \"while ((timeout > 0)) \", \"do\", \" pgrep ecs\", \" if [ $? -eq 0 ]; then\", \" exit\", \" else\", \" echo \\\"waiting for ecs agent to start..\\\"\", \" sleep 1\", \" fi \", \" ((timeout -= 1))\", \"done\", \"curl -s http://localhost:51678/v1/metadata | python -mjson.tool\"]},\n    )\n    command_id = response['Command']['CommandId']\n    return command_id\n\n\ndef install_ecs_agent_amzn(instance_id):\n    method = \"install_ecs_agent_amzn\"\n    logs.append(\"{} instance_id='{}'\".format(method, instance_id))\n    response = ssm_client.send_command(\n        InstanceIds=[instance_id],\n        DocumentName=\"AWS-RunShellScript\",\n        TimeoutSeconds=500,\n        Parameters={'commands': [\"#!/bin/bash\", \"set -x\", \"pgrep ecs\",\" if [ $? -eq 0 ]; then\",\" sudo status ecs\",\" exit 0\",\" fi \", \"sudo yum install -y ecs-init\", \"sudo service docker start\", \"sudo start ecs\", \"timeout=30 # timeout after 30sec\",\n                                \"while ((timeout > 0)) \", \"do\", \" pgrep ecs\", \" if [ $? -eq 0 ]; then\", \" sudo status ecs\", \" exit\", \" else\", \" echo \\\"waiting for ecs agent to start..\\\"\", \" sleep 1\", \" fi \", \" ((timeout -= 1))\", \"done\", \"curl -s http://localhost:51678/v1/metadata | python -mjson.tool\"]},\n    )\n    command_id = response['Command']['CommandId']\n    return command_id\n\n\ndef get_image_name(instance_id):\n    method = \"get_ami_type\"\n    logs.append(\"{} instance_id='{}'\".format(method, instance_id))\n    instance = ec2_resource.Instance(instance_id)\n    # check if the instace exists\n    image_id = instance.image_id\n    logs.append(\"{} image_id='{}'\".format(method, image_id))\n    response = ec2_client.describe_images(\n        ImageIds=[\n            image_id,\n        ]\n    )\n    image_name = response[\"Images\"][0]['Name']\n    logs.append(\"{} image_id='{}'\".format(method, image_name))\n    return image_name\n\n\ndef get_command_status(instance_id, command_id):\n    method = \"get_command_status\"\n    global retries\n    logs.append(\"{} instance_id='{}', command_id='{}'\".format(\n        method, instance_id, command_id))\n\n    try:\n        response = ssm_client.get_command_invocation(\n            CommandId=command_id,\n            InstanceId=instance_id\n        )\n\n        status = response[\"Status\"]\n        details = response[\"StatusDetails\"]\n\n    except ssm_client.exceptions.InvocationDoesNotExist as e:\n        if retries < MAX_RETRIALS_NUM:\n            logs.append(\"{}, InvocationDoesNotExist instance_id='{}', retry count='{}'\".format(\n                method, instance_id, retries))\n            retries += 1\n            time.sleep(10)\n\n            # retry\n            status, details = get_command_status(instance_id, command_id)\n\n        else:\n            raise Exception(str(e))\n\n    retries = 0\n    return status, details\n\n\ndef get_command_status_with_wait(instance_id, command_id):\n    global retries\n    method = \"get_command_status_with_wait\"\n    logs.append(\"{} instance_id='{}', command_id='{}', retries='{}'\".format(\n        method, instance_id, command_id, retries))\n\n    response = ssm_client.get_command_invocation(\n        CommandId=command_id,\n        InstanceId=instance_id\n    )\n    status = response[\"Status\"]\n    details = response[\"StatusDetails\"]\n\n    if status in WAITING_STATUS and retries < WAIT_MAX_RETRIALS_NUM:\n        retries += 1\n        time.sleep(10)\n        status, details = get_command_status_with_wait(instance_id, command_id)\n\n    retries = 0\n    logs.append(\"{} instance_id='{}',status='{}', details='{}'\".format(\n        method, instance_id, status, details))\n    return status, details\n\n\ndef install_amazon_ecs_agent_handler(event, context):\n    instances_ids = event[\"InstanceIds\"]\n    errorMsg = ''\n    command_ids = {}\n    failed_instances = []\n    successful_instances = []\n    waiting_instances = []\n    temp_waiting_instances = []\n    out = {\n        'SuccessfulInstances': [],\n        'FailedInstances': [],\n        'InProgressInstances': []\n    }\n\n    try:\n        for instance_id in instances_ids:\n            command_id = 'N/A'\n            try:\n                # check ami name\n                image_name = get_image_name(instance_id)\n\n                # if AWS linux 2\n                if AWS_LINUX_2 in image_name:\n                    command_id = install_ecs_agent_amzn2(instance_id)\n                    command_ids[instance_id] = command_id\n                # else AWS linux 1\n                elif AWS_LINUX in image_name:\n                    command_id = install_ecs_agent_amzn(instance_id)\n                    command_ids[instance_id] = command_id\n                else:\n                    errorMsg = \"Instance '{}' is incompatible. Supported instances are Amazon Linux and Amazon Linux 2.\".format(\n                        instance_id)\n                    failed_instances.append(\n                        {'InstanceId': instance_id, 'RunCommandId': command_id, 'Status': 'Failed', 'StatusDetails': errorMsg})\n\n            except ssm_client.exceptions.InvalidInstanceId as e:\n                errorMsg = \"InvalidInstanceId, The following scenarios can result in this error: 1.Instance id is invalid. 2.Instance does not have the AWS SSM agent installed and running. 3.Instance does not have proper iam role attached, AmazonEC2RoleforSSM policy should be attached to instance's iam role. 4.Instance is in a different region. 5.Instance is not currently in the Running state.\"\n                failed_instances.append(\n                    {'InstanceId': instance_id, 'RunCommandId': command_id, 'Status': 'Failed', 'StatusDetails': errorMsg})\n            except Exception as e:\n                errorMsg = str(e)\n                failed_instances.append(\n                    {'InstanceId': instance_id, 'RunCommandId': command_id, 'Status': 'Failed', 'StatusDetails': errorMsg})\n\n        # get_command_status\n        for instance_id, command_id in command_ids.items():\n            try:\n                status, status_details = get_command_status(\n                    instance_id, command_id)\n\n                logs.append(\"instance_id='{}', command_id='{}',status='{}', details='{}'\".format(\n                    instance_id, command_id,status, status_details))\n                \n                if status in SUCCESS_STATUS:\n                    logs.append(\"successful_instances.append\")\n                    successful_instances.append(\n                        {'InstanceId': instance_id, 'RunCommandId': command_id, 'Status': status, 'StatusDetails': status_details})\n                elif status in FAILURE_STATUS:\n                    logs.append(\"failed_instances.append\")\n                    failed_instances.append(\n                        {'InstanceId': instance_id, 'RunCommandId': command_id, 'Status': status, 'StatusDetails': status_details})\n                else:\n                    logs.append(\"waiting_instances.append..\"+ str({'InstanceId': instance_id, 'RunCommandId': command_id, 'Status': status, 'StatusDetails': status_details}))\n                    waiting_instances.append(\n                        {'InstanceId': instance_id, 'RunCommandId': command_id, 'Status': status, 'StatusDetails': status_details})\n            except Exception as e:\n                errorMsg = str(e)\n                logs.append(\"ERROR: \"+errorMsg)\n                failed_instances.append(\n                    {'InstanceId': instance_id, 'RunCommandId': command_id, 'Status': 'Failed', 'StatusDetails': errorMsg})\n\n        # retry on the waiting instances\n        for instance in waiting_instances:\n            \n            try:\n                instance_id= instance['InstanceId']\n                command_id = instance['RunCommandId']\n\n                logs.append(\"Retry on the waiting instances instance='{}'\".format(str(instance)))\n                \n                status, status_details = get_command_status_with_wait(\n                    instance_id, command_id)\n            \n                if status in SUCCESS_STATUS:\n                    successful_instances.append(\n                        {'InstanceId': instance_id, 'RunCommandId': command_id,'Status': status, 'StatusDetails': status_details})\n                elif status in FAILURE_STATUS:\n                    failed_instances.append(\n                        {'InstanceId': instance_id, 'RunCommandId': command_id, 'Status': status, 'StatusDetails': status_details})\n                else:\n                    temp_waiting_instances.append(\n                        {'InstanceId': instance_id, 'RunCommandId': command_id, 'Status': status, 'StatusDetails': status_details})\n\n            except Exception as e:\n                errorMsg = str(e)\n                logs.append(\"ERROR: \"+errorMsg)\n                failed_instances.append(\n                    {'InstanceId': instance_id,'RunCommandId': command_id, 'Status': 'Failed', 'StatusDetails': errorMsg})\n\n        waiting_instances = temp_waiting_instances\n\n    except Exception as e:\n        out = {\n            'ProvidedInstanceIds': instances_ids,\n            'SuccessfulInstances': successful_instances,\n            'FailedInstances': failed_instances,\n            'InProgressInstances': waiting_instances,\n        }\n        errorMsg = str(e)\n        errorMsg = errorMsg + \", output: \" + json.dumps(out)\n        raise Exception(\n            \"Unable to install ECS Agent, errorMsg ='{}'.\".format(errorMsg))\n\n    out = {\n        'SuccessfulInstances': successful_instances,\n        'FailedInstances': failed_instances,\n        'InProgressInstances': waiting_instances\n    }\n\n    if not successful_instances:\n        raise Exception(\n            \"Unable to install ECS Agent on any of the provided instances.\" + \", output: \" + json.dumps(out))\n\n    return {\n        'output': json.dumps(out)\n    }\n"
      },
      "outputs": [
        {
          "Name": "output",
          "Selector": "$.Payload.output",
          "Type": "String"
        }
      ]
    }
  ]
}
