{
  "description": "The AWSSupport-TroubleshootAPIGatewayCustomDomainConfig is designed to help you identify issues with your custom domain name configuration in Amazon API Gateway. The runbook analyzes the following configuration steps:\n\n* A custom domain name is created in API Gateway.\n* A mapping exists between the custom domain name and the API in question.\n* A DNS record exists for the custom domain name and is pointing to the correct target.\n\n#### Note\n1. This runbook does not help to troubleshoot mTLS issues with your custom domain name.\n2. Only publicly available custom domain names can be tested.\n3. The `AutomationAssumeRole` parameter is an optional parameter. This is the AWS Identity and Access Management (IAM) role that allows AWS Systems Manager Automation to perform the actions on your behalf. If no role is specified, Systems Manager Automation uses the permissions of the user that starts this runbook. Details on the required IAM permissions found below\n\n#### IAM Permissions\n- apigateway:GET\n- iam:ListRoles\n- iam:PassRole\n- route53:ListResourceRecordSets\n- ssm:DescribeAutomationExecutions\n- ssm:GetAutomationExecution\n- ssm:DescribeAutomationStepExecutions\n- ssm:StartAutomationExecution\n- ssm:DescribeDocument\n- ssm:GetDocument\n- ssm:ListDocuments",
  "schemaVersion": "0.3",
  "assumeRole": "{{ AutomationAssumeRole }}",
  "outputs": [
    "Results.message"
  ],
  "parameters": {
    "AutomationAssumeRole": {
      "type": "AWS::IAM::Role::Arn",
      "description": "(Optional) The Amazon Resource Name (ARN) of the AWS Identity and Access Management (IAM) role that allows AWS Systems Manager Automation to perform the actions on your behalf. If no role is specified, Systems Manager Automation uses the permissions of the user that starts this runbook.",
      "default": ""
    },
    "DomainName": {
      "type": "String",
      "allowedPattern": "^[a-zA-Z0-9-.]*$",
      "description": "(Required) The custom domain name created for your Amazon API Gateway API."
    },
    "ApiId": {
      "type": "String",
      "allowedPattern": "^[a-zA-Z0-9]{10}$",
      "description": "(Required) The API ID of your API Gateway."
    },
    "DNSServerIp": {
      "type": "String",
      "default": "169.254.169.253",
      "description": "(Optional) IPv4 address of a DNS server to resolve the custom domain name and API Gateway domain name. If a value is not specified, the AWS DNS Server will be used.",
      "allowedPattern": "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"
    },
    "HostedZoneId": {
      "type": "String",
      "description": "(Optional) The Public Hosted Zone ID where the DNS record for the custom domain name is created in Amazon Route53. If Route53 is not used for DNS, the value is not required.",
      "allowedPattern": "^(Z[A-Z0-9]{4,32})?$",
      "default": ""
    }
  },
  "mainSteps": [
    {
      "name": "CheckAPIExists",
      "description": "Checks the existence of Amazon API Gateway API.",
      "action": "aws:executeScript",
      "inputs": {
        "InputPayload": {
          "ApiId": "{{ ApiId }}"
        },
        "Handler": "script_handler",
        "Runtime": "python3.11",
        "Script": "############################################################################\n# Copyright 2025 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: LicenseRef-.amazon.com.-AmznSL-1.0\n# Licensed under the Amazon Software License  http://aws.amazon.com/asl/\n############################################################################\n# USAGE: check_api_exists.py verifies if the specified API ID exists in\n# either API Gateway V2 (HTTP/WebSocket) or API Gateway V1 (REST).\n############################################################################\n\nimport sys\n\nimport boto3\nfrom botocore.exceptions import ClientError\n\nsys.tracebacklimit = 0\n\n\ndef script_handler(event, _):\n    \"\"\"\n    Checks if an API with the specified ID exists in API Gateway V1 or V2.\n\n    Args:\n        event (dict): Event containing ApiId parameter\n        _ (object): Unused context parameter\n\n    Returns:\n        dict: Dictionary with ApiExists boolean value\n\n    Raises:\n        RuntimeError: If an unexpected error occurs while checking the API\n    \"\"\"\n    try:\n        api_id = event[\"ApiId\"]\n\n        # Check in API Gateway V2\n        apigw_v2 = boto3.client(\"apigatewayv2\")\n        try:\n            apigw_v2.get_api(ApiId=api_id)\n            return {\"ApiExists\": True}\n        except ClientError as e:\n            if e.response[\"Error\"][\"Code\"] == \"NotFoundException\":\n                # Not found in HTTP/WebSocket APIs, check REST APIs\n                pass\n            else:\n                # Let other errors be caught by the outer exception handler\n                raise\n\n        # Check in REST API (API Gateway V1)\n        apigw_v1 = boto3.client(\"apigateway\")\n        try:\n            apigw_v1.get_rest_api(restApiId=api_id)\n            return {\"ApiExists\": True}\n        except ClientError as e:\n            if e.response[\"Error\"][\"Code\"] == \"NotFoundException\":\n                # If not found in either API type, return False but still succeed\n                return {\"ApiExists\": False}\n            else:\n                # Let other errors be caught by the outer exception handler\n                raise\n\n    except Exception as e:\n        # Raise exception for any unexpected error\n        raise RuntimeError(f\"Unexpected error occurred while fetching API details: {str(e)}\") from None\n"
      },
      "outputs": [
        {
          "Name": "ApiExists",
          "Selector": "$.Payload.ApiExists",
          "Type": "Boolean"
        }
      ],
      "onFailure": "Abort",
      "nextStep": "GetDomainName",
      "timeoutSeconds": 300,
      "maxAttempts": 3
    },
    {
      "name": "GetDomainName",
      "description": "Get details for the custom domain name configured in Amazon API Gateway.",
      "action": "aws:executeScript",
      "inputs": {
        "InputPayload": {
          "DomainName": "{{ DomainName }}"
        },
        "Handler": "script_handler",
        "Runtime": "python3.11",
        "Script": "############################################################################\n# Copyright 2025 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: LicenseRef-.amazon.com.-AmznSL-1.0\n# Licensed under the Amazon Software License  http://aws.amazon.com/asl/\n############################################################################\n# USAGE: get_domain_name.py checks if the custom domain name has been\n# created in API Gateway.\n############################################################################\n\nimport sys\n\nimport boto3\nfrom botocore.exceptions import ClientError\n\nsys.tracebacklimit = 0\nclient = boto3.client(\"apigatewayv2\")\n\n\ndef script_handler(event, _):\n    \"\"\"\n    Retrieves information about a custom domain name in API Gateway.\n\n    This function checks if the specified custom domain name exists in API Gateway\n    and returns its configuration details. If the domain name doesn't exist,\n    it returns a response with NOT_FOUND status.\n\n    Args:\n        event (dict): Dictionary with following keys:\n            - DomainName (str): The custom domain name to check\n        _ (object): Unused context parameter\n\n    Returns:\n        dict: A dictionary with the following keys:\n            - DomainName (str): The custom domain name that was checked\n            - APIGatewayDomainName (str): The API Gateway domain name associated with the custom domain\n            - DomainStatus (str): Status of the domain (e.g., 'AVAILABLE', 'UPDATING', 'PENDING_OWNERSHIP_VERIFICATION','PENDING_CERTIFICATE_REIMPORT','NOT_FOUND')\n            - EndpointType (str): The endpoint type of the domain name configuration\n\n    Raises:\n        RuntimeError: If an error occurs while retrieving domain name details\n    \"\"\"\n    try:\n        domain_name = event[\"DomainName\"]\n\n        try:\n            response = client.get_domain_name(DomainName=domain_name)\n            return {\n                \"DomainName\": response[\"DomainName\"],\n                \"APIGatewayDomainName\": response[\"DomainNameConfigurations\"][0][\"ApiGatewayDomainName\"],\n                \"DomainStatus\": response[\"DomainNameConfigurations\"][0][\"DomainNameStatus\"],\n                \"EndpointType\": response[\"DomainNameConfigurations\"][0][\"EndpointType\"],\n            }\n\n        except ClientError as e:\n            if e.response[\"Error\"][\"Code\"] == \"NotFoundException\":\n                return {\n                    \"DomainName\": domain_name,\n                    \"APIGatewayDomainName\": \"\",\n                    \"DomainStatus\": \"NOT_FOUND\",  # Indicating CDN doesn't exist\n                    \"EndpointType\": \"\",\n                }\n            else:\n                # Let other errors be caught by the outer exception handler\n                raise\n\n    # To handle other exceptions\n    except Exception as e:\n        raise RuntimeError(f\"Unexpected error getting domain name details: {str(e)}\") from None\n"
      },
      "nextStep": "GetMappings",
      "outputs": [
        {
          "Name": "DomainName",
          "Selector": "$.Payload.DomainName",
          "Type": "String"
        },
        {
          "Name": "APIGatewayDomainName",
          "Selector": "$.Payload.APIGatewayDomainName",
          "Type": "String"
        },
        {
          "Name": "EndpointType",
          "Selector": "$.Payload.EndpointType",
          "Type": "String"
        },
        {
          "Name": "DomainStatus",
          "Selector": "$.Payload.DomainStatus",
          "Type": "String"
        }
      ],
      "onFailure": "Abort",
      "timeoutSeconds": 300,
      "maxAttempts": 3
    },
    {
      "name": "GetMappings",
      "description": "Retrieves all Amazon API Gateway API mappings configured for the custom domain name and verifies if the specified API ID has a valid mapping with the correct stage and path configurations.",
      "action": "aws:executeScript",
      "inputs": {
        "InputPayload": {
          "DomainName": "{{ DomainName }}",
          "DomainStatus": "{{ GetDomainName.DomainStatus }}",
          "ApiId": "{{ ApiId }}",
          "ApiExists": "{{ CheckAPIExists.ApiExists }}"
        },
        "Handler": "script_handler",
        "Runtime": "python3.11",
        "Script": "############################################################################\n# Copyright 2025 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: LicenseRef-.amazon.com.-AmznSL-1.0\n# Licensed under the Amazon Software License  http://aws.amazon.com/asl/\n############################################################################\n# USAGE: get_mappings.py returns a list of APIs mapped to the custom\n# domain name and the mapping details.\n############################################################################\nimport sys\n\nimport boto3\n\nsys.tracebacklimit = 0\nclient = boto3.client(\"apigatewayv2\")\n\n\ndef script_handler(event, _):\n    \"\"\"\n    Retrieves API mappings for a custom domain name in API Gateway.\n\n    This function checks if the specified custom domain name has any API mappings\n    and specifically looks for mappings to the provided API ID.\n\n    Args:\n        event (dict): Dictionary with the following keys:\n            - DomainName (str): The custom domain name to check for mappings\n            - DomainStatus (str): Status of the domain (e.g., 'AVAILABLE', 'NOT_FOUND')\n            - ApiId (str): The API ID to check for specific mappings\n            - ApiExists (bool): Whether the specified API exists\n        _ (object): Unused context parameter\n\n    Returns:\n        dict: Dictionary with following keys:\n            - Mappings (list): All API mappings for the custom domain name\n            - ApiMappings (list): API mappings specific to the provided API ID\n                (empty if no mappings exist for the API ID)\n\n    Raises:\n        RuntimeError: If an error occurs while retrieving API mappings\n    \"\"\"\n    domain_name = event[\"DomainName\"]\n    domain_status = event[\"DomainStatus\"]\n    api_id = event[\"ApiId\"]\n    api_exists = event[\"ApiExists\"]\n\n    try:\n        # return empty mappings if domain name doesn't exist\n        if domain_status == \"NOT_FOUND\":\n            return {\"Mappings\": [], \"ApiMappings\": []}\n\n        # Check if the domain name exists\n        response = client.get_api_mappings(DomainName=domain_name)\n        if not response[\"Items\"]:\n            return {\"Mappings\": [], \"ApiMappings\": []}\n\n        # Stores the API mappings of the CDN for given API ID\n        api_mappings = []\n        if api_exists:\n            for item in response[\"Items\"]:\n                if item.get(\"ApiId\") == api_id:\n                    api_mappings.append(item)\n\n        # returns empty list in ApiMappings when CDN doesn't have mapping for given API or when API doesn't exist\n        return {\"Mappings\": response[\"Items\"], \"ApiMappings\": api_mappings}\n\n    except Exception as e:\n        raise RuntimeError(\n            f\"Unexpected error while fetching the API mapping for your domain {domain_name}: {str(e)}\"\n        ) from None\n"
      },
      "outputs": [
        {
          "Name": "Mappings",
          "Selector": "$.Payload.Mappings",
          "Type": "MapList"
        },
        {
          "Name": "ApiMappings",
          "Selector": "$.Payload.ApiMappings",
          "Type": "MapList"
        }
      ],
      "nextStep": "CheckDNSRecordExists",
      "onFailure": "Abort",
      "timeoutSeconds": 300,
      "maxAttempts": 3
    },
    {
      "name": "CheckDNSRecordExists",
      "description": "Checks the custom domain name DNS and returns the associated records.",
      "action": "aws:executeScript",
      "inputs": {
        "InputPayload": {
          "DomainName": "{{ DomainName }}",
          "DNSServerIp": "{{ DNSServerIp }}"
        },
        "Handler": "script_handler",
        "Runtime": "python3.11",
        "Script": "############################################################################\n# Copyright 2025 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: LicenseRef-.amazon.com.-AmznSL-1.0\n# Licensed under the Amazon Software License  http://aws.amazon.com/asl/\n############################################################################\n# USAGE: check_dns_record_exists.py runs a DNS query on the custom\n# domain name and returns the DNS record details.\n############################################################################\nimport ipaddress\nimport json\nimport logging\nimport socket\nimport sys\n\nsys.tracebacklimit = 0\n\n\nclass StreamReader:\n    def __init__(self, data):\n        self.data = data\n        self.pos = 0\n        \"\"\"\n        Returns data from the stream up to len_ and save latest visited position in the stream until done reading.\n        \"\"\"\n\n    def read(self, len_):\n        pos = self.pos\n        if pos >= len(self.data):\n            raise\n\n        res = self.data[pos : pos + len_]\n        self.pos += len_\n        return res\n\n    def reuse(self, pos):\n        \"\"\"\n        If a structure of characters has been already found,\n        read them directly without calculating nor skipping additional positions in the stream\n        \"\"\"\n        pos = int.from_bytes(pos.encode(), \"big\")\n        return parse_dns_string(None, self.data[pos:])\n\n\ndef check_dns_record_exists(domain_name, dns_server_ip):\n    \"\"\"\n    Initialize connection through Sockets and retrieve the DNS records of domain_name\n    \"\"\"\n    dns_query = create_dns_query(domain_name)\n    dq_len = len(dns_query)\n\n    req = create_dns_request_data(dns_query)\n    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)\n    sock.settimeout(2)\n\n    try:\n        sock.sendto(req, (dns_server_ip, 53))\n        res, _ = sock.recvfrom(1024 * 4)\n        result = parse_dns_response(res, dq_len, req)\n    except Exception as e:\n        logging.error(f\"Error: DNS resolution Failed: {e}\")\n        return\n    finally:\n        sock.close()\n\n    return result\n\n\ndef create_dns_query(domain):\n    \"\"\"\n    Returns DNS Query request in HEX format\n    \"\"\"\n\n    def f(s):\n        return chr(len(s)) + s\n\n    parts = domain.split(\".\")\n    parts = list(map(f, parts))\n    return \"\".join(parts).encode()\n\n\ndef create_dns_request_data(dns_query):\n    \"\"\"\n    Creates the payload to be sent to the DNS Server in Hexadecimal format, including Headers to start and close the transmission.\n    \"\"\"\n    req = b\"\\xaa\\xbb\\x01\\x00\\x00\\x01\\x00\\x00\\x00\\x00\\x00\\x00\"\n    req += dns_query\n    req += b\"\\x00\\x00\\x01\\x00\\x01\"\n    return req\n\n\ndef parse_dns_response(res, dq_len, req):\n    reader = StreamReader(res)\n\n    def get_query(s):\n        return s[12 : 12 + dq_len]\n\n    data = reader.read(len(req))\n    # Check that both DNS in the Request and Response are the same\n    assert get_query(data) == get_query(req)\n\n    def to_int(bytes_):\n        return int.from_bytes(bytes_, \"big\")\n\n    result = {}\n    res_num = to_int(data[6:8])\n    # Based on the amount of items required to read, iterate as N times.\n    for i in range(res_num):\n        # Advance 2 positions in the stream buffer.\n        reader.read(2)\n        # Check what kind of response has been received\n        type_num = to_int(reader.read(2))\n\n        type_ = None\n        if type_num == 1:\n            type_ = \"A\"\n        elif type_num == 5:\n            type_ = \"CNAME\"\n\n        # Advance to the end of the record type response block\n        reader.read(6)\n\n        # Reserve the response block that contains the record value\n        data = reader.read(2)\n        data = reader.read(to_int(data))\n        add_record_to_results(result, type_, data, reader)\n\n    return result\n\n\ndef add_record_to_results(result, type_, data, reader):\n    if type_ == \"A\":\n        item = str(ipaddress.IPv4Address(data))\n    elif type_ == \"CNAME\":\n        item = parse_dns_string(reader, data)\n    else:\n        return\n\n    result.setdefault(type_, []).append(item)\n\n\ndef parse_dns_string(reader, data):\n    \"\"\"\n    Transforms Binary data into readable characters.\n    \"\"\"\n    res = \"\"\n    to_resue = None\n    bytes_left = 0\n\n    for ch in data:\n        if not ch:\n            break\n\n        if to_resue is not None:\n            resue_pos = chr(to_resue) + chr(ch)\n            res += reader.reuse(resue_pos)\n            break\n\n        if bytes_left:\n            res += chr(ch)\n            bytes_left -= 1\n            continue\n\n        if (ch >> 6) == 0b11 and reader is not None:\n            to_resue = ch - 0b11000000\n        else:\n            bytes_left = ch\n\n        if res:\n            res += \".\"\n\n    return res\n\n\ndef script_handler(event, _):\n    \"\"\"\n    Checks if DNS records exist for a specified domain name using a given DNS server.\n\n    This function queries a DNS server to retrieve DNS records (A and CNAME records)\n    for the specified domain name and returns the results.\n\n    Args:\n        event (dict): Dictionary with the following keys:\n            - DomainName (str): The domain name to check for DNS records\n            - DNSServerIp (str): The IP address of the DNS server to query\n        _ (object): Unused context parameter\n\n    Returns:\n        dict: Dictionary with the following keys:\n            - results (str): JSON string containing DNS records if found, or \"NoDnsRecord\" if no records exist\n\n    Raises:\n        RuntimeError: If an error occurs while checking DNS records\n    \"\"\"\n    try:\n        domain_name = event[\"DomainName\"]\n        dns_server_ip = event[\"DNSServerIp\"]\n\n        response = check_dns_record_exists(domain_name=domain_name, dns_server_ip=dns_server_ip)\n\n        if response:\n            return {\"results\": json.dumps(response)}\n        else:\n            return {\"results\": \"NoDnsRecord\"}\n    except Exception as e:\n        raise RuntimeError(f\"Error occurred while checking DNS records: {str(e)}\") from None\n"
      },
      "outputs": [
        {
          "Name": "Results",
          "Selector": "$.Payload.results",
          "Type": "String"
        }
      ],
      "nextStep": "ValidateDNSResults",
      "onFailure": "Abort",
      "timeoutSeconds": 300,
      "maxAttempts": 3
    },
    {
      "name": "ValidateDNSResults",
      "description": "Compares the DNS details (A or CNAME records) of the custom domain name to ensure the record points to the correct Amazon API Gateway distribution domain name.",
      "action": "aws:executeScript",
      "nextStep": "Results",
      "inputs": {
        "InputPayload": {
          "DomainName": "{{ DomainName }}",
          "APIGWDomainName": "{{ GetDomainName.APIGatewayDomainName }}",
          "DNSRecord": "{{ CheckDNSRecordExists.Results }}",
          "HostedZoneId": "{{ HostedZoneId }}"
        },
        "Handler": "script_handler",
        "Runtime": "python3.11",
        "Script": "############################################################################\n# Copyright 2025 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: LicenseRef-.amazon.com.-AmznSL-1.0\n# Licensed under the Amazon Software License  http://aws.amazon.com/asl/\n############################################################################\n# USAGE: validate_dns_results.py Compares the previously returned DNS details\n# of the custom domain name to ensure the DNS record of the custom domain\n# name is pointing to the correct target value.\n############################################################################\nimport json\nimport sys\n\nimport boto3\n\nsys.tracebacklimit = 0\nclient = boto3.client(\"route53\")\n\n\ndef script_handler(events, _):\n    \"\"\"\n    Validates if DNS records for a custom domain name are correctly configured\n    to point to the API Gateway domain name. It handles both CNAME records\n    and A records with Route53 Alias targets.\n\n    Args:\n        event (dict): Dictionary with the following keys:\n            - DNSRecord (str): JSON string containing DNS records for the custom domain name, \"NoDnsRecord\" otherwise\n            - HostedZoneId (str, optional): The Route53 hosted zone ID if using Route53\n            - DomainName (str): The custom domain name being validated\n            - APIGWDomainName (str): The API Gateway domain name that the custom domain should point to\n\n    Returns:\n        str: JSON string containing validation results, including:\n          - customDomainNameDNSDetails: The DNS records for the custom domain\n          - apigwDomainName: The API Gateway domain name\n          - result: Validation result message\n\n    Raises:\n        RuntimeError: If an error occurs during DNS validation\n    \"\"\"\n    try:\n        custom_domain_name = events[\"DNSRecord\"]  # DNS record json string or \"NoDnsRecord\"\n        hosted_zone_id = events[\"HostedZoneId\"]\n        domain_name = events[\"DomainName\"]\n        apigw_domain_name_details = events[\"APIGWDomainName\"]\n\n        custom_domain_name_details = None\n        validation_result = \"DNS record not found or not configured correctly.\"  # default result\n\n        # If no dns record is present, return early\n        if custom_domain_name == \"NoDnsRecord\":\n            return {\"results\": validation_result}\n\n        # Parse the DNS record JSON string\n        custom_domain_name = json.loads(events[\"DNSRecord\"])\n\n        # Check for CNAME record\n        if \"CNAME\" in custom_domain_name:\n            custom_domain_name_details = custom_domain_name[\"CNAME\"][0]\n        # Check for A record in hosted zone\n        elif hosted_zone_id:\n            result = client.list_resource_record_sets(\n                HostedZoneId=hosted_zone_id, StartRecordName=domain_name, StartRecordType=\"A\", MaxItems=\"1\"\n            )\n\n            # Check for A records and if the first record matches the domain which has an Alias target\n            if (\n                result.get(\"ResourceRecordSets\")\n                and result[\"ResourceRecordSets\"][0].get(\"AliasTarget\")\n                and result[\"ResourceRecordSets\"][0].get(\"Name\", \"\").rstrip(\".\") == domain_name\n            ):\n                custom_domain_name_details = result[\"ResourceRecordSets\"][0][\"AliasTarget\"][\"DNSName\"].rstrip(\".\")\n            else:\n                # No A record found for the domain or DNS record found but not configured with an alias target\n                return {\"results\": validation_result}\n        else:\n            custom_domain_name_details = custom_domain_name\n\n        # Validate if DNS is pointing to the correct target\n        if custom_domain_name_details == apigw_domain_name_details:\n            validation_result = \"DNS record valid and configured correctly.\"\n\n        return {\"results\": validation_result}\n\n    except Exception as e:\n        # Raise any other unexpected errors\n        raise RuntimeError(\n            f\"Unexpected error occurred when validating the DNS record for {domain_name}: {str(e)}\"  # type: ignore\n        ) from None\n"
      },
      "outputs": [
        {
          "Name": "Results",
          "Selector": "$.Payload.results",
          "Type": "String"
        }
      ],
      "onFailure": "Abort",
      "timeoutSeconds": 300,
      "maxAttempts": 3
    },
    {
      "name": "Results",
      "description": "Formats the overall output of the AWS Systems Manager Automation to return a structured summary of the custom domain configuration analysis results to the AWS Systems Manager console.",
      "action": "aws:executeScript",
      "inputs": {
        "InputPayload": {
          "ApiExists": "{{ CheckAPIExists.ApiExists }}",
          "DomainStatus": "{{ GetDomainName.DomainStatus }}",
          "Mappings": "{{ GetMappings.Mappings }}",
          "ApiMappings": "{{ GetMappings.ApiMappings }}",
          "DNSRecords": "{{ CheckDNSRecordExists.Results }}",
          "ValidateRecords": "{{ ValidateDNSResults.Results }}",
          "APIGatewayDomainName": "{{ GetDomainName.APIGatewayDomainName }}",
          "EndpointType": "{{ GetDomainName.EndpointType }}",
          "DomainName": "{{ DomainName }}",
          "ApiId": "{{ ApiId }}"
        },
        "Handler": "script_handler",
        "Runtime": "python3.11",
        "Script": "############################################################################\n# Copyright 2025 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: LicenseRef-.amazon.com.-AmznSL-1.0\n# Licensed under the Amazon Software License  http://aws.amazon.com/asl/\n############################################################################\n# USAGE: results.py Formats the overall output of the automation to\n# return the results of the analysis to the console.\n############################################################################\n\nimport sys\n\nsys.tracebacklimit = 0\n\n\ndef script_handler(event, _):\n    try:\n        api_id = event[\"ApiId\"]\n        domain_name = event[\"DomainName\"]\n        api_gateway_domain_name = event[\"APIGatewayDomainName\"]\n\n        api_exists = event[\"ApiExists\"]\n        domain_status = event[\"DomainStatus\"]\n        mappings = event[\"Mappings\"]\n        api_mappings = event[\"ApiMappings\"]\n        dns_records = event[\"DNSRecords\"]\n        validate_records = event[\"ValidateRecords\"]\n        endpoint_type = event[\"EndpointType\"]\n\n        final_result = \"\"\n        successful_step_count = 0\n\n        # Step 1: Check API Exists\n        if api_exists:\n            successful_step_count += 1\n            final_result += f\"\"\"Check (1/5): Check API exists.\n  Status: Complete\n  Details: API {api_id} is valid and accessible in your account.\n\n\"\"\"\n        else:\n            final_result += f\"\"\"Check (1/5): Check API exists.\n  Status: API Not Found\n  Details: API {api_id} does not exist in this account.\n\n  Troubleshooting Recommendations:\n    - Verify that the API ID {api_id} is correct.\n    - Check if the API was deleted or if you're using the wrong API ID.\n    - Use the AWS Console or CLI to list your APIs: aws apigateway get-rest-apis / aws apigatewayv2 get-apis\n    - Ensure you have the necessary permissions to access the API.\n    - Create a new API if needed:\n        > https://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-create-api.html\n\n\"\"\"\n\n        # Step 2: Check Custom Domain Name\n        if domain_status != \"NOT_FOUND\":\n            successful_step_count += 1\n            final_result += f\"\"\"Check (2/5): Check custom domain name exists.\n  Status: Complete\n  Details: Custom domain name '{domain_name}' is properly configured in API Gateway with status '{domain_status}'.\n\n\"\"\"\n        else:\n            final_result += f\"\"\"Check (2/5): Check custom domain name exists.\n  Status: Domain not found\n  Details: Custom domain name is not available (Status: {domain_status}).\n\n  Troubleshooting Recommendations:\n    - The custom domain name '{domain_name}' is not configured in API Gateway.\n    - Create a custom domain name in API Gateway using the AWS Console or CLI.\n    - Ensure you have a valid ACM certificate for your domain.\n    - Please follow the instructions on how to setup a custom domain for API Gateway:\n        > https://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-custom-domains.html\n\n\"\"\"\n\n        # Step 3: Check API Mappings\n        if not mappings:  # Checks if CDN has no API mappings\n            final_result += f\"\"\"Check (3/5): Check mapping exists to API Id: {api_id}.\n  Status: No mappings\n  Details: Custom Domain name has no API mapping configuration\n\n  Troubleshooting Recommendations:\n    - Confirm that the custom domain name '{domain_name}' exists in this account.\n    - Create at least one API mapping to route traffic from your custom domain to an API stage.\n    - Please refer the below documentation to create API mappings for your custom domain:\n        > https://docs.aws.amazon.com/apigateway/latest/developerguide/rest-api-mappings.html\n\n\"\"\"\n        elif not api_mappings:  # Checks if CDN has mappings but no mappings to the given API\n            final_result += f\"\"\"Check (3/5): Check mapping exists to API Id: {api_id}.\n  Status: Mapping not found for {api_id}\n  Details: The custom domain '{domain_name}' is present but has no API mapping configuration for API ID: {api_id}.\n\n  Troubleshooting Recommendations:\n    - The custom domain name '{domain_name}' exists but is not mapped to API ID: {api_id}.\n    - Confirm that the API ID is correct and exists in your account.\n    - Check if the API is deployed to a stage.\n    - Create an API mapping between your custom domain name and API using the AWS Console or CLI.\n    - Please refer the below documentation to create API mappings for your custom domain:\n        > https://docs.aws.amazon.com/apigateway/latest/developerguide/rest-api-mappings.html\n\n\"\"\"\n        else:\n            successful_step_count += 1\n            # Extract base path and stage information for each mapping\n            mapping_details = []\n\n            for mapping in api_mappings:\n                base_path = \"/\" if mapping.get(\"ApiMappingKey\") == \"\" else mapping.get(\"ApiMappingKey\")\n                stage = mapping.get(\"Stage\")\n                mapping_details.append(f\"  - Base Path: {base_path}, Stage: {stage}\")\n\n            # Format the mapping details for output\n            mapping_details_str = \"\\n\".join(mapping_details)\n\n            final_result += f\"\"\"Check (3/5): Check mapping exists to API Id: {api_id}.\n  Status: Complete\n  Details: API mapping configuration found. Domain '{domain_name}' is successfully mapped to API ID: {api_id} with the following configurations:\n  {mapping_details_str}\n\n\"\"\"\n\n        # Step 4: Check DNS Record\n        if \"NoDnsRecord\" in dns_records:\n            final_result += f\"\"\"Check (4/5): Check DNS record exists for custom domain name.\n  Status: DNS record not found\n  Details: There is no DNS record for the custom domain name: {domain_name} or the domain could not be resolved.\n\n  Troubleshooting Recommendations:\n    - If using Route 53, create an A record with Alias targeting your API Gateway custom domain.\n    - Once configured, ensure the DNS record is resolvable, using tools like 'dig' or 'nslookup'.\n    - Kindly refer the below documentation for more information on configuring R53 DNS records for API Gateway:\n        > https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-to-api-gateway.html\n\n\"\"\"\n        else:\n            successful_step_count += 1\n            final_result += f\"\"\"Check (4/5): Check DNS record exists for custom domain name.\n  Status: Complete\n  Details: DNS record for '{domain_name}' exists and is resolvable.\n\n\"\"\"\n\n        # Step 5: Validate DNS\n        if validate_records == \"DNS record valid and configured correctly.\":\n            successful_step_count += 1\n            final_result += f\"\"\"Check (5/5): Validate DNS record.\n  Status: Complete\n  Details: DNS record for '{domain_name}' is correctly pointing to API Gateway domain '{api_gateway_domain_name}'.\n\n\"\"\"\n        else:\n            # when validate_records is \"DNS record not found or not configured correctly\":\n            final_result += f\"\"\"Check (5/5): Validate DNS record.\n  Status: DNS misconfigured\n  Details: DNS validation failed - {validate_records}\n\n  Troubleshooting Recommendations:\n    - Confirm that the DNS record for '{domain_name}' exists and is correctly configured.\n    - The API Gateway domain name generated for this custom domain name should be the target of the DNS record created for the custom domain name.\n    - Ensure your DNS record points to the correct API Gateway domain name. You can get the API Gateway domain name from the details of custom domain name created in API Gateway.\n    - Check for any typos in your DNS configuration.\n\n\"\"\"\n        # Summary section\n        if successful_step_count == 5:\n            final_result += f\"\"\"All checks passed! âœ“ Your custom domain name is properly configured and ready to use.\nSummary: The custom domain name '{domain_name}' is correctly configured with:\n  - API Gateway domain name: {api_gateway_domain_name}\n  - Status: {domain_status}\n  - Endpoint Type: {endpoint_type}\n  - Valid API mappings\n  - Correct DNS configuration\n\nYour API should be accessible through the custom domain name '{domain_name}'.\"\"\"\n        else:\n            final_result += f\"\"\"{successful_step_count} of 5 checks passed. Your custom domain name configuration needs attention.\nReview the details above and follow the recommendations to complete your setup.\n\nAdditional Resources:\n  - API Gateway Custom Domain Documentation: https://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-custom-domains.html\n  - Troubleshooting Custom Domains: https://aws.amazon.com/premiumsupport/knowledge-center/custom-domain-name-amazon-api-gateway/\n  - ACM Certificate Documentation: https://docs.aws.amazon.com/acm/latest/userguide/gs.html\n  - DNS Configuration Best Practices: https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-to-api-gateway.html\"\"\"\n\n        return final_result\n\n    except Exception as e:\n        raise RuntimeError(f\"An error occurred when returning the troubleshooting advice: {e}\") from None\n"
      },
      "outputs": [
        {
          "Name": "message",
          "Selector": "$.Payload",
          "Type": "String"
        }
      ],
      "isEnd": true,
      "onFailure": "Abort",
      "timeoutSeconds": 300,
      "maxAttempts": 3
    }
  ]
}
