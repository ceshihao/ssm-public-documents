{
  "description": "The **AWSSupport-TroubleshootManagedInstance** runbook helps troubleshoot why an Amazon Elastic Compute Cloud (Amazon EC2) instance does not report as managed by AWS Systems Manager. This runbook reviews the Amazon Virtual Private Cloud (Amazon VPC) configuration for the instance including security group rules, VPC endpoints, network access control list (ACL) rules, and route tables. It also checks that the AWS Identity and Access Management (IAM) instance profile associated with the instance contains the required permissions or the account has enabled [Default Host Management Configuration](https://docs.aws.amazon.com/systems-manager/latest/userguide/managed-instances-default-host-management.html).",
  "schemaVersion": "0.3",
  "outputs": [
    "GenerateReport.Report"
  ],
  "assumeRole": "{{ AutomationAssumeRole }}",
  "parameters": {
    "InstanceId": {
      "type": "AWS::EC2::Instance::Id",
      "description": "(Required) The ID of the Amazon EC2 instance.",
      "allowedPattern": "^i-[a-z0-9]{8,17}$"
    },
    "AutomationAssumeRole": {
      "type": "AWS::IAM::Role::Arn",
      "description": "(Optional) The Amazon Resource Name (ARN) of the AWS Identity and Access Management (IAM) role that allows Systems Manager Automation to perform the actions on your behalf. If no role is specified, Systems Manager Automation uses the permissions of the user that starts this runbook.",
      "default": ""
    }
  },
  "mainSteps": [
    {
      "name": "AssertInstanceExists",
      "description": "Verify that the Amazon Elastic Compute Cloud (Amazon EC2) instance exists in the account before proceeding with troubleshooting.",
      "action": "aws:assertAwsResourceProperty",
      "onFailure": "Abort",
      "timeoutSeconds": 180,
      "maxAttempts": 3,
      "nextStep": "GetInstanceStatus",
      "inputs": {
        "Service": "ec2",
        "Api": "DescribeInstances",
        "InstanceIds": [
          "{{ InstanceId }}"
        ],
        "PropertySelector": "$.Reservations[0].Instances[0].InstanceId",
        "DesiredValues": [
          "{{ InstanceId }}"
        ]
      }
    },
    {
      "name": "GetInstanceStatus",
      "description": "Check if the Amazon Elastic Compute Cloud (Amazon EC2) instance is currently managed by AWS Systems Manager and retrieve the AWS Systems Manager Agent (SSM Agent) version information.",
      "action": "aws:executeAwsApi",
      "onFailure": "Abort",
      "timeoutSeconds": 300,
      "maxAttempts": 3,
      "nextStep": "BranchOnInstanceStatus",
      "inputs": {
        "Service": "ssm",
        "Api": "DescribeInstanceInformation",
        "Filters": [
          {
            "Key": "InstanceIds",
            "Values": [
              "{{ InstanceId }}"
            ]
          }
        ]
      },
      "outputs": [
        {
          "Name": "InstanceStatus",
          "Selector": "$.InstanceInformationList[0].PingStatus",
          "Type": "String"
        },
        {
          "Name": "AgentVersion",
          "Selector": "$.InstanceInformationList[0].AgentVersion",
          "Type": "String"
        }
      ]
    },
    {
      "name": "BranchOnInstanceStatus",
      "description": "Branches based on whether the instance is already reporting as managed by AWS Systems Manager or not.",
      "action": "aws:branch",
      "onFailure": "Abort",
      "timeoutSeconds": 300,
      "maxAttempts": 3,
      "isCritical": true,
      "inputs": {
        "Choices": [
          {
            "NextStep": "AnalyzeVPCEndpointConnectivity",
            "Not": {
              "Variable": "{{ GetInstanceStatus.InstanceStatus }}",
              "StringEquals": "Online"
            }
          }
        ],
        "Default": "GenerateReport"
      },
      "isEnd": false
    },
    {
      "name": "AnalyzeVPCEndpointConnectivity",
      "description": "Analyze the connectivity of the Amazon Elastic Compute Cloud (Amazon EC2) instance to AWS Systems Manager (SSM) through Amazon Virtual Private Cloud (Amazon VPC) Endpoint if configured.",
      "action": "aws:executeScript",
      "maxAttempts": 3,
      "timeoutSeconds": 600,
      "nextStep": "AnalyzePublicEndpointConnectivity",
      "onFailure": "Abort",
      "inputs": {
        "InputPayload": {
          "InstanceId": "{{ InstanceId }}"
        },
        "Handler": "run_vpce_analysis.script_handler",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Result",
          "Selector": "$.Payload.result",
          "Type": "String"
        },
        {
          "Name": "VpcEndpointId",
          "Selector": "$.Payload.metadata.VpcEndpointId",
          "Type": "String"
        }
      ]
    },
    {
      "name": "AnalyzePublicEndpointConnectivity",
      "description": "Analyze the connectivity of the Amazon Elastic Compute Cloud (Amazon EC2) instance to AWS Systems Manager (SSM) service endpoint over public internet.",
      "action": "aws:executeScript",
      "maxAttempts": 3,
      "timeoutSeconds": 600,
      "nextStep": "AnalyzeIAMConfiguration",
      "onFailure": "Abort",
      "inputs": {
        "InputPayload": {
          "InstanceId": "{{ InstanceId }}"
        },
        "Handler": "run_public_analysis.script_handler",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Result",
          "Selector": "$.Payload.result",
          "Type": "String"
        }
      ]
    },
    {
      "name": "AnalyzeIAMConfiguration",
      "description": "Analyze the Amazon Elastic Compute Cloud (Amazon EC2) instance's AWS Identity and Access Management (IAM) permissions to check if it's allowed to register itself with AWS Systems Manager (SSM).",
      "action": "aws:executeScript",
      "maxAttempts": 3,
      "timeoutSeconds": 600,
      "nextStep": "GenerateReport",
      "onFailure": "Abort",
      "inputs": {
        "InputPayload": {
          "InstanceId": "{{ InstanceId }}"
        },
        "Handler": "run_iam_analysis.script_handler",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Result",
          "Selector": "$.Payload.result",
          "Type": "String"
        }
      ]
    },
    {
      "name": "GenerateReport",
      "description": "Generates a comprehensive report containing instance status, connectivity analysis, and IAM configuration findings.",
      "action": "aws:executeScript",
      "onFailure": "Abort",
      "timeoutSeconds": 600,
      "maxAttempts": 3,
      "isEnd": true,
      "inputs": {
        "InputPayload": {
          "InstanceId": "{{ InstanceId }}",
          "VpcEndpointId": "{{ AnalyzeVPCEndpointConnectivity.VpcEndpointId }}",
          "InstanceStatus": "{{ GetInstanceStatus.InstanceStatus }}",
          "AgentVersion": "{{ GetInstanceStatus.AgentVersion }}",
          "VpcEndpointAnalysisReport": "{{ AnalyzeVPCEndpointConnectivity.Result }}",
          "PublicEndpointAnalysisReport": "{{ AnalyzePublicEndpointConnectivity.Result }}",
          "IamAnalysisReport": "{{ AnalyzeIAMConfiguration.Result }}"
        },
        "Handler": "generate_report.script_handler",
        "Runtime": "python3.11",
        "Attachment": "artifact.zip"
      },
      "outputs": [
        {
          "Name": "Report",
          "Selector": "$.Payload",
          "Type": "String"
        }
      ]
    }
  ],
  "files": {
    "artifact.zip": {
      "checksums": {
        "SHA256": "6d58b16acfe3361ae7e006cfab145654420a641e1bbabb5ac35714f40027147d"
      }
    }
  }
}
