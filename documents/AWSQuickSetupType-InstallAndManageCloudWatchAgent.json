{
  "schemaVersion": "2.2",
  "description": "Install and configure CloudWatch agent based on parameters",
  "parameters": {
    "isInstall": {
      "type": "String",
      "description": "Whether to install the CloudWatch agent",
      "allowedValues": [
        "true",
        "false"
      ],
      "default": "false"
    },
    "isConfigure": {
      "type": "String",
      "description": "Whether to configure the CloudWatch agent",
      "allowedValues": [
        "true",
        "false"
      ],
      "default": "false"
    },
    "optionalConfigurationSource": {
      "type": "String",
      "description": "Configuration source for CloudWatch agent",
      "allowedValues": [
        "ssm",
        "default",
        "all"
      ],
      "default": "default"
    },
    "optionalConfigurationLocation": {
      "type": "String",
      "description": "Configuration location for CloudWatch agent",
      "allowedPattern": "^[a-zA-Z0-9-\"~:_@./^(*)!<>?=+,]*$",
      "default": ""
    }
  },
  "mainSteps": [
    {
      "action": "aws:runDocument",
      "name": "InstallCloudWatchAgent",
      "precondition": {
        "StringEquals": [
          "{{ isInstall }}",
          "true"
        ]
      },
      "inputs": {
        "documentType": "SSMDocument",
        "documentPath": "AWS-ConfigureAWSPackage",
        "documentParameters": {
          "action": "Install",
          "name": "AmazonCloudWatchAgent"
        }
      }
    },
    {
      "action": "aws:runDocument",
      "name": "ConfigureCloudWatchAgent",
      "precondition": {
        "StringEquals": [
          "{{ isConfigure }}",
          "true"
        ]
      },
      "inputs": {
        "documentType": "SSMDocument",
        "documentPath": "AmazonCloudWatch-ManageAgent",
        "documentParameters": {
          "action": "configure",
          "mode": "ec2",
          "optionalConfigurationSource": "{{ optionalConfigurationSource }}",
          "optionalConfigurationLocation": "{{ optionalConfigurationLocation }}"
        }
      }
    }
  ]
}
