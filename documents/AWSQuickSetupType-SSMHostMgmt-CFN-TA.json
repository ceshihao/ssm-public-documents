{
  "schemaVersion": "1.0",
  "templateBody": {
    "Metadata": {
      "Version": "3.1"
    },
    "Parameters": {
      "QSType": {
        "Type": "String",
        "AllowedValues": [
          "LA",
          "TA",
          "MA"
        ],
        "Default": "TA",
        "Description": "(Required) Specifies whether the Quick Setup applies to the local account or an AWS organization."
      },
      "QSConfigurationId": {
        "Type": "String",
        "Default": "",
        "Description": "(Required) Unique identifier of the deployed configuration."
      },
      "QSAttachConfigurationPolicy": {
        "Type": "String",
        "Default": "false",
        "AllowedValues": [
          "true",
          "false"
        ],
        "Description": "(Optional) Whether to attach Configuration permissions policy which sets boundaries of what configuration can do."
      },
      "QSGlobalResourcesRegion": {
        "Type": "String",
        "Default": "",
        "Description": "(Required) Name of the AWS Region to deploy global resources such as S3 buckets."
      },
      "QSPrincipalOrgId": {
        "Type": "String",
        "Default": "",
        "Description": "(Optional) The ID of the principal organization your management account operates in."
      },
      "UpdateSsmAgent": {
        "Type": "String",
        "Default": "true",
        "AllowedValues": [
          "true",
          "false"
        ],
        "Description": "(Optional) Determines whether the SSM agent updates every 2 weeks."
      },
      "UpdateEc2LaunchAgent": {
        "Type": "String",
        "Default": "false",
        "AllowedValues": [
          "true",
          "false"
        ],
        "Description": "(Optional) Determines whether the EC2Launch agent updates monthly."
      },
      "CollectInventory": {
        "Type": "String",
        "Default": "true",
        "AllowedValues": [
          "true",
          "false"
        ],
        "Description": "(Optional) Determines whether inventory is collected every 30 minutes."
      },
      "ScanInstances": {
        "Type": "String",
        "Default": "true",
        "AllowedValues": [
          "true",
          "false"
        ],
        "Description": "(Optional) Determines whether instances are scanned for patches daily."
      },
      "InstallCloudWatchAgent": {
        "Type": "String",
        "Default": "false",
        "AllowedValues": [
          "true",
          "false"
        ],
        "Description": "(Optional) Whether the CloudWatch agent should be installed."
      },
      "UpdateCloudWatchAgent": {
        "Type": "String",
        "Default": "false",
        "AllowedValues": [
          "true",
          "false"
        ],
        "Description": "(Optional) Determines whether the CloudWatch agent updates monthly."
      },
      "IsPolicyAttachAllowed": {
        "Type": "String",
        "Default": "false",
        "AllowedValues": [
          "true",
          "false"
        ],
        "Description": "(Optional) Whether you want to allow Quick Setup to attach IAM policies to existing instance profiles."
      },
      "TargetType": {
        "Type": "String",
        "Default": "*",
        "AllowedValues": [
          "Tags",
          "InstanceIds",
          "*",
          "ResourceGroups"
        ],
        "Description": "(Optional) Specifies the way instances are targeted. This parameter is only used for the local Quick Setup type."
      },
      "TargetInstances": {
        "Type": "String",
        "Default": "*",
        "Description": "(Optional) Specifies the target instances. This parameter is only used for the local Quick Setup type when InstanceIds are the TargetType."
      },
      "TargetTagKey": {
        "Type": "String",
        "Default": "",
        "Description": "(Optional) Specifies the tag key used to target instances. This parameter is only used for the local Quick Setup type when Tags are the TargetType."
      },
      "TargetTagValue": {
        "Type": "String",
        "Default": "",
        "Description": "(Optional) Specifies the tag value used to target instances. This parameter is only used for the local Quick Setup type when Tags are the TargetType."
      },
      "ResourceGroupName": {
        "Type": "String",
        "Default": "",
        "Description": "(Optional) Specifies the tag value for the resource group used to target instances. This parameter is only used for the local Quick Setup type when ResourceGroups are the TargetType."
      }
    },
    "Conditions": {
      "CreateUpdateSsmAgentAssociation": {
        "Fn::Equals": [
          {
            "Ref": "UpdateSsmAgent"
          },
          "true"
        ]
      },
      "CreateUpdateEc2LaunchAgentAssociation": {
        "Fn::Equals": [
          {
            "Ref": "UpdateEc2LaunchAgent"
          },
          "true"
        ]
      },
      "CreateCollectInventoryAssociation": {
        "Fn::Equals": [
          {
            "Ref": "CollectInventory"
          },
          "true"
        ]
      },
      "CreateScanInstancesAssociation": {
        "Fn::Equals": [
          {
            "Ref": "ScanInstances"
          },
          "true"
        ]
      },
      "CreateInstallAndManageCloudWatchAgentAssociation": {
        "Fn::Equals": [
          {
            "Ref": "InstallCloudWatchAgent"
          },
          "true"
        ]
      },
      "UpdateCloudWatchAgentAssociation": {
        "Fn::Equals": [
          {
            "Ref": "UpdateCloudWatchAgent"
          },
          "true"
        ]
      },
      "ShouldUpdateCloudWatchAgent": {
        "Fn::Equals": [
          {
            "Ref": "UpdateCloudWatchAgent"
          },
          "true"
        ]
      },
      "IsTagValueNotSpecified": {
        "Fn::Equals": [
          {
            "Ref": "TargetTagValue"
          },
          ""
        ]
      },
      "IsTagKeyAndValueTargeted": {
        "Fn::And": [
          {
            "Fn::Equals": [
              {
                "Ref": "QSType"
              },
              "LA"
            ]
          },
          {
            "Fn::Equals": [
              {
                "Ref": "TargetType"
              },
              "Tags"
            ]
          },
          {
            "Fn::Not": [
              {
                "Condition": "IsTagValueNotSpecified"
              }
            ]
          }
        ]
      },
      "IsTagKeyOnlyTargeted": {
        "Fn::And": [
          {
            "Fn::Equals": [
              {
                "Ref": "QSType"
              },
              "LA"
            ]
          },
          {
            "Fn::Equals": [
              {
                "Ref": "TargetType"
              },
              "Tags"
            ]
          },
          {
            "Condition": "IsTagValueNotSpecified"
          }
        ]
      },
      "IsResourceGroupTargeted": {
        "Fn::And": [
          {
            "Fn::Equals": [
              {
                "Ref": "QSType"
              },
              "LA"
            ]
          },
          {
            "Fn::Equals": [
              {
                "Ref": "TargetType"
              },
              "ResourceGroups"
            ]
          }
        ]
      },
      "IsOrgQuickSetup": {
        "Fn::Equals": [
          {
            "Ref": "QSType"
          },
          "TA"
        ]
      },
      "TargetAllAutomation": {
        "Fn::Equals": [
          {
            "Ref": "TargetInstances"
          },
          "*"
        ]
      },
      "TargetAll": {
        "Fn::Equals": [
          {
            "Ref": "TargetInstances"
          },
          "*"
        ]
      },
      "PolicyAttachAllowed": {
        "Fn::Equals": [
          {
            "Ref": "IsPolicyAttachAllowed"
          },
          "true"
        ]
      }
    },
    "Resources": {
      "RoleForAutomationV2": {
        "Type": "AWS::IAM::Role",
        "Properties": {
          "AssumeRolePolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": [
                    "ssm.amazonaws.com"
                  ]
                },
                "Action": [
                  "sts:AssumeRole"
                ]
              }
            ]
          },
          "ManagedPolicyArns": [
            {
              "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/AWSSystemsManagerEnableExplorerExecutionPolicy"
            },
            {
              "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/AWSQuickSetupManagedInstanceProfileExecutionPolicy"
            }
          ],
          "RoleName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-HostMgmtRole-V2-",
                {
                  "Ref": "AWS::Region"
                },
                "-",
                {
                  "Ref": "QSType"
                }
              ]
            ]
          }
        }
      },
      "SystemAssociationForManagingInstances": {
        "Type": "AWS::SSM::Association",
        "Properties": {
          "Name": "AWSQuickSetupType-ManageInstanceProfile",
          "AssociationName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-SSMHostMgmt-AttachIAMToInstance-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          },
          "Parameters": {
            "AutomationAssumeRole": [
              {
                "Fn::GetAtt": [
                  "RoleForAutomationV2",
                  "Arn"
                ]
              }
            ],
            "UpdateExistingProfiles": [
              {
                "Ref": "IsPolicyAttachAllowed"
              }
            ],
            "ManagedPoliciesToAttach": [
              {
                "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/AmazonSSMManagedInstanceCore"
              },
              {
                "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/AmazonSSMPatchAssociation"
              }
            ]
          },
          "AutomationTargetParameterName": "InstanceId",
          "Targets": {
            "Fn::If": [
              "IsOrgQuickSetup",
              [
                {
                  "Key": "InstanceIds",
                  "Values": [
                    "*"
                  ]
                }
              ],
              {
                "Fn::If": [
                  "IsTagKeyAndValueTargeted",
                  [
                    {
                      "Key": {
                        "Fn::Join": [
                          "",
                          [
                            "tag:",
                            {
                              "Ref": "TargetTagKey"
                            }
                          ]
                        ]
                      },
                      "Values": [
                        {
                          "Ref": "TargetTagValue"
                        }
                      ]
                    }
                  ],
                  {
                    "Fn::If": [
                      "IsTagKeyOnlyTargeted",
                      [
                        {
                          "Key": "tag-key",
                          "Values": [
                            {
                              "Ref": "TargetTagKey"
                            }
                          ]
                        }
                      ],
                      {
                        "Fn::If": [
                          "IsResourceGroupTargeted",
                          [
                            {
                              "Key": "ResourceGroup",
                              "Values": [
                                {
                                  "Ref": "ResourceGroupName"
                                }
                              ]
                            }
                          ],
                          {
                            "Fn::If": [
                              "TargetAll",
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": [
                                    "*"
                                  ]
                                }
                              ],
                              [
                                {
                                  "Key": "ParameterValues",
                                  "Values": {
                                    "Fn::Split": [
                                      ",",
                                      {
                                        "Ref": "TargetInstances"
                                      }
                                    ]
                                  }
                                }
                              ]
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          "ScheduleExpression": "rate(30 days)"
        }
      },
      "SystemAssociationForEnablingExplorer": {
        "Type": "AWS::SSM::Association",
        "Properties": {
          "Name": "AWS-EnableExplorer",
          "AssociationName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-SSMHostMgmt-EnableExplorer-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          },
          "Parameters": {
            "AutomationAssumeRole": [
              {
                "Fn::GetAtt": [
                  "RoleForAutomationV2",
                  "Arn"
                ]
              }
            ]
          }
        }
      },
      "SystemAssociationForSsmAgentUpdate": {
        "Type": "AWS::SSM::Association",
        "Properties": {
          "Name": "AWS-UpdateSSMAgent",
          "AssociationName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-SSMHostMgmt-UpdateSSMAgent-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          },
          "ScheduleExpression": "rate(14 days)",
          "Targets": {
            "Fn::If": [
              "IsOrgQuickSetup",
              [
                {
                  "Key": "InstanceIds",
                  "Values": [
                    "*"
                  ]
                }
              ],
              {
                "Fn::If": [
                  "IsTagKeyAndValueTargeted",
                  [
                    {
                      "Key": {
                        "Fn::Join": [
                          "",
                          [
                            "tag:",
                            {
                              "Ref": "TargetTagKey"
                            }
                          ]
                        ]
                      },
                      "Values": [
                        {
                          "Ref": "TargetTagValue"
                        }
                      ]
                    }
                  ],
                  {
                    "Fn::If": [
                      "IsTagKeyOnlyTargeted",
                      [
                        {
                          "Key": "tag-key",
                          "Values": [
                            {
                              "Ref": "TargetTagKey"
                            }
                          ]
                        }
                      ],
                      {
                        "Fn::If": [
                          "IsResourceGroupTargeted",
                          [
                            {
                              "Key": "resource-groups:Name",
                              "Values": [
                                {
                                  "Ref": "ResourceGroupName"
                                }
                              ]
                            }
                          ],
                          {
                            "Fn::If": [
                              "TargetAll",
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": [
                                    "*"
                                  ]
                                }
                              ],
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": {
                                    "Fn::Split": [
                                      ",",
                                      {
                                        "Ref": "TargetInstances"
                                      }
                                    ]
                                  }
                                }
                              ]
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        "Condition": "CreateUpdateSsmAgentAssociation",
        "DependsOn": "SystemAssociationForManagingInstances"
      },
      "SystemAssociationForEc2LaunchAgentUpdate": {
        "Type": "AWS::SSM::Association",
        "Properties": {
          "Name": "AWSEC2-UpdateLaunchAgent",
          "AssociationName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-SSMHostMgmt-UpdateEC2LaunchAgent-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          },
          "ScheduleExpression": "rate(30 days)",
          "Targets": {
            "Fn::If": [
              "IsOrgQuickSetup",
              [
                {
                  "Key": "InstanceIds",
                  "Values": [
                    "*"
                  ]
                }
              ],
              {
                "Fn::If": [
                  "IsTagKeyAndValueTargeted",
                  [
                    {
                      "Key": {
                        "Fn::Join": [
                          "",
                          [
                            "tag:",
                            {
                              "Ref": "TargetTagKey"
                            }
                          ]
                        ]
                      },
                      "Values": [
                        {
                          "Ref": "TargetTagValue"
                        }
                      ]
                    }
                  ],
                  {
                    "Fn::If": [
                      "IsTagKeyOnlyTargeted",
                      [
                        {
                          "Key": "tag-key",
                          "Values": [
                            {
                              "Ref": "TargetTagKey"
                            }
                          ]
                        }
                      ],
                      {
                        "Fn::If": [
                          "IsResourceGroupTargeted",
                          [
                            {
                              "Key": "resource-groups:Name",
                              "Values": [
                                {
                                  "Ref": "ResourceGroupName"
                                }
                              ]
                            }
                          ],
                          {
                            "Fn::If": [
                              "TargetAll",
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": [
                                    "*"
                                  ]
                                }
                              ],
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": {
                                    "Fn::Split": [
                                      ",",
                                      {
                                        "Ref": "TargetInstances"
                                      }
                                    ]
                                  }
                                }
                              ]
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        "Condition": "CreateUpdateEc2LaunchAgentAssociation",
        "DependsOn": "SystemAssociationForManagingInstances"
      },
      "SystemAssociationForInventoryCollection": {
        "Type": "AWS::SSM::Association",
        "Properties": {
          "Name": "AWS-GatherSoftwareInventory",
          "AssociationName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-SSMHostMgmt-CollectInventory-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          },
          "Parameters": {
            "applications": [
              "Enabled"
            ],
            "awsComponents": [
              "Enabled"
            ],
            "networkConfig": [
              "Enabled"
            ],
            "instanceDetailedInformation": [
              "Enabled"
            ],
            "windowsUpdates": [
              "Enabled"
            ],
            "services": [
              "Enabled"
            ],
            "windowsRoles": [
              "Enabled"
            ],
            "customInventory": [
              "Enabled"
            ]
          },
          "ScheduleExpression": "rate(30 minutes)",
          "Targets": {
            "Fn::If": [
              "IsOrgQuickSetup",
              [
                {
                  "Key": "InstanceIds",
                  "Values": [
                    "*"
                  ]
                }
              ],
              {
                "Fn::If": [
                  "IsTagKeyAndValueTargeted",
                  [
                    {
                      "Key": {
                        "Fn::Join": [
                          "",
                          [
                            "tag:",
                            {
                              "Ref": "TargetTagKey"
                            }
                          ]
                        ]
                      },
                      "Values": [
                        {
                          "Ref": "TargetTagValue"
                        }
                      ]
                    }
                  ],
                  {
                    "Fn::If": [
                      "IsTagKeyOnlyTargeted",
                      [
                        {
                          "Key": "tag-key",
                          "Values": [
                            {
                              "Ref": "TargetTagKey"
                            }
                          ]
                        }
                      ],
                      {
                        "Fn::If": [
                          "IsResourceGroupTargeted",
                          [
                            {
                              "Key": "resource-groups:Name",
                              "Values": [
                                {
                                  "Ref": "ResourceGroupName"
                                }
                              ]
                            }
                          ],
                          {
                            "Fn::If": [
                              "TargetAll",
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": [
                                    "*"
                                  ]
                                }
                              ],
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": {
                                    "Fn::Split": [
                                      ",",
                                      {
                                        "Ref": "TargetInstances"
                                      }
                                    ]
                                  }
                                }
                              ]
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        "Condition": "CreateCollectInventoryAssociation",
        "DependsOn": "SystemAssociationForManagingInstances"
      },
      "SystemAssociationForScanningPatches": {
        "Type": "AWS::SSM::Association",
        "Properties": {
          "Name": "AWS-RunPatchBaselineAssociation",
          "AssociationName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-SSMHostMgmt-ScanForPatches-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          },
          "Parameters": {
            "Operation": [
              "Scan"
            ]
          },
          "ScheduleExpression": "rate(1 day)",
          "SyncCompliance": "MANUAL",
          "Targets": {
            "Fn::If": [
              "IsOrgQuickSetup",
              [
                {
                  "Key": "InstanceIds",
                  "Values": [
                    "*"
                  ]
                }
              ],
              {
                "Fn::If": [
                  "IsTagKeyAndValueTargeted",
                  [
                    {
                      "Key": {
                        "Fn::Join": [
                          "",
                          [
                            "tag:",
                            {
                              "Ref": "TargetTagKey"
                            }
                          ]
                        ]
                      },
                      "Values": [
                        {
                          "Ref": "TargetTagValue"
                        }
                      ]
                    }
                  ],
                  {
                    "Fn::If": [
                      "IsTagKeyOnlyTargeted",
                      [
                        {
                          "Key": "tag-key",
                          "Values": [
                            {
                              "Ref": "TargetTagKey"
                            }
                          ]
                        }
                      ],
                      {
                        "Fn::If": [
                          "IsResourceGroupTargeted",
                          [
                            {
                              "Key": "resource-groups:Name",
                              "Values": [
                                {
                                  "Ref": "ResourceGroupName"
                                }
                              ]
                            }
                          ],
                          {
                            "Fn::If": [
                              "TargetAll",
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": [
                                    "*"
                                  ]
                                }
                              ],
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": {
                                    "Fn::Split": [
                                      ",",
                                      {
                                        "Ref": "TargetInstances"
                                      }
                                    ]
                                  }
                                }
                              ]
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        "Condition": "CreateScanInstancesAssociation",
        "DependsOn": "SystemAssociationForManagingInstances"
      },
      "InstallAndManageCloudWatchDocument": {
        "Type": "AWS::SSM::Document",
        "Properties": {
          "UpdateMethod": "NewVersion",
          "Content": {
            "schemaVersion": "2.2",
            "description": "The AWS-InstallAndManageCloudWatch command document installs the Amazon CloudWatch agent and manages the configuration of the agent for Amazon EC2 instances.",
            "mainSteps": [
              {
                "action": "aws:runDocument",
                "name": "installCWAgent",
                "inputs": {
                  "documentType": "SSMDocument",
                  "documentPath": "AWS-ConfigureAWSPackage",
                  "documentParameters": {
                    "action": "Install",
                    "name": "AmazonCloudWatchAgent"
                  }
                }
              },
              {
                "action": "aws:runDocument",
                "name": "manageCWAgent",
                "inputs": {
                  "documentType": "SSMDocument",
                  "documentPath": "AmazonCloudWatch-ManageAgent",
                  "documentParameters": {
                    "action": "configure",
                    "mode": "ec2",
                    "optionalConfigurationSource": "default",
                    "optionalRestart": "yes"
                  }
                }
              }
            ]
          },
          "DocumentType": "Command",
          "Name": {
            "Fn::Join": [
              "",
              [
                "AWSQuickSetup-InstallAndManageCloudWatchDocument-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          }
        },
        "Condition": "CreateInstallAndManageCloudWatchAgentAssociation",
        "DependsOn": "SystemAssociationForManagingInstances"
      },
      "SystemAssociationForInstallAndConfigureCloudWatchAgent": {
        "Type": "AWS::SSM::Association",
        "Properties": {
          "Name": {
            "Ref": "InstallAndManageCloudWatchDocument"
          },
          "AssociationName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-SSMHostMgmt-ManageCloudWatchAgent-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          },
          "ScheduleExpression": {
            "Ref": "AWS::NoValue"
          },
          "Targets": {
            "Fn::If": [
              "IsOrgQuickSetup",
              [
                {
                  "Key": "InstanceIds",
                  "Values": [
                    "*"
                  ]
                }
              ],
              {
                "Fn::If": [
                  "IsTagKeyAndValueTargeted",
                  [
                    {
                      "Key": {
                        "Fn::Join": [
                          "",
                          [
                            "tag:",
                            {
                              "Ref": "TargetTagKey"
                            }
                          ]
                        ]
                      },
                      "Values": [
                        {
                          "Ref": "TargetTagValue"
                        }
                      ]
                    }
                  ],
                  {
                    "Fn::If": [
                      "IsTagKeyOnlyTargeted",
                      [
                        {
                          "Key": "tag-key",
                          "Values": [
                            {
                              "Ref": "TargetTagKey"
                            }
                          ]
                        }
                      ],
                      {
                        "Fn::If": [
                          "IsResourceGroupTargeted",
                          [
                            {
                              "Key": "resource-groups:Name",
                              "Values": [
                                {
                                  "Ref": "ResourceGroupName"
                                }
                              ]
                            }
                          ],
                          {
                            "Fn::If": [
                              "TargetAll",
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": [
                                    "*"
                                  ]
                                }
                              ],
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": {
                                    "Fn::Split": [
                                      ",",
                                      {
                                        "Ref": "TargetInstances"
                                      }
                                    ]
                                  }
                                }
                              ]
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        "Condition": "CreateInstallAndManageCloudWatchAgentAssociation",
        "DependsOn": "SystemAssociationForManagingInstances"
      },
      "UpdateCloudWatchAgentDocument": {
        "Type": "AWS::SSM::Document",
        "Properties": {
          "UpdateMethod": "NewVersion",
          "Content": {
            "schemaVersion": "2.2",
            "description": "A composite document for updating CloudWatch agent.",
            "mainSteps": [
              {
                "precondition": {
                  "StringEquals": [
                    "platformType",
                    "Linux"
                  ]
                },
                "action": "aws:runShellScript",
                "name": "first",
                "inputs": {
                  "runCommand": [
                    "sleep 1800"
                  ]
                }
              },
              {
                "precondition": {
                  "StringEquals": [
                    "platformType",
                    "Windows"
                  ]
                },
                "action": "aws:runPowerShellScript",
                "name": "second",
                "inputs": {
                  "runCommand": [
                    "Start-Sleep -Seconds 1800"
                  ]
                }
              },
              {
                "action": "aws:runDocument",
                "name": "installCWAgent",
                "inputs": {
                  "documentType": "SSMDocument",
                  "documentPath": "AWS-ConfigureAWSPackage",
                  "documentParameters": "{\"action\":\"Install\",\"name\" : \"AmazonCloudWatchAgent\"}"
                }
              }
            ]
          },
          "DocumentType": "Command",
          "Name": {
            "Fn::Join": [
              "",
              [
                "AWSQuickSetup-SSMHostMgmt-UpdateCloudWatchDocument-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          }
        },
        "Condition": "UpdateCloudWatchAgentAssociation",
        "DependsOn": "SystemAssociationForManagingInstances"
      },
      "SystemAssociationForUpdateCloudWatchAgent": {
        "Type": "AWS::SSM::Association",
        "Properties": {
          "Name": {
            "Ref": "UpdateCloudWatchAgentDocument"
          },
          "AssociationName": {
            "Fn::Join": [
              "",
              [
                "AWS-QuickSetup-SSMHostMgmt-UpdateCloudWatchAgent-",
                {
                  "Ref": "QSConfigurationId"
                }
              ]
            ]
          },
          "ScheduleExpression": "rate(30 days)",
          "Targets": {
            "Fn::If": [
              "IsOrgQuickSetup",
              [
                {
                  "Key": "InstanceIds",
                  "Values": [
                    "*"
                  ]
                }
              ],
              {
                "Fn::If": [
                  "IsTagKeyAndValueTargeted",
                  [
                    {
                      "Key": {
                        "Fn::Join": [
                          "",
                          [
                            "tag:",
                            {
                              "Ref": "TargetTagKey"
                            }
                          ]
                        ]
                      },
                      "Values": [
                        {
                          "Ref": "TargetTagValue"
                        }
                      ]
                    }
                  ],
                  {
                    "Fn::If": [
                      "IsTagKeyOnlyTargeted",
                      [
                        {
                          "Key": "tag-key",
                          "Values": [
                            {
                              "Ref": "TargetTagKey"
                            }
                          ]
                        }
                      ],
                      {
                        "Fn::If": [
                          "IsResourceGroupTargeted",
                          [
                            {
                              "Key": "resource-groups:Name",
                              "Values": [
                                {
                                  "Ref": "ResourceGroupName"
                                }
                              ]
                            }
                          ],
                          {
                            "Fn::If": [
                              "TargetAll",
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": [
                                    "*"
                                  ]
                                }
                              ],
                              [
                                {
                                  "Key": "InstanceIds",
                                  "Values": {
                                    "Fn::Split": [
                                      ",",
                                      {
                                        "Ref": "TargetInstances"
                                      }
                                    ]
                                  }
                                }
                              ]
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        "Condition": "UpdateCloudWatchAgentAssociation",
        "DependsOn": "SystemAssociationForManagingInstances"
      }
    }
  }
}
