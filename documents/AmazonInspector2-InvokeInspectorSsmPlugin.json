{
  "schemaVersion": "2.2",
  "description": "Invokes Inspector OVAL Evaluator on OVAL Definitions instance",
  "parameters": {
    "Bucket": {
      "type": "String",
      "description": "Name of a S3 bucket with test OVAL documents",
      "default": "inspector2-oval-prod-us-east-1"
    }
  },
  "mainSteps": [
    {
      "action": "aws:runPowerShellScript",
      "name": "invokeOVALEvaluatorWindows",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Windows"
        ]
      },
      "inputs": {
        "runCommand": [
          "function error($msg) {Write-Host \"$(Get-Date -Format o): [ERROR] $msg\" -ForegroundColor Red}",
          "function warn($msg) {Write-Host \"$(Get-Date -Format o): [WARN] $msg\" -ForegroundColor DarkYellow}",
          "function info($msg) {Write-Host \"$(Get-Date -Format o): [INFO] $msg\"}",
          "info \"Evaluate OVAL files on windows platform\"",
          "",
          "$INSPECTOR_SSM_PLUGIN_EXE = 'C:\\Program Files\\Amazon\\Inspector\\inspectorssmplugin.exe'",
          "$OVAL_FILES = 'C:\\ProgramData\\Amazon\\Inspector\\Input'",
          "$INSPECTOR_SSM_PLUGIN_OUTPUT = 'C:\\ProgramData\\Amazon\\Inspector\\Output'",
          "$OUTPUT_FILE_NAME = \"results.json\"",
          "",
          "function Retry-Command {",
          "    [CmdletBinding()]",
          "    Param(",
          "        [Parameter(Position=0, Mandatory=$true)]",
          "        [scriptblock]$ScriptBlock,",
          "",
          "        [Parameter(Position=1, Mandatory=$true)]",
          "        [string]$ErrorMessage,",
          "",
          "        [Parameter(Position=2, Mandatory=$false)]",
          "        [int]$Maximum = 3,",
          "",
          "        [Parameter(Position=3, Mandatory=$false)]",
          "        [int]$Delay = 1",
          "    )",
          "",
          "    Begin {",
          "        $count = 0",
          "    }",
          "",
          "    Process {",
          "        do {",
          "            $count++",
          "            try {",
          "                Invoke-Command -Command $ScriptBlock",
          "                return",
          "            } catch {",
          "                error $_.Exception.InnerException.Message -ErrorAction Continue",
          "                info \"Waiting for $Delay second(s) before retrying...\"",
          "                Start-Sleep -Seconds $Delay",
          "            }",
          "        } while ($count -lt $Maximum)",
          "",
          "        error \"$ErrorMessage\"",
          "        Exit 1",
          "    }",
          "}",
          "",
          "try {",
          "    Retry-Command -ScriptBlock {",
          "        info \"Checking for installed binary...\"",
          "        if (-not(Test-Path -Path $INSPECTOR_SSM_PLUGIN_EXE -PathType Leaf)) {",
          "            throw \"$INSPECTOR_SSM_PLUGIN_EXE does not exist\"",
          "        }",
          "    } -Delay 60 -Maximum 5 -ErrorMessage \"Inspector ssm plugin binary is not installed, exiting...\"",
          "",
          "    $bucket = \"{{Bucket}}\"",
          "    info \"Provided bucket: $bucket\"",
          "    $region = \"us-east-1\"",
          "    info \"Provided region: $region\"",
          "    if (Test-Path -Path $OVAL_FILES) {",
          "        info \"Oval files directory already exists: $OVAL_FILES\"",
          "    } else {",
          "        info \"Creating directory for oval files: $OVAL_FILES\"",
          "        New-Item $OVAL_FILES -itemType Directory",
          "    }",
          "    if ($region -like 'cn-*') {",
          "        $ovalFilesS3Url = \"https://$bucket.s3.$region.amazonaws.com.cn\"",
          "    } else {",
          "        $ovalFilesS3Url = \"https://$bucket.s3.$region.amazonaws.com\"",
          "    }",
          "    $outputfile = \"$INSPECTOR_SSM_PLUGIN_OUTPUT\\$OUTPUT_FILE_NAME\"",
          "    info \"Starting evaluation of oval files...\"",
          "    $proc = Start-Process -FilePath $INSPECTOR_SSM_PLUGIN_EXE -PassThru -Wait -ArgumentList \"-server-url-oval-definitions \"\"$ovalFilesS3Url\"\" -path-eval-results \"\"$outputfile\"\" -report-ssm-inventory -concurrency 1\"",
          "    if ($proc.ExitCode -ne 0) {",
          "        warn \"inspectorssmplugin.exe exited with status code $($proc.ExitCode) while evaluating $($f.FullName)\"",
          "        Exit 1",
          "    } else {",
          "        info \"Completed processing of OVAL definitions document\"",
          "        Get-Content \"$outputfile\"",
          "        Exit 0",
          "    }",
          "} catch {",
          "    error $_",
          "    error \"Unknown error\"",
          "    Exit 1",
          "}"
        ]
      }
    }
  ]
}
